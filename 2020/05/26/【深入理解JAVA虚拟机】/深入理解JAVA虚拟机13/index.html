<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
<script data-ad-client="ca-pub-3892229323208960" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script data-ad-client="ca-pub-8318014576592877" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<script>
	(function(){
		if(''){
			if (prompt('请输入文章密码','') !== ''){
				alert('密码错误！');
				history.back();
			}
		}
	})();
</script>









<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #A0A0A0; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #A0A0A0, 0 0 5px     #A0A0A0; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #A0A0A0;    /*上边框颜色*/
        border-left-color: #A0A0A0;    /*左边框颜色*/
    }
</style>

<meta name="theme-color" content="#222">










<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
    
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/fsn-16x16.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/fsn-32x32.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/fsn-16x16.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/fsn-16x16.ico?v=5.1.4" color="#222">





  <meta name="keywords" content="面试,虚拟机," />





  <link rel="alternate" href="/atom.xml" title="✨Fsn✨" type="application/atom+xml" />






<meta name="description" content="深入java虚拟机-第五部分-高效并发第13章 线程安全与锁优化并发处理 的 广泛应用 是使得 Amdah1定律 代替 摩尔定律 成为 计算机性能发展源动力 的根本原因，也是人类 “压榨” 计算机运算能力 的 最有力武器。 概述在 软件业发展 的 初期，程序编写 都是以 算法 为核心的，程序员会把 数据 和 过程 分别作为 独立的部分 来考虑，数据 代表 问题空间 中的 客体，程序代码 则用于 处">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解java虚拟机-线程安全与锁优化">
<meta property="og:url" content="https://fengshana.github.io/2020/05/26/%E3%80%90%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JAVA%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%91/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JAVA%E8%99%9A%E6%8B%9F%E6%9C%BA13/index.html">
<meta property="og:site_name" content="✨Fsn✨">
<meta property="og:description" content="深入java虚拟机-第五部分-高效并发第13章 线程安全与锁优化并发处理 的 广泛应用 是使得 Amdah1定律 代替 摩尔定律 成为 计算机性能发展源动力 的根本原因，也是人类 “压榨” 计算机运算能力 的 最有力武器。 概述在 软件业发展 的 初期，程序编写 都是以 算法 为核心的，程序员会把 数据 和 过程 分别作为 独立的部分 来考虑，数据 代表 问题空间 中的 客体，程序代码 则用于 处">
<meta property="og:image" content="http://r.photo.store.qq.com/psc?/V13IdniL4CDhqM/TCfiP1YaPeRT4Jil9RANX5cJ*1aQOmt2pvBJcyIUBYjo6zX.1Ohy5JABE2Jl1QoYYaGey.wh1Sxp4od.aXADq8X6GO1fm1.7GXSuxVxc7Ig!/r">
<meta property="article:published_time" content="2020-05-26T14:41:37.497Z">
<meta property="article:modified_time" content="2020-06-05T18:26:39.099Z">
<meta property="article:author" content="✨🧙‍♀️✨">
<meta property="article:tag" content="面试">
<meta property="article:tag" content="虚拟机">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://r.photo.store.qq.com/psc?/V13IdniL4CDhqM/TCfiP1YaPeRT4Jil9RANX5cJ*1aQOmt2pvBJcyIUBYjo6zX.1Ohy5JABE2Jl1QoYYaGey.wh1Sxp4od.aXADq8X6GO1fm1.7GXSuxVxc7Ig!/r">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://fengshana.github.io/2020/05/26/【深入理解JAVA虚拟机】/深入理解JAVA虚拟机13/"/>









  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "07d52b28"
    });
  daovoice('update');
  </script>

  <title>深入理解java虚拟机-线程安全与锁优化 | ✨Fsn✨</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2a839053bb6194637483460a0f428730";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  
  <!-- Google AdSense start -->
  <script data-ad-client="ca-pub-3892229323208960" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- Google AdSense end -->

<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.js"></script>
<script src="https://unpkg.com/minigrid@3.1.1/dist/minigrid.min.js"></script>
<link rel="stylesheet" href="/photos/photos.css">
<script type="text/javascript" src="/photos/photo.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/mermaid/0.2.4/mermaid.full.min.js"></script>


<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">✨Fsn✨</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sentence">
          <a href="/shuoshuo" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-commenting"></i> <br />
            
            小心情
          </a>
        </li>
      

      
    </ul>
  

  
</nav>


<!-- Fsn -->
<script type="text/javascript">
WIDGET = {FID: 'o6km9Rzhmn'}
</script>
<script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>




 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="poem-wrap">
  <div class="poem-border poem-left"></div>
  <div class="poem-border poem-right"></div>
    <h1>[🌿诗酒年华🌻]</h1>
    <p id="poem">挑选中🌺...🍃🍂</p>
    <p id="info">

  <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
  <script type="text/javascript">
    jinrishici.load(function(result) {
      poem.innerHTML = result.data.content
      info.innerHTML = '【' + result.data.origin.dynasty + '】' + result.data.origin.author + '🍃《' + result.data.origin.title + '》🍂'
      document.getElementById("poem").value(poem);
      document.getElementById("info").value(info);  
  });
  </script>
</div>

        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fengshana.github.io/2020/05/26/%E3%80%90%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JAVA%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%91/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JAVA%E8%99%9A%E6%8B%9F%E6%9C%BA13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="✨🧙‍♀️✨">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/fsn.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="✨Fsn✨">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">深入理解java虚拟机-线程安全与锁优化</h1>
        

        <div class="post-meta">
		

          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text"></span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-26T22:41:37+08:00">
                2020-05-26
              </time>
            

            
              
            

            
              <span class="post-meta-item-icon">
                
              </span>
              
                <span class="post-meta-item-text"></span>
              
              <time title="更新于" itemprop="dateModified" datetime="2020-06-06T02:26:39+08:00">
                
              </time>
            
          </span>

          
            <span class="post-category" >
            
              
              
              
                <span class="post-meta-item-text"></span>
              
              
                

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      
        <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
          
          
            <div class="post-gallery-row">
              <a class="post-gallery-img fancybox"
                 href="http://r.photo.store.qq.com/psc?/V13IdniL4CDhqM/TCfiP1YaPeRT4Jil9RANX5cJ*1aQOmt2pvBJcyIUBYjo6zX.1Ohy5JABE2Jl1QoYYaGey.wh1Sxp4od.aXADq8X6GO1fm1.7GXSuxVxc7Ig!/r" rel="gallery_ckcgavpyz00fptcum8l81514z"
                 itemscope itemtype="http://schema.org/ImageObject" itemprop="url">
                <img src="http://r.photo.store.qq.com/psc?/V13IdniL4CDhqM/TCfiP1YaPeRT4Jil9RANX5cJ*1aQOmt2pvBJcyIUBYjo6zX.1Ohy5JABE2Jl1QoYYaGey.wh1Sxp4od.aXADq8X6GO1fm1.7GXSuxVxc7Ig!/r" itemprop="contentUrl"/>
              </a>
            
          

          
          </div>
        </div>
      

      
        <h2 id="深入java虚拟机-第五部分-高效并发"><a href="#深入java虚拟机-第五部分-高效并发" class="headerlink" title="深入java虚拟机-第五部分-高效并发"></a>深入java虚拟机-第五部分-高效并发</h2><h3 id="第13章-线程安全与锁优化"><a href="#第13章-线程安全与锁优化" class="headerlink" title="第13章 线程安全与锁优化"></a>第13章 线程安全与锁优化</h3><p>并发处理 的 广泛应用 是使得 Amdah1定律 代替 摩尔定律 成为 计算机性能发展源动力 的根本原因，也是人类 “压榨” 计算机运算能力 的 最有力武器。</p>
<h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>在 软件业发展 的 初期，程序编写 都是以 算法 为核心的，<br>程序员会把 数据 和 过程 分别作为 独立的部分 来考虑，<br>数据 代表 问题空间 中的 客体，程序代码 则用于 处理这些数据，<br>这种 思维方式 直接站在 计算机的角度 去 抽象问题和解决问题，<br>称为 面向过程 的 编程思想。</p>
<p>与此同时，<br>面向对象 的 编程思想 是站在 现实世界的角度 去 抽象和解决问题，<br>它把 数据和行为 都看做是 对象的一部分，<br>这样可以让程序员能以 符合现实世界的 思维方式 来 编写和组织程序。</p>
<p>面向过程 的 编程思想 极大地 提升了 现代软件开发 的 生产效率 和 软件可以达到的规模，<br>但是 现实世界与计算机世界 之间不可避免地 存在一些差异。</p>
<p>例如，人们很难想象现实中的 对象 在一项工作进行期间，会被不停地中断和切换，对象的属性（数据）可能会在 中断期间 被修改和变“脏”，<br>而这些事件 在计算机世界中 则是很正常的事情。</p>
<p>有时候，良好的设计原则 不得不向现实做出一些让步，我们必须让 程序 在计算机中 正确无误地运行，<br>然后再考虑如何将 代码组织得更好，让 程序 运行得 更快。</p>
<p>对于这部分的主题“高效并发”来讲，首先需要保证 并发的正确性，然后在此基础上实现 高效。</p>
<p>本章先从 如何保证并发的正确性 和 如何实现线程安全讲起。</p>
<h4 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h4><p>“线程安全”  这个名称，相信稍有经验的程序员都会听说过，甚至在 代码编写 和 走查的时候 可能还会将会挂在嘴边，<br>但是如何找到一个不太拗口的概念 来定义 线程安全 却不是一件容易的事情，<br>笔者尝试在Google中搜索它的概念，找到的是类似于 “如果一个对象可以安全地被多个线程同时使用，那它就是线程安全的”这样的定义——并不能说它不正确，但是人们无法从中获取到任何有用的信息。</p>
<p>（像我这种小白，也只是，听过，我可没有说过😶😶😶）</p>
<p>笔者认为《Java Concurrency In Practice》 的作者 Brian Goetz 对 “线程安全” 有一个比较恰当的定义：<br>“当 多个线程 访问 一个对象时，如果不用考虑这些 线程 在 运行时环境 下的 调度 和 交替执行，也不需要进行 额外的同步，或者在 调用方 进行任何其他的 协调操作，调用这个 对象的行为 都可以获得 正确的结果，那 这个对象 是 线程安全 的”。</p>
<p>这个定义比较 严谨，它要求 线程安全 的代码 都必须具备一个特征：<br>代码本身 封装 了所有必要的 正确性保障手段（如互斥同步等），<br>令 调用者 无需关心 多线程 的问题，更无须自己采取 任何措施 来 保证多线程的正确调用。</p>
<p>这点听起来简单，但其实并不容易做到，在大多数场景中，我们都会将这个定义弱化一些，如果把”调用这个对象的行为“限定为”单次调用“，<br>这个定义的其他描述也能够成立的话，我们就可以称它是 线程安全 了，为什么要 弱化 这个定义，现在暂且放下，稍后再详细探讨。</p>
<h5 id="Java语言中的线程安全"><a href="#Java语言中的线程安全" class="headerlink" title="Java语言中的线程安全"></a>Java语言中的线程安全</h5><p>我们已经有了 线程安全 的一个 抽象定义，<br>那接下来就讨论一下在 java语言 中，线程安全 具体是如何体现的？<br>有哪些操作是 线程安全 的？<br>我们这里讨论的 线程安全，就 限定与 多个线程之间 存在 共享数据访问 这个 前提，<br>因为如果一段代码 根本不会 与其他线程共享数据，那么从 线程安全 的 角度 来看，程序是 串行执行 还是 多线程执行 对它来说是完全没有区别的。</p>
<p>为了更加 深入地 理解 线程安全，在这里我们可以不把 线程安全 当做一个非真即假 的 二元排他项 来看待，<br>按照 线程安全 的 “安全程度” 由强至弱来排序，我们可以将Java语言中各种操作共享的数据分为以下5类：<br>不可变、绝对线程安全、相对线程安全、线程兼容和线程对立。</p>
<blockquote>
<p>这种划分方法也是 Brian Goetz在IBM developWorkers上发表的一篇论文中提出的，<br>这里写 “我们”  纯粹是笔者下笔行文中的语言用法。</p>
</blockquote>
<h6 id="1-不可变"><a href="#1-不可变" class="headerlink" title="1.不可变"></a>1.不可变</h6><p>在Java语言中（特指JDK1.5以后，即 Java内存模型 被 修正以后的 Java语言），<br>不可变（Immutable） 的 对象 一定是 线程安全的，<br>无论是 对象的方法 还是 方法的调用者，都不需要再采取 任何的线程安全保障措施，</p>
<p>在12章我们谈到 final关键字 带来的 可见性 时曾经提到过这一点，<br>只要一个 不可变的对象 被正确地 构建出来（没有发生 this 引用逃逸 的情况），<br>那其外部的 可见状态 永远也不会改变，<br>永远也不会看到它在 多个线程之中 处于 不一致 的状态。</p>
<p>“不可变” 带来的 安全性 是 最简单和最纯粹的。</p>
<p>Java语言中，如果 共享数据 是一个基本数据类型，那么只要在 定义时 使用 final关键字 修饰它 就可以保证它是 不可变的。</p>
<p>如果 共享数据 是一个对象，那就需要保证 对象的行为 不会对其 状态 产生任何影响 才行，</p>
<p>如果读者还没想明白这句话，不妨想一想 java.lang.String 类的对象，它是一个典型的 不可变对象，<br>我们调用它的 substring()、replace()和concat() 这些方法都 不会影响它 原来的值，只会返回一个新构造的字符串对象。</p>
<p>保证对象行为 不影响 自己状态的途径 有很多种，<br>其中最简单的就是把对象中 带有状态的变量 都声明为 final，<br>这样在 构造函数 结束之后，它就是 不可变的，<br>例如代码清单13-1中java.lang.Integer 构造函数所示的，<br>它通过将 内部状态变量 value 定义为 final 来保障 状态不变。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">                                代码清单 13-1 JDK中Integer类的构造函数</span></span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line">/*<span class="strong">*</span></span><br><span class="line"><span class="strong">  *</span> The value of the &lt;code&gt;Integer&lt;/code&gt;.</span><br><span class="line"><span class="code">  * @serial</span></span><br><span class="line"><span class="code">  */</span></span><br><span class="line"><span class="code">  private final int value;</span></span><br><span class="line"></span><br><span class="line"><span class="code">  /**</span></span><br><span class="line"><span class="code">    * Constructs newly allocated &lt;code&gt;Integer&lt;/code&gt; object that</span></span><br><span class="line"><span class="code">    * represents the specified &lt;code&gt;int&lt;/code&gt; value.</span></span><br><span class="line"><span class="code">    *</span></span><br><span class="line"><span class="code">    * @param value the value to be represented by the &lt;code&gt;Integer&lt;/code&gt; object.</span></span><br><span class="line"><span class="code">    *</span></span><br><span class="line"><span class="code">    */</span></span><br><span class="line"><span class="code">    public Integer(int value)&#123;</span></span><br><span class="line"><span class="code">      this.value=value;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">----------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>在 Java API 中 符合 不可变要求 的类型，<br>除了上面提到的 String 之外，<br>常用的还有 枚举类型，以及 java.lang.Number的部分子类，<br>如Long和Double等数值包装类型，BigInteger和BigDecimal等大数据类型；</p>
<p>但同为 Number 的 子类型 的 原子类 AtomicInteger 和 AtomicLong 则并非不可变的，<br>读者不妨看看这两个原子类的源码，想一想为什么。</p>
<p>(emm，原因是不是那个value没有被标为final？Integer类当中的value被标记为final了，而AtomicInteger以及AtomicLong里面的value都没有被标记为final)</p>
<p>AtomicInteger类代码：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br></pre></td><td class="code"><pre><span class="line">                                代码清单 AtomicInteger类</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Written by Doug Lea with assistance from members of JCP JSR-166</span></span><br><span class="line"><span class="comment"> * Expert Group and released to the public domain, as explained at</span></span><br><span class="line"><span class="comment"> * http://creativecommons.org/publicdomain/zero/1.0/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">package java.util.concurrent.atomic;</span><br><span class="line"><span class="keyword">import</span> java.util.function.IntUnaryOperator;</span><br><span class="line"><span class="keyword">import</span> java.util.function.IntBinaryOperator;</span><br><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>An &#123;@code int&#125; value that may be updated atomically.  See </span>the</span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>&#123;@link java.util.concurrent.atomic&#125; package specification for</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>description of </span>the<span class="markdown"> properties of atomic variables. An</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>&#123;@code AtomicInteger&#125; is used in applications </span>such<span class="markdown"> as atomically</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>incremented counters, and cannot be used as </span>a<span class="markdown"> replacement for </span>an</span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>&#123;@link java.lang.Integer&#125;. However, this class does extend</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>&#123;@code Number&#125; to allow uniform access by tools and utilities that</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>deal with numerically-based classes.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> *</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@since 1.5</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@author Doug Lea</span></span></span><br><span class="line"><span class="comment"><span class="markdown">*/</span></span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">AtomicInteger</span> <span class="keyword">extends</span> <span class="title">Number</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    private <span class="keyword">static</span> <span class="keyword">final</span> long serialVersionUID = <span class="number">6214790243416807050</span>L;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// setup to use Unsafe.compareAndSwapInt for updates</span></span><br><span class="line">    private <span class="keyword">static</span> <span class="keyword">final</span> Unsafe unsafe = Unsafe.getUnsafe();</span><br><span class="line">    private <span class="keyword">static</span> <span class="keyword">final</span> long valueOffset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            valueOffset = unsafe.objectFieldOffset</span><br><span class="line">                (AtomicInteger<span class="class">.<span class="keyword">class</span>.<span class="title">getDeclaredField</span>("<span class="title">value</span>"));</span></span><br><span class="line"><span class="class">        &#125; <span class="title">catch</span> (<span class="title">Exception</span> <span class="title">ex</span>) </span>&#123; <span class="keyword">throw</span> <span class="keyword">new</span> Error(ex); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private volatile <span class="built_in">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Creates </span>a<span class="markdown"> new AtomicInteger with </span>the<span class="markdown"> given initial value.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@param initialValue </span>the<span class="markdown"> initial value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public AtomicInteger(<span class="built_in">int</span> initialValue) &#123;</span><br><span class="line">        value = initialValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Creates </span>a<span class="markdown"> new AtomicInteger with initial value &#123;@code 0&#125;.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public AtomicInteger() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Gets </span>the<span class="markdown"> current value.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@return </span>the<span class="markdown"> current value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="keyword">final</span> <span class="built_in">int</span> <span class="keyword">get</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Sets to </span>the<span class="markdown"> given value.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@param newValue </span>the<span class="markdown"> new value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="keyword">final</span> <span class="keyword">void</span> <span class="keyword">set</span>(<span class="built_in">int</span> newValue) &#123;</span><br><span class="line">        value = newValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Eventually sets to </span>the<span class="markdown"> given value.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@param newValue </span>the<span class="markdown"> new value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@since 1.6</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="keyword">final</span> <span class="keyword">void</span> lazySet(<span class="built_in">int</span> newValue) &#123;</span><br><span class="line">        unsafe.putOrderedInt(<span class="keyword">this</span>, valueOffset, newValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Atomically sets to </span>the<span class="markdown"> given value and returns </span>the<span class="markdown"> old value.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@param newValue </span>the<span class="markdown"> new value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@return </span>the<span class="markdown"> previous value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="keyword">final</span> <span class="built_in">int</span> getAndSet(<span class="built_in">int</span> newValue) &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndSetInt(<span class="keyword">this</span>, valueOffset, newValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Atomically sets </span>the<span class="markdown"> value to </span>the<span class="markdown"> given updated value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>if </span>the<span class="markdown"> current value &#123;@code ==&#125; </span>the<span class="markdown"> expected value.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@param expect </span>the<span class="markdown"> expected value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@param update </span>the<span class="markdown"> new value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@return &#123;@code true&#125; if successful. False return indicates that</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span></span>the<span class="markdown"> actual value was not equal to </span>the<span class="markdown"> expected value.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="keyword">final</span> boolean compareAndSet(<span class="built_in">int</span> expect, <span class="built_in">int</span> update) &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="keyword">this</span>, valueOffset, expect, update);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Atomically sets </span>the<span class="markdown"> value to </span>the<span class="markdown"> given updated value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>if </span>the<span class="markdown"> current value &#123;@code ==&#125; </span>the<span class="markdown"> expected value.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span><span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span><span class="xml"><span class="tag">&lt;</span></span></span>a<span class="markdown"><span class="xml"> href="package-summary.html#weakCompareAndSet"&gt;</span>May fail</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>spuriously and does not provide ordering guarantees<span class="xml"><span class="tag">&lt;/</span></span></span>a<span class="markdown"><span class="xml">&gt;</span>, </span>so<span class="markdown"> is</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>only rarely </span>an<span class="markdown"> appropriate alternative to &#123;@code compareAndSet&#125;.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@param expect </span>the<span class="markdown"> expected value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@param update </span>the<span class="markdown"> new value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@return &#123;@code true&#125; if successful</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="keyword">final</span> boolean weakCompareAndSet(<span class="built_in">int</span> expect, <span class="built_in">int</span> update) &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="keyword">this</span>, valueOffset, expect, update);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Atomically increments by one </span>the<span class="markdown"> current value.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@return </span>the<span class="markdown"> previous value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="keyword">final</span> <span class="built_in">int</span> getAndIncrement() &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndAddInt(<span class="keyword">this</span>, valueOffset, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Atomically decrements by one </span>the<span class="markdown"> current value.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@return </span>the<span class="markdown"> previous value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="keyword">final</span> <span class="built_in">int</span> getAndDecrement() &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndAddInt(<span class="keyword">this</span>, valueOffset, <span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Atomically adds </span>the<span class="markdown"> given value to </span>the<span class="markdown"> current value.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@param delta </span>the<span class="markdown"> value to add</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@return </span>the<span class="markdown"> previous value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="keyword">final</span> <span class="built_in">int</span> getAndAdd(<span class="built_in">int</span> delta) &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndAddInt(<span class="keyword">this</span>, valueOffset, delta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Atomically increments by one </span>the<span class="markdown"> current value.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@return </span>the<span class="markdown"> updated value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="keyword">final</span> <span class="built_in">int</span> incrementAndGet() &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndAddInt(<span class="keyword">this</span>, valueOffset, <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Atomically decrements by one </span>the<span class="markdown"> current value.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@return </span>the<span class="markdown"> updated value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="keyword">final</span> <span class="built_in">int</span> decrementAndGet() &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndAddInt(<span class="keyword">this</span>, valueOffset, <span class="number">-1</span>) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Atomically adds </span>the<span class="markdown"> given value to </span>the<span class="markdown"> current value.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@param delta </span>the<span class="markdown"> value to add</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@return </span>the<span class="markdown"> updated value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="keyword">final</span> <span class="built_in">int</span> addAndGet(<span class="built_in">int</span> delta) &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndAddInt(<span class="keyword">this</span>, valueOffset, delta) + delta;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Atomically updates </span>the<span class="markdown"> current value with </span>the<span class="markdown"> results of</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>applying </span>the<span class="markdown"> given function, returning </span>the<span class="markdown"> previous value. The</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>function </span>should<span class="markdown"> be side-effect-free, since it may be re-applied</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>when attempted updates fail due to contention among threads.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@param updateFunction </span>a<span class="markdown"> side-effect-free function</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@return </span>the<span class="markdown"> previous value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@since 1.8</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="keyword">final</span> <span class="built_in">int</span> getAndUpdate(IntUnaryOperator updateFunction) &#123;</span><br><span class="line">        <span class="built_in">int</span> prev, next;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            prev = <span class="keyword">get</span>();</span><br><span class="line">            next = updateFunction.applyAsInt(prev);</span><br><span class="line">        &#125; <span class="keyword">while</span> (!compareAndSet(prev, next));</span><br><span class="line">        <span class="keyword">return</span> prev;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Atomically updates </span>the<span class="markdown"> current value with </span>the<span class="markdown"> results of</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>applying </span>the<span class="markdown"> given function, returning </span>the<span class="markdown"> updated value. The</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>function </span>should<span class="markdown"> be side-effect-free, since it may be re-applied</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>when attempted updates fail due to contention among threads.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@param updateFunction </span>a<span class="markdown"> side-effect-free function</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@return </span>the<span class="markdown"> updated value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@since 1.8</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="keyword">final</span> <span class="built_in">int</span> updateAndGet(IntUnaryOperator updateFunction) &#123;</span><br><span class="line">        <span class="built_in">int</span> prev, next;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            prev = <span class="keyword">get</span>();</span><br><span class="line">            next = updateFunction.applyAsInt(prev);</span><br><span class="line">        &#125; <span class="keyword">while</span> (!compareAndSet(prev, next));</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Atomically updates </span>the<span class="markdown"> current value with </span>the<span class="markdown"> results of</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>applying </span>the<span class="markdown"> given function to </span>the<span class="markdown"> current and given values,</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>returning </span>the<span class="markdown"> previous value. The function </span>should<span class="markdown"> be</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>side-effect-free, since it may be re-applied when attempted</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>updates fail due to contention among threads.  The function</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>is applied with </span>the<span class="markdown"> current value as its first argument,</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>and </span>the<span class="markdown"> given update as </span>the<span class="markdown"> second argument.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@param x </span>the<span class="markdown"> update value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@param accumulatorFunction </span>a<span class="markdown"> side-effect-free function of two arguments</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@return </span>the<span class="markdown"> previous value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@since 1.8</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="keyword">final</span> <span class="built_in">int</span> getAndAccumulate(<span class="built_in">int</span> x,</span><br><span class="line">                                      IntBinaryOperator accumulatorFunction) &#123;</span><br><span class="line">        <span class="built_in">int</span> prev, next;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            prev = <span class="keyword">get</span>();</span><br><span class="line">            next = accumulatorFunction.applyAsInt(prev, x);</span><br><span class="line">        &#125; <span class="keyword">while</span> (!compareAndSet(prev, next));</span><br><span class="line">        <span class="keyword">return</span> prev;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Atomically updates </span>the<span class="markdown"> current value with </span>the<span class="markdown"> results of</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>applying </span>the<span class="markdown"> given function to </span>the<span class="markdown"> current and given values,</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>returning </span>the<span class="markdown"> updated value. The function </span>should<span class="markdown"> be</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>side-effect-free, since it may be re-applied when attempted</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>updates fail due to contention among threads.  The function</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>is applied with </span>the<span class="markdown"> current value as its first argument,</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>and </span>the<span class="markdown"> given update as </span>the<span class="markdown"> second argument.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@param x </span>the<span class="markdown"> update value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@param accumulatorFunction </span>a<span class="markdown"> side-effect-free function of two arguments</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@return </span>the<span class="markdown"> updated value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@since 1.8</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="keyword">final</span> <span class="built_in">int</span> accumulateAndGet(<span class="built_in">int</span> x,</span><br><span class="line">                                      IntBinaryOperator accumulatorFunction) &#123;</span><br><span class="line">        <span class="built_in">int</span> prev, next;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            prev = <span class="keyword">get</span>();</span><br><span class="line">            next = accumulatorFunction.applyAsInt(prev, x);</span><br><span class="line">        &#125; <span class="keyword">while</span> (!compareAndSet(prev, next));</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Returns </span>the<span class="markdown"> String representation of </span>the<span class="markdown"> current value.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@return </span>the<span class="markdown"> String representation of </span>the<span class="markdown"> current value</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="built_in">String</span> toString() &#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.toString(<span class="keyword">get</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Returns </span>the<span class="markdown"> value of this &#123;@code AtomicInteger&#125; as </span>an<span class="markdown"> &#123;@code int&#125;.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="built_in">int</span> intValue() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">get</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Returns </span>the<span class="markdown"> value of this &#123;@code AtomicInteger&#125; as </span>a<span class="markdown"> &#123;@code long&#125;</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>after </span>a<span class="markdown"> widening primitive conversion.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@jls 5.1.2 Widening Primitive Conversions</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public long longValue() &#123;</span><br><span class="line">        <span class="keyword">return</span> (long)<span class="keyword">get</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Returns </span>the<span class="markdown"> value of this &#123;@code AtomicInteger&#125; as </span>a<span class="markdown"> &#123;@code float&#125;</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>after </span>a<span class="markdown"> widening primitive conversion.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@jls 5.1.2 Widening Primitive Conversions</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public float floatValue() &#123;</span><br><span class="line">        <span class="keyword">return</span> (float)<span class="keyword">get</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>Returns </span>the<span class="markdown"> value of this &#123;@code AtomicInteger&#125; as </span>a<span class="markdown"> &#123;@code double&#125;</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>after </span>a<span class="markdown"> widening primitive conversion.</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">     * </span>@jls 5.1.2 Widening Primitive Conversions</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">     */</span></span></span></span><br><span class="line">    public <span class="built_in">double</span> doubleValue() &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">double</span>)<span class="keyword">get</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>AtomicLong类代码：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br></pre></td><td class="code"><pre><span class="line">                                代码清单 AtomicLong类</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Written by Doug Lea with assistance from members of JCP JSR-166</span></span><br><span class="line"><span class="comment"> * Expert Group and released to the public domain, as explained at</span></span><br><span class="line"><span class="comment"> * http://creativecommons.org/publicdomain/zero/1.0/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> java.util.concurrent.atomic;</span><br><span class="line"><span class="keyword">import</span> java.util.function.LongUnaryOperator;</span><br><span class="line"><span class="keyword">import</span> java.util.function.LongBinaryOperator;</span><br><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A &#123;<span class="doctag">@code</span> long&#125; value that may be updated atomically.  See the</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> java.util.concurrent.atomic&#125; package specification for</span></span><br><span class="line"><span class="comment"> * description of the properties of atomic variables. An</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> AtomicLong&#125; is used in applications such as atomically</span></span><br><span class="line"><span class="comment"> * incremented sequence numbers, and cannot be used as a replacement</span></span><br><span class="line"><span class="comment"> * for a &#123;<span class="doctag">@link</span> java.lang.Long&#125;. However, this class does extend</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> Number&#125; to allow uniform access by tools and utilities that</span></span><br><span class="line"><span class="comment"> * deal with numerically-based classes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Doug Lea</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicLong</span> <span class="keyword">extends</span> <span class="title">Number</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> &#123;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1927816293512124184</span>L;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// setup to use Unsafe.compareAndSwapLong for updates</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe unsafe = Unsafe.getUnsafe();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> valueOffset;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Records whether the underlying JVM supports lockless</span></span><br><span class="line"><span class="comment">     * compareAndSwap for longs. While the Unsafe.compareAndSwapLong</span></span><br><span class="line"><span class="comment">     * method works in either case, some constructions should be</span></span><br><span class="line"><span class="comment">     * handled at Java level to avoid locking user-visible locks.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> VM_SUPPORTS_LONG_CAS = VMSupportsCS8();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns whether underlying JVM supports lockless CompareAndSet</span></span><br><span class="line"><span class="comment">     * for longs. Called only once and cached in VM_SUPPORTS_LONG_CAS.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> native <span class="keyword">boolean</span> VMSupportsCS8();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            valueOffset = unsafe.objectFieldOffset</span><br><span class="line">                (AtomicLong<span class="class">.<span class="keyword">class</span>.<span class="title">getDeclaredField</span>("<span class="title">value</span>"));</span></span><br><span class="line"><span class="class">        &#125; <span class="title">catch</span> (<span class="title">Exception</span> <span class="title">ex</span>) &#123;</span> <span class="keyword">throw</span> <span class="keyword">new</span> Error(ex); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new AtomicLong with the given initial value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> initialValue the initial value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> AtomicLong(<span class="keyword">long</span> initialValue) &#123;</span><br><span class="line">        value = initialValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new AtomicLong with initial value &#123;<span class="doctag">@code</span> 0&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> AtomicLong() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets the current value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the current value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> get() &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets to the given value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newValue the new value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> set(<span class="keyword">long</span> newValue) &#123;</span><br><span class="line">        value = newValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Eventually sets to the given value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newValue the new value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.6</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> lazySet(<span class="keyword">long</span> newValue) &#123;</span><br><span class="line">        unsafe.putOrderedLong(<span class="keyword">this</span>, valueOffset, newValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Atomically sets to the given value and returns the old value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newValue the new value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the previous value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> getAndSet(<span class="keyword">long</span> newValue) &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndSetLong(<span class="keyword">this</span>, valueOffset, newValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Atomically sets the value to the given updated value</span></span><br><span class="line"><span class="comment">     * if the current value &#123;<span class="doctag">@code</span> ==&#125; the expected value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> expect the expected value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> update the new value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if successful. False return indicates that</span></span><br><span class="line"><span class="comment">     * the actual value was not equal to the expected value.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> compareAndSet(<span class="keyword">long</span> expect, <span class="keyword">long</span> update) &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.compareAndSwapLong(<span class="keyword">this</span>, valueOffset, expect, update);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Atomically sets the value to the given updated value</span></span><br><span class="line"><span class="comment">     * if the current value &#123;<span class="doctag">@code</span> ==&#125; the expected value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;&lt;a href="package-summary.html#weakCompareAndSet"&gt;May fail</span></span><br><span class="line"><span class="comment">     * spuriously and does not provide ordering guarantees&lt;/a&gt;, so is</span></span><br><span class="line"><span class="comment">     * only rarely an appropriate alternative to &#123;<span class="doctag">@code</span> compareAndSet&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> expect the expected value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> update the new value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if successful</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> weakCompareAndSet(<span class="keyword">long</span> expect, <span class="keyword">long</span> update) &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.compareAndSwapLong(<span class="keyword">this</span>, valueOffset, expect, update);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Atomically increments by one the current value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the previous value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> getAndIncrement() &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndAddLong(<span class="keyword">this</span>, valueOffset, <span class="number">1</span>L);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Atomically decrements by one the current value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the previous value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> getAndDecrement() &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndAddLong(<span class="keyword">this</span>, valueOffset, <span class="number">-1</span>L);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Atomically adds the given value to the current value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta the value to add</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the previous value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> getAndAdd(<span class="keyword">long</span> delta) &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndAddLong(<span class="keyword">this</span>, valueOffset, delta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Atomically increments by one the current value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the updated value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> incrementAndGet() &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndAddLong(<span class="keyword">this</span>, valueOffset, <span class="number">1</span>L) + <span class="number">1</span>L;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Atomically decrements by one the current value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the updated value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> decrementAndGet() &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndAddLong(<span class="keyword">this</span>, valueOffset, <span class="number">-1</span>L) - <span class="number">1</span>L;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Atomically adds the given value to the current value.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta the value to add</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the updated value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> addAndGet(<span class="keyword">long</span> delta) &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndAddLong(<span class="keyword">this</span>, valueOffset, delta) + delta;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Atomically updates the current value with the results of</span></span><br><span class="line"><span class="comment">     * applying the given function, returning the previous value. The</span></span><br><span class="line"><span class="comment">     * function should be side-effect-free, since it may be re-applied</span></span><br><span class="line"><span class="comment">     * when attempted updates fail due to contention among threads.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> updateFunction a side-effect-free function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the previous value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> getAndUpdate(LongUnaryOperator updateFunction) &#123;</span><br><span class="line">        <span class="keyword">long</span> prev, next;</span><br><span class="line">        do &#123;</span><br><span class="line">            prev = get();</span><br><span class="line">            next = updateFunction.applyAsLong(prev);</span><br><span class="line">        &#125; <span class="keyword">while</span> (!compareAndSet(prev, next));</span><br><span class="line">        <span class="keyword">return</span> prev;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Atomically updates the current value with the results of</span></span><br><span class="line"><span class="comment">     * applying the given function, returning the updated value. The</span></span><br><span class="line"><span class="comment">     * function should be side-effect-free, since it may be re-applied</span></span><br><span class="line"><span class="comment">     * when attempted updates fail due to contention among threads.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> updateFunction a side-effect-free function</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the updated value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> updateAndGet(LongUnaryOperator updateFunction) &#123;</span><br><span class="line">        <span class="keyword">long</span> prev, next;</span><br><span class="line">        do &#123;</span><br><span class="line">            prev = get();</span><br><span class="line">            next = updateFunction.applyAsLong(prev);</span><br><span class="line">        &#125; <span class="keyword">while</span> (!compareAndSet(prev, next));</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Atomically updates the current value with the results of</span></span><br><span class="line"><span class="comment">     * applying the given function to the current and given values,</span></span><br><span class="line"><span class="comment">     * returning the previous value. The function should be</span></span><br><span class="line"><span class="comment">     * side-effect-free, since it may be re-applied when attempted</span></span><br><span class="line"><span class="comment">     * updates fail due to contention among threads.  The function</span></span><br><span class="line"><span class="comment">     * is applied with the current value as its first argument,</span></span><br><span class="line"><span class="comment">     * and the given update as the second argument.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x the update value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accumulatorFunction a side-effect-free function of two arguments</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the previous value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> getAndAccumulate(<span class="keyword">long</span> x,</span><br><span class="line">                                       LongBinaryOperator accumulatorFunction) &#123;</span><br><span class="line">        <span class="keyword">long</span> prev, next;</span><br><span class="line">        do &#123;</span><br><span class="line">            prev = get();</span><br><span class="line">            next = accumulatorFunction.applyAsLong(prev, x);</span><br><span class="line">        &#125; <span class="keyword">while</span> (!compareAndSet(prev, next));</span><br><span class="line">        <span class="keyword">return</span> prev;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Atomically updates the current value with the results of</span></span><br><span class="line"><span class="comment">     * applying the given function to the current and given values,</span></span><br><span class="line"><span class="comment">     * returning the updated value. The function should be</span></span><br><span class="line"><span class="comment">     * side-effect-free, since it may be re-applied when attempted</span></span><br><span class="line"><span class="comment">     * updates fail due to contention among threads.  The function</span></span><br><span class="line"><span class="comment">     * is applied with the current value as its first argument,</span></span><br><span class="line"><span class="comment">     * and the given update as the second argument.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x the update value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accumulatorFunction a side-effect-free function of two arguments</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the updated value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.8</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> accumulateAndGet(<span class="keyword">long</span> x,</span><br><span class="line">                                       LongBinaryOperator accumulatorFunction) &#123;</span><br><span class="line">        <span class="keyword">long</span> prev, next;</span><br><span class="line">        do &#123;</span><br><span class="line">            prev = get();</span><br><span class="line">            next = accumulatorFunction.applyAsLong(prev, x);</span><br><span class="line">        &#125; <span class="keyword">while</span> (!compareAndSet(prev, next));</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the String representation of the current value.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the String representation of the current value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String toString() &#123;</span><br><span class="line">        <span class="keyword">return</span> Long.toString(get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the value of this &#123;<span class="doctag">@code</span> AtomicLong&#125; as an &#123;<span class="doctag">@code</span> int&#125;</span></span><br><span class="line"><span class="comment">     * after a narrowing primitive conversion.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@jls</span> 5.1.3 Narrowing Primitive Conversions</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> intValue() &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the value of this &#123;<span class="doctag">@code</span> AtomicLong&#125; as a &#123;<span class="doctag">@code</span> long&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> longValue() &#123;</span><br><span class="line">        <span class="keyword">return</span> get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the value of this &#123;<span class="doctag">@code</span> AtomicLong&#125; as a &#123;<span class="doctag">@code</span> float&#125;</span></span><br><span class="line"><span class="comment">     * after a widening primitive conversion.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@jls</span> 5.1.2 Widening Primitive Conversions</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">float</span> floatValue() &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">float</span>)get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the value of this &#123;<span class="doctag">@code</span> AtomicLong&#125; as a &#123;<span class="doctag">@code</span> double&#125;</span></span><br><span class="line"><span class="comment">     * after a widening primitive conversion.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@jls</span> 5.1.2 Widening Primitive Conversions</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">double</span> doubleValue() &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">double</span>)get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h6 id="2-绝对线程安全"><a href="#2-绝对线程安全" class="headerlink" title="2.绝对线程安全"></a>2.绝对线程安全</h6><p>绝对的 线程安全 完全满足 Brian Goetz 给出的 线程安全 的定义，<br>这个 定义 其实是很 严格的，<br>一个类 要达到 “不管 运行时环境 如何， 调用者 都不需要 任何额外的 同步措施” 通常需要付出很大的，甚至有时候是不切实际的代价。</p>
<p>在 Java API中 标注自己是 线程安全的类，大多数都不是 绝对的线程安全。</p>
<p>我们可以通过 Java API中 一个不是 “绝对线程安全” 的线程安全类 来看看这里的 “绝对” 是什么意思。</p>
<p>如果说 java.util.Vector 是一个 线程安全 的 容器，<br>相信所有的Java程序员对此都不会有异议，因为它的 add()、get()和size() 这类方法都是被 synchronized 修饰的，<br>尽管这样 效率很低，但确实是 安全的。</p>
<p>但是，即使它 所有的方法 都被 修饰成 同步，也不意味着 调用它的时候永远都不需要 同步手段了，<br>请看一下代码清单13-2中的测试代码。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">                                代码清单 <span class="number">13</span><span class="number">-2</span> 对Vector线程安全的测试</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Vector&lt;Integer&gt; <span class="built_in">vector</span> = <span class="keyword">new</span> Vector&lt;Integer&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">String</span>[] args)</span></span>&#123;</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">      <span class="built_in">vector</span>.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Thread removeThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="built_in">run</span>()&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">vector</span>.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">        <span class="built_in">vector</span>.<span class="built_in">remove</span>(i);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  Thread printThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="built_in">run</span>()&#123;</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">vector</span>.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">        System.out.<span class="built_in">println</span>((<span class="built_in">vector</span>.<span class="built_in">get</span>(i)));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  removeThread.start();</span><br><span class="line">  printThread.start();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//不要同时产生过多的线程，否则会导致操作系统假死</span></span><br><span class="line">  <span class="keyword">while</span>(Thread.activeCount() &gt; <span class="number">20</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"Thread-132"</span> java.lang.ArrayIndexOutOfBoundsException:</span><br><span class="line">Array index out <span class="keyword">of</span> range:<span class="number">17</span></span><br><span class="line">  at java.util.<span class="module-access"><span class="module"><span class="identifier">Vector</span>.</span></span>remove(<span class="module-access"><span class="module"><span class="identifier">Vector</span>.</span></span>java:<span class="number">777</span>)</span><br><span class="line">  at org.fenixsoft.mulithread.<span class="module-access"><span class="module"><span class="identifier">VectorTest$1</span>.</span></span>run(<span class="module-access"><span class="module"><span class="identifier">VectorTest</span>.</span></span>java:<span class="number">21</span>)</span><br><span class="line">  at java.lang.<span class="module-access"><span class="module"><span class="identifier">Thread</span>.</span></span>run(<span class="module-access"><span class="module"><span class="identifier">Thread</span>.</span></span>java:<span class="number">662</span>)</span><br></pre></td></tr></table></figure>

<p>很明显，尽管这里使用到的 Vector的get()、remove()和size() 方法都是 同步的，<br>但是在 多线程 的环境下，如果不在 方法调用端 做额外的同步措施 的话，<br>使用这段代码 仍然是不安全的，因为如果另一个线程 恰好在错误的时间里 删除了一个元素，<br>导致序号 i 已经不再可用的话，<br>再用 i 访问数组就会 抛出一个ArrayIndexOutOfBoundsException</p>
<p>如果要保证这段代码能正确执行下去，我们不得不把 removeThread和printThread 的定义改成如代码清单13-3所示的样子。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">                                代码清单 <span class="number">13</span><span class="number">-3</span> 必须加入同步 以保证Vector访问的线程安全性</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line">Thread removeThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;</span><br><span class="line">  @Override</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="built_in">run</span>()&#123;</span><br><span class="line">    synchronized(<span class="built_in">vector</span>)&#123;</span><br><span class="line">      <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">vector</span>.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">        <span class="built_in">vector</span>.<span class="built_in">remove</span>(i);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Thread printThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;</span><br><span class="line">  @Override</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="built_in">run</span>()&#123;</span><br><span class="line">    synchronized(<span class="built_in">vector</span>)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">vector</span>.<span class="built_in">size</span>(); i++)&#123;</span><br><span class="line">        System.out.<span class="built_in">println</span>((<span class="built_in">vector</span>.<span class="built_in">get</span>(i)));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h6 id="3-相对线程安全"><a href="#3-相对线程安全" class="headerlink" title="3.相对线程安全"></a>3.相对线程安全</h6><p>相对的 线程安全 就是我们 通常意义上 所讲的 线程安全，<br>它需要 保证 对这个对象 单独的操作 是 线程安全的，<br>我们在 调用的时候 不需要做 额外的保障措施，但是对于一些 特定顺序 的 连续调用，<br>就可能需要在 调用端 使用 额外的同步手段 来保证 调用的正确性。</p>
<p>上面代码清单13-2和代码清单13-3就是 相对线程安全的 明显的 案例。</p>
<p>在Java语言中，大部分的 线程安全类 都属于这种类型，例如 Vector、HashTable、Collections的synchronizedCollection() 方法包装的集合 等。</p>
<h6 id="4-线程兼容"><a href="#4-线程兼容" class="headerlink" title="4.线程兼容"></a>4.线程兼容</h6><p>线程兼容 是指 对象本身 并不是 线程安全的，<br>但是可以通过在 调用端 正确地 使用 同步手段 来保证对象 在并发环境中 可以安全地使用，<br>我们平常说 一个类不是线程安全的，绝大多数时候指的是这一种情况。</p>
<p>Java API中大部分的类 都是属于 线程兼容的，如与前面的 Vector和HashTable 相对应的集合类 ArrayList和HashMap 等。</p>
<h6 id="5-线程对立"><a href="#5-线程对立" class="headerlink" title="5.线程对立"></a>5.线程对立</h6><p>线程对立 是指无论 调用端 是否采取了 同步措施，<br>都无法在 多线程环境中 并发使用的代码。</p>
<p>由于Java语言天生就具备 多线程特性，线程对立 这种 排斥多线程的代码 时很少出现的，而且通常都是 有害的，应当尽量避免。</p>
<p>一个线程对立 的例子是 Thread 类的 suspend() 和 resume() 方法，<br>如果有两个线程 同时持有一个线程对象，一个尝试去中断线程，另一个尝试去恢复线程，<br>如果并发进行的话，无论调用时 是否进行了同步，目标线程都是存在 死锁风险 的，<br>如果 suspend() 中断的线程 就是 即将要执行 resume() 的那个线程，那就肯定要产生 死锁 了。</p>
<p>也正是由于这个原因， suspend() 和 resume() 方法已经被 JDK 声明废弃（@Deprecated）了。</p>
<p>常见的 线程对立 的操作还有 System.setIn()、System.setOut() 和 System.runFinalizersOnExit()等。</p>
<h5 id="线程安全的实现方法"><a href="#线程安全的实现方法" class="headerlink" title="线程安全的实现方法"></a>线程安全的实现方法</h5><p>了解了 什么是线程安全 之后，紧接着的一个问题就是我们应该 如何实现线程安全，<br>这听起来似乎是一件由代码如何编写来决定的事情，确实，如何实现线程安全 与 代码编写 有很大的关系，<br>但 虚拟机 提供的 同步和锁机制 也起到了非常重要的作用。</p>
<p>本节中，代码编写如何实现线程安全 和 虚拟机如何实现同步与锁 这两者都会有所涉及，相对而言更偏重后者一些，<br>只要读者了解了 虚拟机线程安全手段 的运作过程，自己去思考代码如何编写并不是一件困难的事情。</p>
<p>（周大大，你是认真的吗？😭😭😭 说出这句话的时候，考虑过像我这种小白的感受吗？🙃🙃🙃）</p>
<h6 id="1-互斥同步"><a href="#1-互斥同步" class="headerlink" title="1.互斥同步"></a>1.互斥同步</h6><p>互斥同步（Mutual Exclusion &amp; Synchronization） 是常见的一种 并发正确性保障手段。</p>
<p>同步 是指在 多个线程 并发访问 共享数据时，保证 共享数据 在同一个时刻 只被一个（或者是一些，使用信号量的时候）线程使用。</p>
<p>而 互斥 是 实现同步 的 一种手段，<br>临界区（Critical Section）、互斥量（Mutex）和信号量（Semaphore）都是主要的 互斥实现方式。</p>
<p>因此，在这4个字里面，互斥 是 因， 同步 是 果；互斥 是 方法，同步 是 目的。</p>
<p>在 Java 中，最基本的 同步互斥 手段就是 synchronized关键字，<br>synchronized关键字 经过 编译 之后， 会在 同步块 的前后 分别形成 monitorenter和monitorexit 这两个字节码指令，<br>这两个字节码 都需要一个 reference 类型的参数来指明要 锁定和解锁 的对象。</p>
<p>如果Java程序中的 synchronized明确指定了 对象参数，那就是 这个对象的reference；<br>如果没有明确指定，那就根据 synchronized 修饰的是实例方法还是类方法，去取对应的 对象实例 或 Class对象 来作为 锁对象。</p>
<p>根据 虚拟机规范 的要求，<br>在 执行 monitorenter 指令时，<br>首先 要尝试 获取 对象的锁。</p>
<p>如果 这个对象 没被 锁定，<br>或者 当前线程 已经拥有了 那个对象的锁，<br>把 锁 的 计数器 加1，<br>相应的，<br>在 执行 monitorexit 指令时 会将 锁计数器 减1，<br>当计数器为0时，锁 就 释放。</p>
<p>如果 获取 对象锁 失败，那 当前线程 就要 阻塞等待，直到 对象锁 被 另外一个线程 释放为止。</p>
<p>在 虚拟机规范 对 monitorenter和monitorexit 的行为描述中，有两点是需要特别注意的。</p>
<p>首先，synchronized同步块 对 同一条线程 来说 是可重入的，不会出现 自己把自己 锁死的问题。</p>
<p>其次，同步块 在 已进入的线程 执行完之前，会 阻塞 后面其他线程的进入。</p>
<p>第12章讲过，Java的线程 是映射到 操作系统 的 原生线程 之上的，如果要 阻塞或唤醒 一个线程，都需要 操作系统来帮忙完成，<br>这就需要从 用户态 转换到 核心态 中，因此 状态转换 需要耗费 很多的处理器时间。</p>
<p>对于 代码简单的 同步块（如被 synchronized修饰的 getter() 或 setter() 方法），<br>状态转换 消耗的时间 有可能比 用户代码 执行的时间 还要长。</p>
<p>所以 synchronized 是Java语言中一个 重量级（Heavyweight）的操作，有经验的程序员都会在 确实必要 的情况下 才使用这种操作。</p>
<p>而 虚拟机本身 也会进行一些 优化，<br>譬如在通知 操作系统阻塞线程 之前 加入一段 自旋等待过程，避免频繁地 切入到 核心态 之中。</p>
<p>除了 synchronized 之外，我们还可以使用 java.util.concurrent(下文称J.U.C) 包中的 重入锁（ReentrantLock） 来 实现同步，<br>在基本用法上， ReentrantLock与synchronized 很相似，<br>它们都具备一样的 线程重入特性，只是代码写法上有点区别，<br>一个表现为 API层面的 互斥锁（ lock()和unlock()方法 配合 try/finally语句块 来完成），<br>另一个表现为 原生语法层面的互斥锁。</p>
<p>不过，相比 synchronized，ReentrantLock 增加了一些 高级功能，<br>主要有以下3项：<br>等待可中断、可实现公平锁、以及 锁可以绑定多个条件。</p>
<p>等待可中断 是指 当持有锁的线程 长期不释放锁 的时候，正在 等待的线程 可以选择放弃等待，改为处理其他事情，可中断特性 对处理执行时间非常长的 同步块 很有帮助。</p>
<p>公平锁 是指 多个线程 在等待 同一个锁 时，必须按照 申请锁 的时间顺序 来依次 获得锁；<br>而 非公平锁 则不保证 这一点，<br>在 锁 被释放时，任何一个 等待锁的线程 都有机会 获得锁。<br>synchronized 中 的 锁 是非公平的，ReentrantLock 默认情况下  也是非公平的，但可以通过 带布尔值 的 构造函数 要求使用 公平锁。</p>
<p>锁绑定多个条件 是指 一个ReentrantLock对象 可以同时 绑定多个Condition对象，<br>而在 synchronized中， 锁对象 的 wait()和notify()或notifyAll()方法 可以实现一个 隐含的条件，<br>如果要和 多于一个的条件关联的时候， 就不得不 额外地添加一个锁，<br>而 ReentrantLock 则无需这样做，只需要 多次调用 newCondition()方法 即可。</p>
<p>如果需要使用上述功能，选用 ReentrantLock 是一个很好的选择，<br>那如果 是基于 性能考虑呢？<br>关于 synchronized和ReentrantLock 的 性能问题，<br>Brian Goetz对这两种锁在 JDK1.5与单核处理器，以及 JDK1.5与双Xeon处理器 环境下做了一组 吞吐量对比的实验，实验结果如图13-1和图13-2所示。</p>
<blockquote>
<p>本例中的数据及图片来源于 Brian Goetz 为 IBM developerWorks 撰写的论文：《Java theory and practice:More flexible, scalable locking in JDK5.0》，<br>原文地址是：<code>http://www.ibm.com/developerworks/java/library/j-jtp10264/?S_TACT= 105AGX53&amp;S_CMP=cn-a-j</code>。</p>
</blockquote>
<p>（该链接有效，但是，我看的很是艰难😭😭😭😭救救这苦命的孩子吧，就像当初接入paypal支付🙃🙃🙃🙃）</p>
<p>从图13-1和图13-2可以看出，<br>多线程环境下 synchronized的吞吐量下降得 非常严重，<br>而 ReentrantLock 则能基本保持在同一个 比较稳定的水平 上。</p>
<p>与其说 ReentrantLock 性能好，还不如说 synchronized 还有非常大的优化余地。</p>
<p>后续的技术发展也证明了这一点，JDK1.6中加入了很多针对 锁的优化措施（13.3节我们就会讲解这些 优化措施），<br>JDK1.6发布之后，人们就发现 synchronized与ReentrantLock 的 性能 基本上是 完全持平 了。</p>
<p>因此，如果读者的程序 是使用 JDK1.6 或以上 部署 的话，<br>性能因素 就不再是 选择ReentrantLock 的理由了，<br>虚拟机 在 未来的性能改进中 肯定也会更加偏向于 原生的synchronized，<br>所以还是提倡在 synchronized 能实现需求的情况下，优先考虑使用 synchronized 来进行 同步。</p>
<h6 id="2-非阻塞同步"><a href="#2-非阻塞同步" class="headerlink" title="2.非阻塞同步"></a>2.非阻塞同步</h6><p>互斥同步 最主要的问题 就是 进行线程 阻塞和唤醒 所带来的的 性能问题，<br>因此这种 同步也称为 阻塞同步（Blocking Synchronization）。</p>
<p>从 处理问题的方式 上说，<br>互斥同步 属于一种 悲观的 并发策略，总是认为 只要不去做 正确的 同步措施（例如加锁），那就肯定会出现问题，<br>无论 共享数据 是否真的会出现竞争，它都要 进行加锁<br>（这里讨论的是 概念模型，实际上 虚拟机 会优化很大一部分 不必要的 加锁）、<br>用户态和心态转换、维护锁计数器 和 检查 是否有 被阻塞的线程 需要唤醒 等操作。</p>
<p>（这也就是所谓的 总有刁民想害朕 了）</p>
<p>随着 硬件指令集 的发展，我们有了另外一个选择：基于 冲突检测 的 乐观并发策略，<br>通俗地说，就是先进行操作，<br>如果没有其他线程 争用共享数据，那操作就成功了；<br>如果 共享数据 有争用，产生了 冲突，那就再采取其他的 补偿措施（最常见的补偿措施就是 不断地重试，直到成功为止），<br>这种 乐观的并发策略 的许多实现 都不需要把 线程挂起，因此这种 同步操作 称为 非阻塞同步（Non-Blocking Synchronization）。</p>
<p>为什么笔者说使用 乐观并发策略 需要 “硬件指令集的发展” 才能进行呢？</p>
<p>因为我们需要 操作和冲突检测 这两个步骤 具备 原子性，靠什么来保证呢？</p>
<p>如果这里 再使用 互斥同步 来保证就失去意义了，所以我们只能靠 硬件 来完成这件事情，<br>硬件 保证一个从 语义 上看起来需要多次操作的性能 只通过 一条处理器指令 就能完成，这类指令常用的有：</p>
<p>(我大概一辈子也用不到这些个东西)</p>
<ul>
<li>测试并设置（Test-and-Set）</li>
<li>获取并增加（Fetch-and-Increment）</li>
<li>交换（Swap）</li>
<li>比较并交换（Compare-and-Swap，下文称 CAS）</li>
<li>加载链接/条件存储（Load-Linked/Store-Conditional，下文称LL/SC）</li>
</ul>
<p>(但是还是得努力去试试。不怕一万就怕万一。)</p>
<p>其中，前面的3条 是20世纪就已经存在于 大多数指令集之中的 处理器指令，</p>
<p>后面的两条是 现代处理器 新增的，而且这两条指令的 目的和功能 是类似的。</p>
<p>在 IA64、x86 指令集 中有 cmpxchg指令 完成 CAS功能，<br>在 sparc-TSO 也有 casa指令 实现，而在 ARM 和 PowerPC 架构下，则需要使用 一对 ldrex/strex 指令 来完成 LL/SC 的功能。</p>
<p>CAS指令 需要有3个操作数，分别是 内存位置（在Java中可以简单理解为 变量的内存地址，用V表示）、旧的预期值（用A表示）和新值（用B表示）。</p>
<p>CAS指令 执行时，当且仅当 V 符合 旧预期值A 时，处理器 用 新值B 更新 V的值，否则它就不执行更新，<br>但是无论 是否更新了 V的值，都会返回 V的旧值，上述的处理过程是一个 原子操作。</p>
<p>在 JDK1.5 之后，Java程序 中才可以使用 CAS 操作，<br>该操作由 sun.misc.Unsafe类 里面的 compareAndSwapInt() 和 compareAndSwapLong() 等几个方法包装提供，<br>虚拟机 在 内部 对这些方法做了特殊处理，<br>即时编译出来的结果 就是一条 平台相关的 处理器CAS指令，没有方法调用的过程，或者可以认为是无条件 内联 进去了。</p>
<blockquote>
<p>这种被 虚拟机 特殊处理 的方法称为 固有函数（Intrinsics），类似的 固有函数 还有Math.sin()等。</p>
</blockquote>
<p>由于 Unsafe类 不是提供给 用户程序 调用的类（Unsafe.getUnsafe()的代码中 限制了只有 启动类加载器（Bootstrap ClassLoader） 加载的Class 才能访问它），<br>因此，如果不采用 反射手段 ， 我们只能通过其他的 Java API来间接使用它，如 J.U.C包 里面的 整数原子类，其中的 compareAndSet()和getAndIncrement() 等方法都是用了 Unsafe类 的 CAS操作。</p>
<p>我们不妨拿一段在第12章中没有解决的问题代码来看看 如何使用CAS操作来避免阻塞同步 ，代码如代码清单12-1所示。</p>
<p>我们曾经通过这段20个线程 自增10000次 的代码来证明 volatile变量不具备原子性，那么如何才能让它 具备原子性 呢？</p>
<p>把 “race++”操作或increase() 方法用 同步块 包裹起来当然是一个办法，但是如果改成如代码清单13-4所示的代码，那效率将会提高许多。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">                                代码清单 <span class="number">13</span><span class="number">-4</span> Atomic的原子自增运算</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Atomic 变量自增运算测试</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * @author zzm</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicTest</span>&#123;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AtomicInteger race = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">increase</span><span class="params">()</span></span>&#123;</span><br><span class="line">      race.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> THREADS_COUNT = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">String</span>[] args)</span> throws Exception</span>&#123;</span><br><span class="line">      Thread[] threads = <span class="keyword">new</span> Thread[THREADS_COUNT];</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; THREADS_COUNT; i++)&#123;</span><br><span class="line">        threads[i] = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;</span><br><span class="line">          @Override</span><br><span class="line">          <span class="keyword">public</span> <span class="keyword">void</span> <span class="built_in">run</span>()&#123;</span><br><span class="line">            <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; THREADS_COUNT; i++)&#123;</span><br><span class="line">              increase();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        threads[i].start();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span>(Thread.activeCount() &gt; <span class="number">1</span>)</span><br><span class="line">          thread.<span class="built_in">yield</span>();</span><br><span class="line"></span><br><span class="line">      System.out.<span class="built_in">println</span>(race);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<p>200000</p>
<p>使用 AtomicInteger 代替 int 后，程序输出了正确的结果，<br>一切都要归功于 incrementAndGet()方法 的 原子性。<br>它的实现 其实非常 简单，如代码清单13-5所示。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">                                代码清单 13-5 incrementAndGet()方法的JDK源码</span></span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line">/*<span class="strong">*</span></span><br><span class="line"><span class="strong">  *</span> Atomically  increment by one the current value.</span><br><span class="line"><span class="code">  * @return the updated value</span></span><br><span class="line"><span class="code">  */</span></span><br><span class="line"><span class="code">  public final int incrementAndGet()&#123;</span></span><br><span class="line"><span class="code">    for(;;)&#123;</span></span><br><span class="line"><span class="code">      int current = get();</span></span><br><span class="line"><span class="code">      int next = current + 1;</span></span><br><span class="line"><span class="code">      if(compareAndSet(current, next))&#123;</span></span><br><span class="line"><span class="code">        return next;</span></span><br><span class="line"><span class="code">      &#125;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">  &#125;</span></span><br><span class="line">----------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>incrementAndGet()方法 在一个 无限循环 中，<br>不断尝试 将一个比当前值 大1的新值 赋值给自己。<br>如果失败了，那说明在执行 “获取-设置” 操作的时候 值已经有了修改，<br>于是 再次循环 进行下一次操作，直到设置成功为止。</p>
<p>尽管 CAS 看起来很美，但显然这种操作无法涵盖 互斥同步的所有使用场景，<br>并且 CAS 从语义上来说 并不是完美的，存在这样一个 逻辑漏洞：<br>如果一个 变量V 初次读取的时候是 A值，<br>并且在准备赋值的时候 检查到它仍然为A值，<br>那我们就能说它的值 没有被其他线程改变过了吗？<br>如果在这段期间 它的值曾经被改成了B， 后来又被改回A，<br>那 CAS操作 就会误认为它 从来没有被改变过。</p>
<p>这个 漏洞 称为 CAS操作 的 “ABA问题”。</p>
<p>J.U.C包 为了解决这个问题，提供了一个带有标记的 原子引用类“AtomicStampedReference”，<br>它可以通过控制 变量值的版本 来保证 CAS的正确性。</p>
<p>不过目前来说这个类 比较“鸡肋”，大部分情况下 ABA问题 不会影响 程序并发的正确性，<br>如果需要 解决ABA问题，改用传统的 互斥同步 可能会比 原子类更高效。</p>
<h6 id="3-无同步方案"><a href="#3-无同步方案" class="headerlink" title="3.无同步方案"></a>3.无同步方案</h6><p>要保证 线程安全，并不是一定就要进行 同步，两者没有 因果关系。</p>
<p>同步 只是保证 共享数据争用时的正确性 的手段，<br>如果一个方法 本来就不涉及 共享数据，<br>那它自然就无需 任何同步措施 去保证 正确性，<br>因此会有一些代码天生就是 线程安全的，笔者简单地介绍其中的两类。</p>
<p><strong>可重入代码（Reentrant Code）</strong>:<br>这种代码也叫做 纯代码（Pure Code），<br>可以在 代码执行的任何时刻 中断它，<br>转而去 执行另外一段代码（包括 递归调用它本身），<br>而在 控制权 返回后，<br>原来的程序 不会出现任何错误。</p>
<p>相对 线程安全 来说，<br>可重入性 是更基本的特性，<br>它可以保证 线程安全，<br>即所有的 可重入 的代码都是 线程安全的，<br>但是并非所有的 线程安全 的代码都是 可重入的。</p>
<p>可重入代码 有一些 共同的特征，<br>例如 不依赖存储在堆上的数据 和 公用的系统资源、用到的状态量 都由参数中传入、不调用非可重入的方法等。</p>
<p>我们可以通过一个简单的原则来判断 代码是否具备可重入性：<br>如果一个方法，它的返回结果是可以 预测的，只要输入了相同的数据，就都能返回相同的结果，那它就满足 可重入性 的要求，当然也就是 线程安全的。</p>
<p><strong>线程本地存储（Thread Local Storage）</strong>:<br>如果一段代码中 所需要的数据 必须与 其他代码 共享，<br>那就看看这些 共享数据的代码 是否能保证 在同一个线程中 执行？<br>如果能保证，我们就可以把 共享数据的可见范围 限制在 同一个线程之内，<br>这样，无须 同步  也能保证 线程之间 不出现 数据争用 的问题。</p>
<p>符合这种特点的应用并不少见，<br>大部分使用 消费队列的架构模式（如“生产者-消费者”模式）都会将 产品的消费过程 尽量在 一个线程中 消费完，<br>其中最重要的一个应用实例就是 经典Web交互模型 中的 “一个请求对应一个服务器线程”（Thread-per-Request） 的处理方式，<br>这种 处理方式的广泛应用 使得很多 Web服务端应用 都可以使用 线程本地存储 来解决 线程安全问题。</p>
<p>Java语言中，<br>如果 一个变量 要被 多线程 访问，可以使用 volatile关键字 声明它为 “易变的”；<br>如果 一个变量 要被 某个线程 独享，Java中就没有类似C++中 __declspec(thread)这样的关键字，<br>不过还是可以通过 java.lang.ThreadLocal类 来实现 线程本地存储 的功能。</p>
<blockquote>
<p>在 Visual C++ 中是 “<strong>declspec(thread)”关键字，而在 GCC 中是“</strong>thread”。</p>
</blockquote>
<p>每一个线程的 Thread对象中都有一个 ThreadLocalMap对象，<br>这个对象 存储了一组 以 ThreadLocal.threadLocalHashCode 为 键 ，以 本地线程变量 为 值 的 K-V值对，<br>ThreadLocal对象 就是 当前线程的ThreadLocalMap的 访问入口，<br>每一个 ThreadLocal对象 都包含了 一个独一无二的 threadLocalHashCode值，<br>使用这个值 就可以在线程 K-V值对 中找回 对应的本地线程变量。</p>
<h4 id="锁优化"><a href="#锁优化" class="headerlink" title="锁优化"></a>锁优化</h4><p>高效并发 是从 JDK1.5到JDK1.6的一个 重要改进，<br>HotSpot虚拟机 开发团队在这个版本上花费了大量的精力去实现 各种锁优化技术，<br>如 适应性自旋（Adaptive Spinning）、锁消除（Lock Elimination）、锁粗化（Lock Coarsening）、轻量级锁（Lightweight Locking）和偏向锁（Biased Locking）等，<br>这些技术都是为了 在线程之间 更高效地 共享数据，<br>以及 解决竞争问题，<br>从而 提高程序的执行效率。</p>
<h5 id="自旋锁与自适应自旋"><a href="#自旋锁与自适应自旋" class="headerlink" title="自旋锁与自适应自旋"></a>自旋锁与自适应自旋</h5><p>前面我们讨论 互斥同步 的时候，<br>提到了 互斥同步 对性能最大的影响 是阻塞的实现，<br>挂起线程 和 恢复线程 的操作都需要 转入内核态 中完成，<br>这些操作给系统的 并发性能 带来了很大的压力。</p>
<p>同时，虚拟机 的开发团队也注意到在许多应用上，<br>共享数据的锁定状态 只会持续很短的一段时间，<br>为了这段时间 去挂起和恢复线程 并不值得。</p>
<p>如果 物理机器 有一个以上的 处理器，<br>能让 两个或两个以上的线程 同时并行执行，<br>我们就可以让  后面请求锁的那个线程 “稍等一下”，<br>但不放弃 处理器的执行时间，<br>看看 持有锁的线程 是否很快就会释放锁。</p>
<p>为了让线程等待，我们只需让 线程执行一个忙循环（自旋），这项技术就是所谓的 自旋锁。</p>
<p>自旋锁 在 JDK1.4.2 中就已经引入，<br>只不过 默认 是 关闭的，<br>可以使用 -XX:+UseSpinning 参数来开启，<br>在 JDK1.6 中就已经改为 默认开启了。</p>
<p>自旋等待 不能代替 阻塞，<br>且先不说对 处理器数量的要求，<br>自旋等待 本身虽然 避免了线程切换的开销，<br>但它是要 占用处理器时间的，<br>因此，如果 锁 被占用的时间 很短，自旋等待 的 效果就会非常好，<br>反之，如果 锁 被占用的时间 很长，那么 自旋的线程 只会 白白消耗处理器资源，<br>而不会做 任何有用的工作，<br>反而会带来 性能上的浪费。</p>
<p>因此，自旋等待的时间 必须要有 一定的限度，<br>如果 自旋超过了限定的次数 仍然没有 成功获得锁，<br>就应当使用 传统的方式 去挂起线程了。</p>
<p>自旋次数 的 默认值 是 10次，用户可以使用参数-XX:PreBlockSpin 来更改。</p>
<p>在 JDK1.6 中引入了 自适应的自旋锁。</p>
<p>自适应 意味着 自旋的时间 不再固定了，<br>而是由 前一次在同一个锁上的自旋时间 及 锁的拥有者的状态 来决定。</p>
<p>如果在 同一个锁对象上，<br>自旋等待 刚刚成功获得过锁，并且 持有锁的线程 正在运行中，<br>那么 虚拟机 就会认为 这次自旋 也很有可能再次成功，<br>进而它将 允许 自旋等待 持续相对更长的时间，比如100个循环。</p>
<p>另外，如果 对于某个锁，自旋 很少成功获得过，<br>随着 程序运行和性能监控信息 的 不断完善，<br>虚拟机 对 程序锁 的 状况预测 就会越来越准确，<br>虚拟机 就会变得 越来越“聪明”了。</p>
<h5 id="锁消除"><a href="#锁消除" class="headerlink" title="锁消除"></a>锁消除</h5><p>锁消除 是指 虚拟机 即时编译器 在运行时，<br>对一些代码上 要求 同步，但是被检测到 不可能存在共享数据竞争的锁 进行 消除。</p>
<p>锁消除 的 主要判定依据 来源于 逃逸分析 的 数据支持（第11章已经讲解过 逃逸分析技术），<br>如果判断 在一段代码中，堆 上的所有 数据 都不会 逃逸出去 从而被 其他的线程访问到，<br>那就可以把它们当做 堆上数据对待，<br>认为它们是 线程私有的，同步加锁 自然也就无须运行。</p>
<p>也许读者会有疑问， 变量 是否逃逸，<br>对于 虚拟机 来说需要使用 数据流分析 来确定，<br>但是程序员自己应该时很清楚的，怎么会在 明知道不存在数据争用的情况下 要求同步呢？<br>答案是有许多 同步措施 并不是程序员自己加的，<br>同步的代码 在java程序中的 普遍程度 也许超过了大部分读者的想象。</p>
<p>我们来看看代码清单13-6中的例子，这段非常简单的代码 仅仅是输出3个字符串相加的结果，<br>无论是 源码字面上 还是 程序语义上 都没有同步。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">                                代码清单 13-6 一段看起来没有同步的代码</span></span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line">public String concatString(String s1,String s2,String s3)&#123;</span><br><span class="line"><span class="code">  return s1+s2+s3;</span></span><br><span class="line">&#125;</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>我们也知道，<br>由于 String是一个不可变的类，对字符串的连接操作 总是通过生成 新的String对象 来进行的，<br>因此 Javac编译器 会对 String连接 做 自动优化。</p>
<p>在 JDK1.5 之前，会转化为 StringBuffer对象的连续append()操作，<br>在 JDK1.5及以后的版本中，会转为 StringBuilder对象的连续append()操作，<br>即代码清单13-6中的代码 可能会变成代码清单 13-7的样子。</p>
<blockquote>
<p>客观地说，既然谈到 锁消除与逃逸分析，那 虚拟机 就不可能是 JDK1.5之前的版本，实际上会转化为 非线程安全的StringBuilder 来完成字符串拼接，并不会加锁， 但这也不影响笔者用这个例子证明 Java对象中同步的普遍性。</p>
</blockquote>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">                                代码清单 13-7 Javac转化后的字符串连接操作</span></span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line">public String concatString(String s1,String s2,String s3)&#123;</span><br><span class="line"><span class="code">  StringBuffer sb = new StringBuffer();</span></span><br><span class="line"><span class="code">  sb.append(s1);</span></span><br><span class="line"><span class="code">  sb.append(s2);</span></span><br><span class="line"><span class="code">  sb.append(s3);</span></span><br><span class="line"><span class="code">  return sb.toString();</span></span><br><span class="line">&#125;</span><br><span class="line">----------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>现在大家还认为这段代码没有涉及同步吗？<br>每个 StringBuffer.append() 方法中都有一个 同步块，锁就是sb对象。<br>虚拟机 观察 变量sb，很快就会发现它的 动态作用域 被限制在 concatString()方法内部。</p>
<p>也就是说，sb的所有引用 永远不会 “逃逸” 到 concatString() 方法之外，<br>其他线程 无法访问 到 它，<br>因此，虽然这里有锁，但是可以被 安全地消除掉，<br>在 即时编译 之后，这段代码就会忽略掉 所有的同步块 而直接执行了。</p>
<h5 id="锁粗化"><a href="#锁粗化" class="headerlink" title="锁粗化"></a>锁粗化</h5><p>原则上，我们在编写代码的时候，总是推荐将 同步块的作用范围 限制得 尽量小——只在 共享数据的实际作用域 中才进行同步，<br>这样是为了 使得需要 同步的操作数量 尽可能 变小，<br>如果存在 锁竞争，那等待 锁的线程 也能尽快拿到锁。</p>
<p>大部分情况下，上面的原则都是正确的，<br>但是如果 一系列的连续的动作 都对 同一个对象 反复加锁和解锁，<br>甚至 加锁操作 是出现在 循环体中的，<br>那即是没有 线程竞争，频繁地进行互斥同步操作 也会导致 不必要的性能损耗。</p>
<p>代码清单13-7中 连续的append()方法就属于这类情况。</p>
<p>如果 虚拟机 探测到有这样 一串零碎的操作 都对 同一个对象加锁，<br>将会把 加锁同步的范围 扩展（粗化）到 整个操作序列的外部，<br>以代码清单13-7为例，就是扩展到第一个append()操作之前 直至 最后一个append()操作之后，<br>这样只需要 加锁一次 就可以了。</p>
<h5 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h5><p>轻量级锁 是 JDK1.6之中 加入的 新型锁机制，<br>它名字中的 “轻量级” 是 相对于 使用 操作系统互斥量来实现的传统锁 而言的，<br>因此 传统的锁机制 就称为 “重量级”锁。</p>
<p>首先需要强调的一点是， 轻量级锁 并不是用来 代替 重量级锁 的，<br>它的本意 是在 没有多线程竞争的前提下，<br>减少 传统的重量级锁 使用 操作系统互斥量 产生的性能消耗。</p>
<p>要理解 轻量级锁，<br>以及后面会讲到的 偏向锁的原理和运作过程，<br>必须从 HotSpot虚拟机的对象（对象头部分）的内存布局开始介绍。</p>
<p>HotSpot虚拟机的对象头（Object Header）分为两部分信息，<br>第一部分 用于存储 对象自身的 运行时数据，如哈希码（HashCode）、GC分代年龄（Generational GC Age）等，<br>这部分数据的长度 在32位和64位的 虚拟机中 分别为 32bit和64bit，官方称它为 “Mark Word”，<br>它是 实现轻量级锁 和 偏向锁 的 关键。</p>
<p>另一部分 用于存储 指向方法区对象 类型数据的指针，<br>如果是数组对象的话，还会有一个额外的部分 用于存储 数组长度。</p>
<p>对象头信息 是与 对象自身定义的 数据无关的 额外存储成本，<br>考虑到 虚拟机的空间效率，<br>Mark Word 被设计成一个 非固定的数据结构 以便在 极小的空间内 存储尽量多的信息，<br>它会根据对象的状态 复用 自己的 存储空间。</p>
<p>例如，在32位的HotSpot虚拟机中 对象未被锁定的状态下，<br>Mark Word的 32bit空间的 25bit 用于存储 对象哈希码（HashCode），<br>4bit 用于存储 对象分代年龄，<br>2bit 用于存储 锁标志位，<br>1bit 固定为 0，<br>在其他状态（轻量级锁定、重量级锁定、GC标记、可偏向）下 对象的存储内容 见表13-1。</p>
<table>
  <thead>
    <tr>
      <th colspan="2">表 13-1 HotSpot虚拟机对象头 Mark Word</th>
    </tr>
  </thead>
  <tr>
    <th>存储内容</th>
    <th>标志位</th>
    <th>状态</th>
  </tr>
  <tr>
    <td>对象哈希码、对象分代年龄</td>
    <td>01</td>
    <td>未锁定</td>
  </tr>
    <tr>
    <td>指向锁记录的指针</td>
    <td>00</td>
    <td>轻量级锁定</td>
  </tr>
    <tr>
    <td>指向重量级锁的指针</td>
    <td>10</td>
    <td>膨胀（重量级锁定）</td>
  </tr>
   <tr>
    <td>空，不需要记录信息</td>
    <td>11</td>
    <td>GC标记</td>
  </tr>
   <tr>
    <td>偏向线程ID、偏向时间戳、对象分代年龄</td>
    <td>01</td>
    <td>可偏向</td>
  </tr>
</table>

<p>简单地介绍了 对象的内存布局 后，<br>我们把话题返回到 轻量级锁的执行过程上。</p>
<p>在代码进入 同步块 的时候，<br>如果此 同步对象 没有被 锁定（锁标志位 为“01”状态），<br>虚拟机 首先将 在当前线程的 栈帧 中 建立一个名为 锁记录（Lock Record）的空间，<br>用于存储 锁对象目前的Mark Word的拷贝<br>（官方把这份拷贝加了一个 Displaced前缀，即 Displaced Mark Word），<br>这时候 线程堆栈 与 对象头的状态 如图13-3所示。</p>
<p>然后，<br>虚拟机 将使用 CAS操作 尝试将 对象的Mark Word 更新为指向 Lock Record的指针。</p>
<p>如果这个更新动作 成功了，那么这个线程 就拥有了 该对象的锁，<br>并且 对象Mark Word 的 锁标志位（Mark Word的最后2bit）将转变为“00”，<br>即表示此对象处于 轻量级锁定状态，<br>这时候 线程堆栈与对象头的状态 如图13-4所示。</p>
<blockquote>
<p>图13-3和图13-4来源于 HotSpot虚拟机的一位Senior Staff Engineer——Paul Hohensee所写的PPT “The Hotspot Java Virtual Machine”。</p>
</blockquote>
<p>如果这个更新动作 失败了，虚拟机 首先会检查 对象的Mark Word 是否指向 当前线程的栈帧，<br>如果只说明 当前线程已经拥有了这个对象的锁，那就可以直接 进入同步块 继续执行，<br>否则说明 这个锁对象 已经被其他线程 抢占了。</p>
<p>如果有两条以上的 线程 争用同一个锁，<br>那 轻量级锁 就不再有效，要 膨胀 为 重量级锁，<br>锁标志 的 状态值 变为 “10“，<br>Mark Word中存储的 就是指向 重量级锁（互斥量）的指针，<br>后面 等待锁的线程 也要进入 阻塞状态。</p>
<p>上面描述的是 轻量级锁的枷锁过程，<br>它的 解锁过程 也是通过 CAS操作来进行的，<br>如果 对象的Mark Word 仍然指向这 线程的锁记录，<br>那就用 CAS操作 把 对象的Mark Word 和 线程中复制的Displaced Mark Word替换回来，<br>如果替换成功，整个同步过程就完成了。<br>如果替换失败，说明有其他线程 尝试过获取该锁，那就要在释放锁的同时，唤醒被挂起的线程。</p>
<p>轻量级锁 能提升 程序同步性能 的依据是 “对于绝大部分的锁，在整个同步周期内都是不存在竞争的”，<br>这是一个经验数据。</p>
<p>如果没有竞争，轻量级锁使用 CAS操作 避免了使用 互斥量的开销，<br>但如果存在 锁竞争，除了互斥量的开销以外，还额外发生了 CAS操作，<br>因此在 有竞争的情况下， 轻量级锁 会比 传统的重量级锁 更慢。</p>
<h5 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h5><p>偏向锁 也是 JDK1.6 中引入的一项 锁优化，<br>它的目的是 消除数据在无竞争情况下的同步原语，进一步提高程序的运行性能。</p>
<p>如果说 轻量级锁 是在 无竞争的情况下 使用 CAS操作 去 消除同步使用的互斥量，<br>那 偏向锁 就是在 无竞争的情况下 想把 整个同步都消除掉，连CAS操作都不做了。</p>
<p>偏向锁的 “偏”，就是偏心的“偏”、偏袒的“偏”，<br>它的意思是 这个锁 会偏向于 第一个 获得它的线程，<br>如果在接下来的执行过程中，该锁 没有被其他的 线程获取，则持有 偏向锁的 线程 将永远不需要再进行 同步。</p>
<p>如果读者读懂了前面 轻量级锁 中 关于对象头Mark Word与线程之间 的 操作过程，<br>那 偏向锁的原理 理解起来就会很简单。</p>
<p>假设当前 虚拟机 启用了 偏向锁（启用参数 -XX:+UseBiasedLocking，这是 JDK1.6的默认值），<br>那么，当 锁对象 第一次 被线程获取的时候，虚拟机 将会把 对象头中的 标志位 设为 “01”，即偏向模式。</p>
<p>如果使用 CAS操作 把 获取到这个锁的线程的ID 记录在 对象的Mark Word之中，<br>如果 CAS操作 成功<br>持有 偏向锁的线程 以后每次进入这个锁 相关的同步块时，虚拟机都可以不再进行 任何同步操作<br>（例如 LOcking、Unlocking 及对 Mark Word的Update 等）。</p>
<p>当有 另外一个线程 去尝试 获取这个锁时，<br>偏向模式 就 宣告结束。</p>
<p>根据 锁对象 目前是否处于 被锁定 的状态，<br>撤销 偏向（Revoke Bias）后 恢复到 未锁定（标志位为 “01”） 或 轻量级锁定（标志位为“00”）的状态，<br>后续的同步操作 就如上面介绍的 轻量级锁那样执行。</p>
<p>偏向锁、轻量级锁的状态转化 及 对象的Mark Word的关系如图13-5 所示。</p>
<p>偏向锁 可以提高 带有 同步 但 无竞争的 程序性能。</p>
<p>它同样是一个带有 效益权衡（Trade Off）性质的优化，<br>也就是说，它并不一定总是对 程序运行 有利，<br>如果 程序中大多数的锁 总是被 多个不同的线程 访问，<br>那 偏向模式就是多余的。</p>
<p>在具体问题具体分析的前提下，有时候使用参数 -XX:-UseBiasedLocking 来 禁止偏向锁优化 反而可以 提升性能。</p>
<h4 id="本章小结"><a href="#本章小结" class="headerlink" title="本章小结"></a>本章小结</h4><p>本章介绍了 线程安全 所涉及的 概念和分类、同步实现的方式 及 虚拟机的底层运作原理，<br>并且介绍了 虚拟机 为了实现高效并发 所采取的的 一系列 锁优化措施。</p>
<p>许多资深的程序员都说过，能够写出 高伸缩性的并发程序 是一门艺术，<br>而 了解并发 在系统底层 是如何实现的，则是 掌握这门艺术的 前提条件，<br>也是成长为 高级程序员的必备知识之一。</p>

      
    </div>
    
    
    



<div>
    
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script type="text/javascript" src="http://jslibs.wuxubj.cn/sweetalert_mini/jquery-1.7.1.min.js"></script>
  <script src="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.min.js"></script>
  <link rel="stylesheet" type="text/css" href="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.mini.css">

  <p><span>本文标题:</span>深入理解java虚拟机-线程安全与锁优化📝</a></p>
  <p><span>文章作者:</span>✨🧙‍♀️✨</a></p>
  <p><span>发布时间:</span>2020年05月26日 - 22:41:37🌞</p>
  <p><span>最后更新:</span>2020年06月06日 - 02:26:39🌜</p>
  <p><span>原始链接:</span><a href="/2020/05/26/%E3%80%90%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JAVA%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%91/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JAVA%E8%99%9A%E6%8B%9F%E6%9C%BA13/" title="深入理解java虚拟机-线程安全与锁优化">https://fengshana.github.io/2020/05/26/%E3%80%90%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JAVA%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%91/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JAVA%E8%99%9A%E6%8B%9F%E6%9C%BA13/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://fengshana.github.io/2020/05/26/%E3%80%90%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JAVA%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%91/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JAVA%E8%99%9A%E6%8B%9F%E6%9C%BA13/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。🎄	</p>  
</div>
<style>
</style>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    clipboard.on('success', $(function(){
      $(".fa-clipboard").click(function(){
        //swal({   
          //title: "",   
         // text: '<div style="width:300px;height:100px;font-size:14px;">道友，复制成功了哟(＾Ｕ＾)ノ~</div>',   
          //html: true,
          //timer: 500,   
        //showConfirmButton: false
        //});
      });
      new ClipboardJS('.fa-clipboard', {
          target: function(trigger) {
              $('<div>').appendTo('body').addClass('alert alert-success').html('🤠道友ᕦ(･ㅂ･)ᕤ，🥭复制成功了哟(^_−)☆').show().delay(1500).fadeOut();
              return trigger.nextElementSibling;
            }
      });
    }));  
</script>


    
</div>



    








<div>
  
    <div>
    
        <br/>
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------🍓🍇本文结束🤞感谢道友的阅读🍍🍒-------------</div>
    
</div>
  
</div>












    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>🥕🍆坚持原创技术分享🐳，🌽🥬您的支持将鼓励我继续创作！🐬</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatreward.png" alt="✨🧙‍♀️✨ 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipayreward.png" alt="✨🧙‍♀️✨ 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    










    <footer class="post-footer">
      
        <div class="post-tags" style="text-align:center">
          
            <a href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">🌟面试</i></a>
          
            <a href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" rel="tag">🌟虚拟机</i></a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/26/%E3%80%90%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JAVA%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%91/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3JAVA%E8%99%9A%E6%8B%9F%E6%9C%BA12/" rel="next" title="深入理解Java虚拟机-Java内存模型与线程">
                👈 深入理解Java虚拟机-Java内存模型与线程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/05/27/%E3%80%90%E5%91%A8%E5%BD%A4%E5%BD%A4%E3%80%91/%E3%80%90%E5%91%A8%E5%BD%A4%E5%BD%A4%E3%80%91%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%E6%94%B9%E8%BF%9B3/" rel="prev" title="前端页面双色球3">
                前端页面双色球3 👉
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80ODk3My8yNTQ2Nw=="></div>
    </div>

  
  
  

  
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/fsn.jpg"
                alt="✨🧙‍♀️✨" />
            
              <p class="site-author-name" itemprop="name">✨🧙‍♀️✨</p>
              <p class="site-description motion-element" itemprop="description">🌈勿忘初心💫 🌞，🌜方得始终⭐</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <!--<a href="/archives/%7C%7Carchive">-->
                <a href="/archives/">
              
                  <span class="site-state-item-count">155</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">84</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/fengshana" target="_blank" title="GitHub">
                      
                        <i 
                          
                          class="fa fa-fw fa-github">
                           
                        </i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://space.bilibili.com/475144966" target="_blank" title="Bilibili">
                      
                        <i 
                          
                            class="">💜
                           
                        </i>Bilibili</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://user.qzone.qq.com/2915324940" target="_blank" title="QQ">
                      
                        <i 
                          
                            class="">🧡
                           
                        </i>QQ</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://user.qzone.qq.com/198866436" target="_blank" title="QQ2">
                      
                        <i 
                          
                            class="">💙
                           
                        </i>QQ2</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://gracg.com/user/user15472vJMQiV" target="_blank" title="Gracg">
                      
                        <i 
                          
                            class="">💚
                           
                        </i>Gracg</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://gongzifengyue.gitee.io/fengshana.io" target="_blank" title="Gitee">
                      
                        <i 
                          
                            class="">💛
                           
                        </i>Gitee</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title" style="color:white;">
                <i class="fa  fa-fw fa-link"></i>
                友情链接💦
              </div>
			  
			  
			  
			  
			  
			  
			  
			  
                

				  <span class="links-of-blogroll-item">
                    <a href="http://ruiyeclub.cn" title="chenrui" target="_blank">chenrui</a>
					 </span>
                

                
				
				
			  
			  
			  
			  
			  
			  
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#深入java虚拟机-第五部分-高效并发"><span class="nav-number">1.</span> <span class="nav-text">深入java虚拟机-第五部分-高效并发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#第13章-线程安全与锁优化"><span class="nav-number">1.1.</span> <span class="nav-text">第13章 线程安全与锁优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述"><span class="nav-number">1.1.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#线程安全"><span class="nav-number">1.1.2.</span> <span class="nav-text">线程安全</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Java语言中的线程安全"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">Java语言中的线程安全</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-不可变"><span class="nav-number">1.1.2.1.1.</span> <span class="nav-text">1.不可变</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-绝对线程安全"><span class="nav-number">1.1.2.1.2.</span> <span class="nav-text">2.绝对线程安全</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-相对线程安全"><span class="nav-number">1.1.2.1.3.</span> <span class="nav-text">3.相对线程安全</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-线程兼容"><span class="nav-number">1.1.2.1.4.</span> <span class="nav-text">4.线程兼容</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-线程对立"><span class="nav-number">1.1.2.1.5.</span> <span class="nav-text">5.线程对立</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#线程安全的实现方法"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">线程安全的实现方法</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-互斥同步"><span class="nav-number">1.1.2.2.1.</span> <span class="nav-text">1.互斥同步</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-非阻塞同步"><span class="nav-number">1.1.2.2.2.</span> <span class="nav-text">2.非阻塞同步</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-无同步方案"><span class="nav-number">1.1.2.2.3.</span> <span class="nav-text">3.无同步方案</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#锁优化"><span class="nav-number">1.1.3.</span> <span class="nav-text">锁优化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#自旋锁与自适应自旋"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">自旋锁与自适应自旋</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#锁消除"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">锁消除</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#锁粗化"><span class="nav-number">1.1.3.3.</span> <span class="nav-text">锁粗化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#轻量级锁"><span class="nav-number">1.1.3.4.</span> <span class="nav-text">轻量级锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#偏向锁"><span class="nav-number">1.1.3.5.</span> <span class="nav-text">偏向锁</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#本章小结"><span class="nav-number">1.1.4.</span> <span class="nav-text">本章小结</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      


      


    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">🌱2019 🍄 🌳

<span itemprop="copyrightYear">2020</span>
  <span class="with-love">
  <!--user-->
    🍉
  </span>
 
 <span class="author" itemprop="copyrightHolder">Fsn✨🧙‍♀️✨</span>

  





  <script async src="http://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
 
     🏃‍♂️ 
    <span class="post-meta-item-icon">
      📈
    </span>
    
      <span class="post-meta-item-text">小屋💒总字数：</span>
    
	<span title="Site words total count">
     606.2k🌟 </span>
    <!--<span title="symbols_count_time.count_total">1.2m</span>-->
  
</div>



  <!-- <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>-->






<!--



 -->
 






        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-beta.2/lazyload.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  













  





  

  

  

  
  

  

  

  
  <script type="text/javascript" src="/js/src/exturl.js?v=5.1.4"></script>


  
  
  
  <!-- 
  
  -->
  <link rel="stylesheet" href="/dist/APlayer.min.css">
<div id="aplayer"></div>
<script type="text/javascript" src="/dist/APlayer.min.js"></script>
<script type="text/javascript" src="/dist/music.js"></script>

  <!-- 代码块复制功能    <script src="dist/clipboard.min.js"></script>-->
  <script type="text/javascript" src="/js/src/clipboard.min.js"></script>
  <script type="text/javascript" src="/js/src/clipboard-use.js"></script>
  


</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>

<!--崩溃欺骗 <script type="text/javascript" src="/js/src/crash_cheat.js"></script> -->




