<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<script>
	(function(){
		if(''){
			if (prompt('请输入文章密码','') !== ''){
				alert('密码错误！');
				history.back();
			}
		}
	})();
</script>









<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #A0A0A0; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #A0A0A0, 0 0 5px     #A0A0A0; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #A0A0A0;    /*上边框颜色*/
        border-left-color: #A0A0A0;    /*左边框颜色*/
    }
</style>

<meta name="theme-color" content="#222">










<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
    
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/fsn-16x16.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/fsn-32x32.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/fsn-16x16.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/fsn-16x16.ico?v=5.1.4" color="#222">





  <meta name="keywords" content="笔记,微服务,分布式,事务," />





  <link rel="alternate" href="/atom.xml" title="Fsn" type="application/atom+xml" />






<meta name="description" content="希望这句话不只是送给我，也送给那些跟我当时心境一样的人。   就像妈妈每次给我打电话的结尾是：要天天开开心心的。保持好心情。   一样。   观看笔记： https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1Q4411y7ip?from&#x3D;search&amp;seid&#x3D;11158504841670855744   相关的笔记截图放在QQ号为：198866436的空间相册当中了；">
<meta property="og:type" content="article">
<meta property="og:title" content="微服务架构的分布式事务控制解决方案">
<meta property="og:url" content="https://fengshana.github.io/2020/04/20/%E9%9D%A2%E8%AF%95/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/index.html">
<meta property="og:site_name" content="Fsn">
<meta property="og:description" content="希望这句话不只是送给我，也送给那些跟我当时心境一样的人。   就像妈妈每次给我打电话的结尾是：要天天开开心心的。保持好心情。   一样。   观看笔记： https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1Q4411y7ip?from&#x3D;search&amp;seid&#x3D;11158504841670855744   相关的笔记截图放在QQ号为：198866436的空间相册当中了；">
<meta property="og:image" content="http://r.photo.store.qq.com/psb?/V11rBmNJ3yquRc/uShdIwZAxDlL9sZe5T6UhvNayhmaRJkIgo1PjdVG8NY!/r/dDIBAAAAAAAA">
<meta property="article:published_time" content="2020-04-19T21:51:43.005Z">
<meta property="article:modified_time" content="2020-04-22T00:41:35.015Z">
<meta property="article:author" content="Fsn">
<meta property="article:tag" content="笔记">
<meta property="article:tag" content="微服务">
<meta property="article:tag" content="分布式">
<meta property="article:tag" content="事务">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://r.photo.store.qq.com/psb?/V11rBmNJ3yquRc/uShdIwZAxDlL9sZe5T6UhvNayhmaRJkIgo1PjdVG8NY!/r/dDIBAAAAAAAA">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://fengshana.github.io/2020/04/20/面试/微服务架构的分布式事务控制解决方案/"/>









  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "07d52b28"
    });
  daovoice('update');
  </script>

  <title>微服务架构的分布式事务控制解决方案 | Fsn</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2a839053bb6194637483460a0f428730";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.js"></script>
<script src="https://unpkg.com/minigrid@3.1.1/dist/minigrid.min.js"></script>
<link rel="stylesheet" href="/photos/photos.css">
<script type="text/javascript" src="/photos/photo.js"></script>


<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Fsn</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-camera">
          <a href="/photos/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-camera"></i> <br />
            
            相册
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sentence">
          <a href="/shuoshuo" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-commenting"></i> <br />
            
            小心情
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>







 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="poem-wrap">
  <div class="poem-border poem-left"></div>
  <div class="poem-border poem-right"></div>
    <h1>[诗酒年华]</h1>
    <p id="poem">挑选中...</p>
    <p id="info">

  <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
  <script type="text/javascript">
    jinrishici.load(function(result) {
      poem.innerHTML = result.data.content
      info.innerHTML = '【' + result.data.origin.dynasty + '】' + result.data.origin.author + '《' + result.data.origin.title + '》'
      document.getElementById("poem").value(poem);
      document.getElementById("info").value(info);  
  });
  </script>
</div>

        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fengshana.github.io/2020/04/20/%E9%9D%A2%E8%AF%95/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Fsn">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/fsn.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fsn">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">微服务架构的分布式事务控制解决方案</h1>
        

        <div class="post-meta">
		

          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-20T05:51:43+08:00">
                2020-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index">
                    <span itemprop="name">笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  21.4k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  74
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      
        <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
          
          
            <div class="post-gallery-row">
              <a class="post-gallery-img fancybox"
                 href="http://r.photo.store.qq.com/psb?/V11rBmNJ3yquRc/uShdIwZAxDlL9sZe5T6UhvNayhmaRJkIgo1PjdVG8NY!/r/dDIBAAAAAAAA" rel="gallery_cka442l8e00enakumf9qjhjuk"
                 itemscope itemtype="http://schema.org/ImageObject" itemprop="url">
                <img src="http://r.photo.store.qq.com/psb?/V11rBmNJ3yquRc/uShdIwZAxDlL9sZe5T6UhvNayhmaRJkIgo1PjdVG8NY!/r/dDIBAAAAAAAA" itemprop="contentUrl"/>
              </a>
            
          

          
          </div>
        </div>
      

      
        <p>希望这句话不只是送给我，也送给那些跟我当时心境一样的人。  </p>
<p>就像妈妈每次给我打电话的结尾是：要天天开开心心的。保持好心情。  </p>
<p>一样。  </p>
<p>观看笔记： <a href="https://www.bilibili.com/video/BV1Q4411y7ip?from=search&amp;seid=11158504841670855744" target="_blank" rel="noopener">https://www.bilibili.com/video/BV1Q4411y7ip?from=search&amp;seid=11158504841670855744</a>  </p>
<p>相关的笔记截图放在QQ号为：198866436的空间相册当中了；  </p>
<p>视频可以选择2x倍速观看；不知道为什么它的那个原本的速度我感觉好像放慢了一样，放到2x速度的时候感觉才像是刚刚好；  </p>
<h2 id="技术专题：分布式事务专题"><a href="#技术专题：分布式事务专题" class="headerlink" title="技术专题：分布式事务专题"></a>技术专题：分布式事务专题</h2><ol>
<li>基础概念</li>
</ol>
<ul>
<li>什么是事务</li>
<li>本地事务</li>
<li>分布式事务</li>
<li>分布式事务产生的场景</li>
</ul>
<ol start="2">
<li>分布式事务基础理论</li>
</ol>
<ul>
<li>CAP理论<ul>
<li>理解CAP</li>
<li>CAP组合方式</li>
<li>总结</li>
</ul>
</li>
<li>BASE理论</li>
</ul>
<ol start="3">
<li>分布式事务解决方案之2PC（两阶段提交）</li>
</ol>
<ul>
<li>什么是2PC</li>
<li>解决方案<ul>
<li>传统2PC</li>
<li>Seata实现2PC</li>
</ul>
</li>
<li>Seata实现2PC事务（seata阿里开源框架）<ul>
<li>业务说明</li>
<li>程序组成部分</li>
<li>创建数据库</li>
<li>启动TC（事务协调器）</li>
<li>discover-server</li>
<li>导入dtx-seata-demo</li>
<li>dtx-seata-demo-bank1</li>
<li>dtx-seata-demo-bank2</li>
<li>测试场景</li>
<li>原理分析</li>
</ul>
</li>
<li>小结</li>
</ul>
<ol start="4">
<li>分布式事务解决方案之TCC</li>
</ol>
<ul>
<li>什么是TCC事务</li>
<li>解决方案</li>
<li>Hmily实现TCC事务（Hmily轻量级框架）<ul>
<li>业务说明</li>
<li>程序组成部分</li>
<li>创建数据库</li>
<li>discover-server</li>
<li>导入dtx-tcc-demo</li>
<li>dtx-tcc-demo-bank1</li>
<li>dtx-tcc-demo-bank2</li>
<li>测试场景</li>
</ul>
</li>
<li>小结</li>
</ul>
<ol start="5">
<li>分布式事务解决方案之可靠消息最终一致性</li>
</ol>
<ul>
<li>什么是可靠消息最终一致性事务</li>
<li>解决方案<ul>
<li>本地消息表方案</li>
<li>RocketMQ事务消息方案</li>
</ul>
</li>
<li>RocketMQ实现可靠消息最终一致性事务（RocketMQ阿里开源的消息队列）<ul>
<li>业务说明</li>
<li>程序组成部分</li>
<li>创建数据库</li>
<li>启动RocketMQ</li>
<li>discover-server</li>
<li>导入dtx-txmsg-demo</li>
<li>dtx-txmsg-demo-bank1</li>
<li>dtx-txmsg-demo-bank2</li>
<li>测试场景</li>
</ul>
</li>
<li>小结</li>
</ul>
<ol start="6">
<li>分布式事务解决方案之最大努力通知</li>
</ol>
<ul>
<li>什么是最大努力通知</li>
<li>解决方案</li>
<li>RocketMQ实现最大努力通知型事务<ul>
<li>业务说明</li>
<li>程序组成部分</li>
<li>创建数据库</li>
<li>启动RocketMQ</li>
<li>导入dtx-notifymsg-demo</li>
<li>dtx-notifydemo-pay</li>
<li>dtx-notifydemo-bank1</li>
<li>测试场景</li>
</ul>
</li>
<li>小结</li>
</ul>
<ol start="7">
<li>分布式事务综合案例</li>
</ol>
<ul>
<li>系统介绍<ul>
<li>P2P介绍</li>
<li>总体业务流程</li>
<li>业务术语</li>
<li>模块说明</li>
</ul>
</li>
<li>注册账号案例分析<ul>
<li>业务流程</li>
<li>解决方案分析</li>
</ul>
</li>
<li>存管开户<ul>
<li>业务流程</li>
<li>解决方案分析</li>
</ul>
</li>
<li>满标审核<ul>
<li>业务流程</li>
<li>解决方案分析</li>
</ul>
</li>
</ul>
<ol start="8">
<li>课程总结</li>
</ol>
<h3 id="什么是事务"><a href="#什么是事务" class="headerlink" title="什么是事务"></a>什么是事务</h3><p>什么是事务？<br>举个生活中的例子：你去小卖铺买东西，“一手交钱，一手交货”就是一个事务的例子，交钱和交货必须全部成功，事务才算成功，任何一个活动失败，事务将撤销所有已成功的活动；  </p>
<p>明白上述例子，再来看事务的定义：  </p>
<blockquote>
<p>事务可以看做是一次大的活动，它由不同的小活动组成，这些小活动要么全部成功，要么全部失败；  </p>
</blockquote>
<h3 id="本地事务"><a href="#本地事务" class="headerlink" title="本地事务"></a>本地事务</h3><p>在计算机系统中，更多的是通过关系型数据库来控制事务，这是利用数据库本身的事务特性来实现的，因此叫做数据库事务；  </p>
<p>由于应用主要靠数据库来控制事务，而数据库通常和应用在同一个服务器，所以基于关系型数据库的事务又称为本地事务；  </p>
<p>回顾一下数据库事务的四大特性ACID：  </p>
<ul>
<li>A（Atomic）：  <ul>
<li>原子性；</li>
<li>构成事物的所有操作，要么都执行完成，要么全部不执行；</li>
<li>不可能出现部分成功部分失败的情况。  </li>
</ul>
</li>
<li>C（Consistency）：  <ul>
<li>一致性；</li>
<li>在事务执行前后，数据库的一致性约束没有被破坏。</li>
<li>比如：张三向李四转100元，转账前和转账后的数据是正确的状态这就叫做一致性；如果出现张三转出100元，李四账户没有增加100元这就出现了数据错误，就没有达到一致性。</li>
</ul>
</li>
<li>I（Isolation）：  <ul>
<li>隔离性；</li>
<li>数据库中的事务一般都是并发的；</li>
<li>隔离性是指并发的两个事务的执行互不干扰；</li>
<li>一个事务不能看到其他事务运行过程的中间状态。  </li>
<li>通过配置事务隔离级别可以避免脏读、重复读等问题。</li>
</ul>
</li>
<li>D（Durability）：  <ul>
<li>持久性；</li>
<li>事务完成之后，该事务对数据的更改会被持久化到数据库，且不会被回滚。  </li>
</ul>
</li>
</ul>
<p>数据库事务在实现时，会将一次事务涉及的所有操作全部纳入到一个不可分割的执行单元，该执行单元中的所有操作要么都成功，要么都失败，只要其中任一操作执行失败，都将导致整个事务的回滚。  </p>
<h3 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h3><p>随着互联网的快速发展，软件系统由原来的单体应用转变为分布式应用。  </p>
<p>下图描述了单体应用向微服务的演变：  </p>
<p>分布式系统会把一个应用系统拆分为可独立部署的多个服务。  </p>
<p>因此需要服务与服务之间远程协作才能完成事务操作。  </p>
<p>这种分布式系统环境下由不同的服务之间通过网络远程协作完成事务称之为【分布式事务】。  </p>
<p>例如用户注册送积分事务、创建订单减库存事务、银行转账事务等都是分布式事务。  </p>
<p>用户服务当中要增加用户/积分服务当中要增加积分；<br>我突然想起来了，其实信666这个项目当中增加用户还有一个充值90的一个操作，其实也应该是一个事务；当时增加用户后我是直接发送了一个队列进行充值90元；通过这个mq发送消息队列，这个不也是属于远程协作吗？加入我在进行操作增加增加账户的时候进行发送了队列这个时候如果增加账户出事情了那么势必就需要分布式事务了；倘若我当时好像处理的是当用户账户增加成功了之后然后再去发送的队列呢？这个时候就应该不会出现了吧？哦哦，不对，倘若我消息队列当中的业务逻辑处理增加90元的这个操作失败了呢？那么这个时候增加账户的这个业务操作就应该需要进行回滚？这两个操作构成一个事务（原子性），且需要达到一致性，即账户增加需要成功，充值也需要成功；  </p>
<p>订单服务中需要加订单/库存服务当中需要减少库存；  </p>
<p>本地事务依赖数据库依赖数据库本身提供的事务特性来实现，因此以下逻辑可以控制本地事务：  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span> <span class="keyword">transaction</span>;</span><br><span class="line">      //1. 本地数据库操作：张三减少金额</span><br><span class="line">      //2. 本地数据库操作：李四增加金额</span><br><span class="line"><span class="keyword">commit</span> <span class="keyword">transaction</span>;</span><br></pre></td></tr></table></figure>

<p>但是在分布式环境下，会变成这样：  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span> <span class="keyword">transaction</span>;</span><br><span class="line">      //1. 本地数据库操作：张三减少金额</span><br><span class="line">      //2. 远程调用：让李四增加金额</span><br><span class="line"><span class="keyword">commit</span> <span class="keyword">transaction</span>;</span><br></pre></td></tr></table></figure>

<p>可以设想，当远程调用让李四增加金额成功了，由于网络问题远程调用并没有返回，此时本地事务提交事务就回滚了张三减少金额的操作，此时张三和李四的数据就不一致了。  </p>
<p>因此在分布式架构的基础上，传统数据库事务就无法使用了。  </p>
<p>张三和李四的账户不在一个数据库中甚至不在一个应用系统里，实现转账事务需要通过远程调用，由于网络问题就会导致分布式事务问题。  </p>
<p>三种事务异常情况：<br>（1）本地数据库操作：张三减少金额失败了；那么远程调用：让李四增加金额也需要失败；<br>（2）远程调用：让李四增加金额失败了；那么本地数据库操作：让张三减少金额也需要失败；<br>（3）本地数据库操作以及远程调用都成功了；但是远程调用由于网络问题，没有及时返回相应的结果，事务的时间超时了，那么这个时候会造成异常，也就是本地数据库操作就会发生回滚；而远程调用已经成功了；则事务不一致了此时；  </p>
<p>所以说分布式事务去使用本地事务的思想解决是行不通的；  </p>
<h3 id="分布式事务产生的场景"><a href="#分布式事务产生的场景" class="headerlink" title="分布式事务产生的场景"></a>分布式事务产生的场景</h3><ol>
<li>典型的场景就是微服务架构</li>
</ol>
<p>微服务之间通过远程调用完成事务操作。  </p>
<p>比如：订单微服务和库存微服务，下单的同时订单微服务请求库存微服务减少库存。  </p>
<p>简言之: 跨JVM进程产生分布式事务。  </p>
<ol start="2">
<li>单体系统访问多个数据库实例</li>
</ol>
<p>当单体系统需要访问多个数据库（实例）时就会产生分布式事务；  </p>
<p>比如：用户信息和订单信息分别在两个MySQL实例存储，用户管理系统删除用户信息，需要分别删除用户信息及用户的订单信息，由于数据分布在不同的数据实例，需要通过不同的数据库链接去操作数据，此时产生分布式事务。  </p>
<p>简言之：跨数据库实例产生分布式事务。  </p>
<ol start="3">
<li>多服务访问同一个数据库实例</li>
</ol>
<p>比如：订单微服务和库存微服务即使访问同一个数据库也会产生分布式事务，原因就是跨JVM进程，两个微服务持有了不同的数据库链接进行数据库操作，此时产生分布式事务。  </p>
<h2 id="分布式事务基础理论"><a href="#分布式事务基础理论" class="headerlink" title="分布式事务基础理论"></a>分布式事务基础理论</h2><p>通过前面的学习，了解到了分布式事务的基础概念。  </p>
<p>与本地事务不同的是，分布式系统之所以叫做分布式，是因为提供服务的各个节点分步在不同的机器上，相互之间通过网络交互，不能因为有一点网络问题就导致整个系统无法提供服务，网络因素成为了分布式事务的考量标准之一。  </p>
<p>因此，分布式事务需要更进一步的理论支持，接下来，学习一下分布式事务的CAP理论。  </p>
<p>在安静街分布式事务控制解决方案之前需要先学习一些基础理论，通过理论知识指导确定分布式事务控制的目标，从而帮助理解每个解决方案。  </p>
<h3 id="CAP理论"><a href="#CAP理论" class="headerlink" title="CAP理论"></a>CAP理论</h3><p>进行分布式事务控制，需要控制到什么程度：  </p>
<p>（1）出现了网络问题之后，数据不一致；  </p>
<p>（2）出现了网络问题后，某一个服务不可用；  </p>
<h4 id="理解CAP"><a href="#理解CAP" class="headerlink" title="理解CAP"></a>理解CAP</h4><p>CAP是Consistency、Availability、Partition tolerance三个词语的缩写，分别表示一致性、可用性、分区容忍性。  </p>
<p>下边分别来解释：  </p>
<p>  为了方便对CAP理论的理解，结合电商系统中的一些业务场景来理解CAP。  </p>
<p>  如下图，是商品信息管理的执行流程：  </p>
<p>整体执行流程如下：  </p>
<ol>
<li>商品服务请求主数据库写入商品信息（添加商品、修改商品、删除商品）</li>
<li>主数据库向商品服务响应写入成功</li>
<li>商品服务请求从数据库读取商品信息</li>
</ol>
<p>数据库读写分离好处：分担数据库的压力；  </p>
<p>主数据库只管提供写入操作，从数据库只管提供查询操作；  </p>
<blockquote>
<p>C - Consistency</p>
</blockquote>
<p>一致性是指写入操作的读操作可以读取到最新的数据状态，当数据分步到多个结点上，从任意节点读取到的数据都是最新的状态。  </p>
<p>上图中，商品信息的读写要满足一致性就是要实现如下目标：  </p>
<p>（1）商品服务写入主数据库成功，则向从数据库查询新数据也成功；<br>（2）商品服务写入主数据库失败，则向从数据库查询新数据也失败；  </p>
<p>如何实现一致性？（此时的一致性则指的是主从数据库的数据一致性）  </p>
<p>（1）写入主数据库后要将数据同步到从数据库；<br>（2）写入主数据库后，在向从数据库同步期间要将数据库锁定，待同步完成后再释放锁，以免在新数据写入成功后，向从数据库查询到旧的数据。  </p>
<p>同步的方式：<br>（1）主从复制；  </p>
<p>分布式系统一致性的特定：  </p>
<p>（1）由于存在数据同步的过程，写操作的响应会有一定的延迟；<br>（2）为了保证数据一致性会对资源暂时锁定，待数据同步完成释放锁定资源。<br>（3）如果请求数据同步失败的结点则会返回错误信息，一定不会返回旧数据。  </p>
<blockquote>
<p>A - Availability</p>
</blockquote>
<p>可用性是指任何事物操作都可以得到响应结果，且不会出现响应超时或者响应错误。  </p>
<p>上图中，商品信息读取满足可用性就要实现如下目标：  </p>
<p>（1）从数据库接收到数据查询的请求则立即能够响应数据查询结果；<br>（2）从数据库不允许出现响应超时或者响应错误。<br>（3）即使数据还没有同步过来，从数据库也要返回查询的数据，哪怕是旧数据，如果连就数据库也没有则可以按照约定返回一个默认信息，但不能返回错误或者响应超时。  </p>
<p>分布式可用性的特定：  </p>
<p>（1）所有请求都有响应，且不会出现响应超时或者响应错误。  </p>
<blockquote>
<p>P - Partition tolerance</p>
</blockquote>
<p>通常分布式系统的各个结点部署在不同的子网，这就是网络分区。  </p>
<p>不可避免的会出现由于网络问题而导致结点之间的通信失败，此时仍然可以对外提供服务，这就叫分区容忍性。  </p>
<p>上图中，商品信息读写满足分区容忍性就是要实现如下目标：  </p>
<p>（1）主数据库向从数据库同步数据失败不影响读写操作。<br>（2）其中一个结点挂掉不影响另一个节点对外提供服务。  </p>
<p>如何实现分区容忍性？  </p>
<p>（1）尽量使用异步取代同步操作，例如使用异步方式将数据从主数据库同步到从数据，这样结点之间才能有效的实现松耦合。<br>（2）添加从数据库结点，其中一个结点挂掉其他从结点提供服务。  </p>
<p>分布式分区容忍的特点：  </p>
<p>（1）分区容忍性是分布式系统具备的基本能力。  </p>
<h4 id="CAP组合方式"><a href="#CAP组合方式" class="headerlink" title="CAP组合方式"></a>CAP组合方式</h4><ol>
<li>上边商品管理的例子是否同时具备CAP呢？  </li>
</ol>
<p><strong>在所有分布式事务场景中不会同时具备CAP三个特性，因为在具备了P的的前提下C和A是不能共存的。</strong>  </p>
<p>比如：  </p>
<p>下图满足了P即表示分区容忍：  </p>
<p>本图分区容忍的含义是：  </p>
<p>（1）主数据库通过网络向从数据库同步数据，可以认为主从数据库部署在不同的分区，通过网络进行交互;<br>（2）当主数据库和从数据库之间的网络出现问题不影响主数据和从数据库对外提供服务。<br>（3）其中一个结点挂掉不影响另一节点对外提供服务。  </p>
<p>如果要实现C则必须保证数据一致性，在数据同步的时候为防止向从数据库查询不一致的数据则需要从数据库数据锁定，待同步完成之后解锁，如果同步失败从数据库要返回错误信息或超时信息。  </p>
<p>如果要实现A则必须保证数据可用性，不管任何时候都可以向从数据库查询数据，则不会响应超时或者返回错误信息。  </p>
<p>通过分析发现在满足P的前提下C和A存在矛盾性。  </p>
<ol start="2">
<li>CAP有哪些组合方式呢？</li>
</ol>
<p>所以在生产中对分布式事务处理时要根据需求来确定满足CAP的哪两个方面。  </p>
<p>（1）AP：  </p>
<p>放弃一致性，追求分区容忍性和可用性。<br>这是很多分布式系统设计时的选择。  </p>
<p>例如：<br>上边的商品管理，完全可以实现AP，前提是只要用户可以接受所查询到的数据在一定时间内不是最新的即可。  </p>
<p>通常实现AP都会保证最终一致性，后面讲的BASE理论就是根据AP来实现的，一些业务场景，比如：订单退款、今日退款成功，明日账户到账，只要用户可以接受在一定时间内到账即可。  </p>
<p>我突然想到一个问题；就是现在深圳通或者是乘车码有个时候会出现延迟扣费的一个情况。是不是也是额，放弃数据一致性而追求可用性和分区容忍性？深圳通和乘车码肯定是一个分布式的一个系统架构，我觉得，因为这个使用的这个人群数量很高，且每一个人进行的交易也就是乘车的这个次数的交易量也很大，好了不说这个了。也就是说，它会有一个温馨提示：因扫码设备网络不稳定等原因，该笔乘车扣款有延迟。的这样一个信息。当没有及时进行扣款遵循可用性的原则应该是返回了一个默认或者是双方规定好的一个原则，没有去响应超时或者是这个响应错误信息，而是没有提示什么东西；然后事后去保证最终一致性，也就是进行了延迟扣款。我猜的。  </p>
<p>（2）CP：  </p>
<p>放弃可用性，追求一致性和分区容错性，zookeeper其实就是追求的强一致性，又比如说跨行转账，一次转账请求要求等待双方银行都完成整个事务才算完成。  </p>
<p>对对对，我之前我想的也是这个分区容忍性和容错好像啊。  </p>
<p>（3）CA：  </p>
<p>放弃分区容忍性，即不进行分区，不考虑由于网络不同或者结点挂掉的情况，则可以实现一致性和可用性，那么系统将不是一个标准的分布式系统，最常用的关系型数据库就满足了CA。  </p>
<p>上边的商品管理，如果要实现CA则架构如下：  </p>
<p>主数据库和从数据库中间不再进行数据同步，数据库可以响应每次的查询请求，通过事务隔离级别实现每个查询请求都可以返回最新的数据。  </p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>通过上面已经学习了CAP理论的相关知识，CAP是一个已经被证实的理论：  </p>
<p>一个分布式系统最多只能同时满足一致性（Consistency）、可用性（Availability）和分区容忍性（Partition tolerance）这三项中的两项。  </p>
<p>它可以作为进行架构设计、技术选型的考量标准。  </p>
<p>对于多数大型互联网应用的场景，结点众多、部署分散，而且现在的集群规模越来越大，所以节点故障、网络故障是常态，而且要保证服务可用性达到N个9（99.99…%），并且要达到良好的响应性能来提高用户体验，因此一般都会做出如下选择：保证P和A，舍弃C强一致，保证最终一致性。  </p>
<h3 id="BASE理论"><a href="#BASE理论" class="headerlink" title="BASE理论"></a>BASE理论</h3><ol>
<li>理解强一致性（CA、CP）和最终一致性（AP）</li>
</ol>
<p>CAP理论告诉我们一个分布式系统做多只能同时满足一致性（Consistency）、可用性（Availability）和分区容忍性（Partition tolerance）这三项中的两项。  </p>
<p>其中AP在实际应用中较多，AP即舍弃一致性，保证可用性和分区容忍性。  </p>
<p>但是在实际生产中很多场景都要实现一致性，比如前面举的例子，主数据库向从数据库同步数据，即使不要一致性，但是最终也要将数据库同步成功来保证数据一致，这种一致性和CAP中的一致性不同：<br>（1）CAP中的一致性要求在任何时间查询每个节点数据都必须一致，它强调的是强一致性；<br>（2）但是最终一致性是允许在一段时间内每个结点的数据不一致，但是经过一段时间每个结点的数据必须一致，它强调的是最终数据的一致性。  </p>
<ol start="2">
<li>BASE理论介绍</li>
</ol>
<p>BASE是Basically Available（基本可用）、Soft state（软状态）和Eventually consistent（最终一致性）三个短语的缩写。  </p>
<p>BASE理论是对CAP中AP的一个扩展，通过牺牲强一致性来获得可用性，当出现故障允许部分不可用但要保证核心功能可用，允许数据在一段时间内是不一致的，但最终达到一致状态。  </p>
<p>满足BASE理论的事务，称之为“<strong>柔性事务</strong>”。  </p>
<ul>
<li>基本可用（Basically Available）：分布式系统在出现故障时，允许损失部分可用功能，保证核心功能可用。如，电商网站交易付款时出现问题了，商品依然可以正常浏览。  </li>
<li>软状态（Soft state）：由于不要求强一致性，所以BASE允许系统中存在中间状态（也叫软状态），这个状态不影响系统可用性，如订单的“支付中”、“数据同步中”等状态，待数据最终一致后状态改为“成功”状态。  </li>
<li>最终一致性（Eventually consistent）：最终一致是指经过一段时间后，所有结点数据都将会达到一致，如订单的“支付中”状态，最终会变为“支付成功”或者“支付失败”，使订单状态与实际交易结果达成一致，但是需要一定时间的延迟、等待。  </li>
</ul>
<h2 id="分布式事务解决方案之2PC（两阶段提交）"><a href="#分布式事务解决方案之2PC（两阶段提交）" class="headerlink" title="分布式事务解决方案之2PC（两阶段提交）"></a>分布式事务解决方案之2PC（两阶段提交）</h2><p>前面已经学习了分布式事务的基础理论，以理论为基础，针对不同的分布式场景业界常见的解决方案有2PC、TCC、可靠消息最终一致性、最大努力通知这几种。  </p>
<h3 id="什么是2PC"><a href="#什么是2PC" class="headerlink" title="什么是2PC"></a>什么是2PC</h3><p>2PC即两阶段提交协议，是将整个事务流程分为两个阶段，准备阶段（Prepare phase）、提交阶段（commit phase），2是指两个阶段，P是指准备阶段，C是指提交阶段。  </p>
<p>举例： 张三和李四好久不见，老友约起聚餐，饭店老板要求先买单，才能出票。  </p>
<p>这时张三和李四分别抱怨近况不如意，囊中羞涩，都不愿意请客，这时只能AA。  </p>
<p>只有张三和李四都付款，老板才能出票安排就餐。  </p>
<p>但是由于张三和李四都是铁公鸡，形成了尴尬的一幕：  </p>
<p>准备阶段：老板要求张三付款，张三付款。老板要求李四付款，李四付款。  </p>
<p>提交阶段：老板出票，两人拿票纷纷落座就餐。  </p>
<p>例子中形成了一个事务，若张三或者李四其中一个人拒绝付款，或者钱不够，店家老板都不会给出票，并且会把已收款退回。  </p>
<p>整个失误过程由事务管理器和参与者完成，店家老板就是事务管理器，张三、李四就是事务参与者，事务管理器负责决策整个分布式事务的提交和回滚，事务参与者负责自己本地事务的提交和回滚。  </p>
<p>在计算机中部分关系数据库如Oracle、MySQL支持两阶段提交协议，如下图：  </p>
<p>（1）准备阶段（Prepare phase）：事务管理器给每个参与者发送Prepare消息，每个数据库参与者在本地执行事务，并写本地的Undo/Redo日志，此时事务没有提交。  </p>
<p>（Undo日志是记录修改前的数据，用于数据库回滚；Redo日志是记录修改后的数据，用于提交事务后写入数据库文件）  </p>
<p>（2）提交阶段（Commit phase）：如果事务管理器受到了参与者的执行失败或者超时消息时，直接给每个参与者发送回滚（Rollback）消息；否则，发送提交（Commit）消息；参与者根据事务管理器的指令执行提交或者回滚操作，并释放事务处理过程中使用的锁资源。注意：必须在最后阶段释放锁资源。  </p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><h4 id="XA方案"><a href="#XA方案" class="headerlink" title="XA方案"></a>XA方案</h4><p>2PC的传统方案是在数据库层面实现的。  </p>
<p>如Oracle、MySQL都支持2PC协议，为了统一标准减少行业内不比要的对接成本，需要制定标准化的处理模型以及接口标准，国际开发标准组织Open Group定义了分布式事务处理模型DTP（Distributed Transaction Processing Reference Model）。  </p>
<p>这套模型就是为了规范数据库支持2PC协议的整个实现的过程。  </p>
<p>为了更明确XA方案的内容，下面<strong>新用户注册送积分</strong>为例来说明：  </p>
<p>执行流程如下：  </p>
<p>（1）应用程序（AP）持有用户库和积分库两个数据源。<br>（2）准备阶段：应用程序（AP）通过TM通知用户库RM（Resource Manager）新增用户，同时通知积分库RM为该用户新增积分，RM此时并未提交事务，此时用户和积分资源锁定。<br>（3）TM（事务管理器Transaction Manager）收到执行回复，只要有一方失败则分别向其他RM发起回滚事务，回滚完毕，资源锁释放。<br>（4）TM收到执行回复，全部成功，此时向所有RM发起提交事务，提交完毕，资源锁释放。  </p>
<p>DTP模型定义如下角色：  </p>
<ul>
<li><strong>AP</strong>（Application Program）：即应用程序，可以理解为使用DTP分布式事务的程序。  </li>
<li><strong>RM</strong>（Resource Manager）：即资源管理器，可以理解为事务的参与者，一般情况下是指一个数据库实例，通过资源管理器对该数据库进行控制，资源管理器控制着分支事务。  </li>
<li><strong>TM</strong>（Transaction Manager）：事务管理器，负责协调和管理事务，事务管理器控制着全局事务，管理事务生命周期，并协调各个RM。<strong>全局事务</strong>是指分布式事务处理环境中，需要操作多个数据库共同完成一个工作，这个工作即是一个全局事务。  </li>
<li>DTP模型定义TM和RM之间通讯的接口规范叫<strong>XA</strong>，简单理解为数据库提供的2PC接口协议，<strong>基于数据库的XA协议来实现2PC又称为XA方案</strong>。</li>
<li>以上三个角色之间的交互方式如下：<br>（1）TM向AP提供应用程序编程接口，AP通过TM提交以及回滚事务。<br>（2）TM消息中间件通过XA接口来通知RM数据库事务的开始、结束以及提交、回滚等。  </li>
</ul>
<p>总结：  </p>
<p>整个2PC的事务流程涉及到三个流程AP、RM、TM。<br>AP指的是2PC分布式事务的应用程序；<br>RM指的是资源管理器；它控制着分支事务；<br>TM指的是事务管理器，它控制着整个全局事务；  </p>
<p>（1）在<strong>准备阶段</strong>RM执行实际的业务操作，但是不提交事务，自愿锁定；<br>（2）在<strong>提交阶段</strong>TM会接受RM在准备阶段的执行回复，只要有任意一个RM执行失败，TM会通知所有RM执行回滚操作；否则，TM将会通知所有的RM提交该事务，提交阶段结束资源释放锁；  </p>
<p>XA方案的问题：<br>（1）需要本地数据库支持XA协议。<br>（2）资源锁需要等到两个阶段结束才释放，性能较差。  </p>
<h4 id="Seata方案"><a href="#Seata方案" class="headerlink" title="Seata方案"></a>Seata方案</h4><p>Seata是由阿里中间件团队发起的开源项目Fescar，后更名为Seata，它是一个开源的分布式事务框架。  </p>
<p>传统2PC的问题在Seata中得到了解决，它通过对本地关系数据库的分支事务的协调来驱动完成全局事务，是工作在应用层的中间件。  </p>
<p>（Seata不要求关系数据库是否遵从2PC协议）  </p>
<p>主要优点是性能较好，且不长时间占用连接资源，它以高效并且对业务零侵入的方式解决微服务场景下面临的分布式事务问题，他目前提供AT模式（即2PC）以及TCC模式的分布式事务解决方案。  </p>
<p><strong>Seata的设计思想如下：</strong>  </p>
<p>Seata的设计目标其一是对业务目标无侵入，因此从业务无侵入的2PC方案着手，在<strong>传统2PC</strong>的基础上演进，并解决2PC方案面临的问题。  </p>
<p>Seata把一个分布式事务理解成一个包含了若干<strong>分支事务</strong>的<strong>全局事务</strong>。  </p>
<p>全局事务的职责是协调其下管辖的分支事务达成一致，要么一起成功，要么一起失败回滚。  </p>
<p>此外，通常分支事务本身就是一个关系数据库的本地事务，下图是全局事务与分支事务的关系图：  </p>
<p>与传统的2PC的模型类似，Seata定义了3个组件来协议分布式事务的处理过程：  </p>
<ul>
<li>Transaction Coordinator（TC）：事务协调器，它是独立的中间件，需要独立部署运行，它维护全局事务的运行状态，接受TM指令发起全局事务的提交与回滚，负责与RM通信协调各个分支事务的提交或者回滚。  </li>
<li>Transaction Manager（TM）：事务管理器，TM需要嵌入应用程序中工作，它负责开启一个全局事务，并最终向TC发起全局提交护着全局回滚的指令。  </li>
<li>Resource Manager（RM）：控制分支事务，负责分支注册、状态汇报，并接收事务协调器TC的指令，驱动分支（本地）事务的提交和回滚。  </li>
</ul>
<p>还拿<strong>新用户注册送积分</strong>举例Seata的分布式事务过程：  </p>
<p>具体的执行流程如下：  </p>
<p>（1）用户服务的TM向TC申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的XID；<br>（2）用户服务的RM向TC注册分支事务，该分支事务在用户服务执行新增用户逻辑（该事务提交，即第一个阶段当中就提交了事务），并将其纳入XID对应全局事务的管辖。<br>（3）用户服务执行分支事务，向用户表插入一条记录。<br>（4）逻辑执行到远程调用 积分服务 时（XID在微服务调用链路的上下文中传播）。积分服务的RM向TC注册分支事务，该分支事务执行增加积分的逻辑，并将其纳入到XID对应全局事务的管辖。<br>（5）积分服务执行分支事务，向积分记录表插入一条记录，执行完毕后（完成分支事务，即已经提交分支事务，释放锁），返回用户服务。（如当其他的分支事务后期没有成功，导致需要回滚，即将向积分记录表当中插入的该条记录进行删除即可）<br>（6）用户服务分支事务执行完毕。<br>（7）TM向TC发起针对XID的全局提交或者回滚决议。<br>（8）TC调度XID下管辖的全部分支事务完成提交或者回滚请求。  </p>
<p><strong>Seata实现2PC与传统2PC的差别：</strong>  </p>
<p>架构层次方面，<strong>传统2PC</strong> 方案的RM实际上就是在数据库底层，RM本质上就是数据库自身，通过XA协议实现，而Seata的RM是以jar包的形式作为中间件层部署在应用程序这一侧的。  </p>
<p>两阶段提交方面，<strong>传统2PC</strong> 无论第二阶段的决议是commit还是rollback，事务性资源的锁都要保持到Phase2完成才释放。  </p>
<p>而Seata的做法是在Phase1就将本地事务提交，这样就可以省去Phase2持锁的时间，整体提高效率。  </p>
<h3 id="Seata实现2PC事务"><a href="#Seata实现2PC事务" class="headerlink" title="Seata实现2PC事务"></a>Seata实现2PC事务</h3><h4 id="业务说明"><a href="#业务说明" class="headerlink" title="业务说明"></a>业务说明</h4><p>本示例通过Seata中间件实现分布式事务，模拟三个账户的转账交易过程。  </p>
<p>两个账户在两个个不同的银行（张三在bank1、李四在bank2），bank1和bank2是两个微服务。  </p>
<p>交易过程是：张三给李四转账指定金额。  </p>
<p>上述交易步骤，要么一起成功，要么一起失败，必须是一个整体性的事务。  </p>
<h4 id="本示例程序组成部分如下"><a href="#本示例程序组成部分如下" class="headerlink" title="本示例程序组成部分如下"></a>本示例程序组成部分如下</h4><p>数据库：MySQL-5.7.25（包括bank1和bank2两个数据库）<br>JDK：64位jdk1.8.0_201<br>微服务框架：spring-boot-2.1.3、spring-cloud-Greenwich.RELEASE<br>seata客户端（RM、TM）：spring-cloud-alibaba-seata-2.1.0.RELEASE<br>seata服务端（TC）：seata-server-0.7.1<br>微服务以及数据库的关系：<br>  dtx/dtx-seata-demo/seata-demo-bank1 银行1，操作张三账户，连接数据库1<br>  dtx/dtx-seata-demo/seata-demo-bank2 银行2，操作李四账户，连接数据库2<br>服务注册中心：dtx/discover-server  </p>
<p>本示例程序技术架构如下：  </p>
<p>交互流程如下:  </p>
<ol>
<li>请求bank1进行转账，传入转账金额。  </li>
<li>bank1减少转账金额，调用bank2，传入转账金额。  </li>
</ol>
<h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><h4 id="启动TC事务协调器"><a href="#启动TC事务协调器" class="headerlink" title="启动TC事务协调器"></a>启动TC事务协调器</h4><p>（1）下载Seata服务器<br>（2）解压并启动  </p>
<p>运行模式（file，nacos，eureka，redis，zk，consul，etcd3，sofa；file模式，因为TC，Seata-server是事务协调器，记录各个分支事务的执行情况，所以数据以文本的方式写到了文件/本地的一个目录当中，还有数据库的方式就将写到数据库当中还支持其他方式）  </p>
<h4 id="discover-server"><a href="#discover-server" class="headerlink" title="discover-server"></a>discover-server</h4><h4 id="导入案例工程dtx-seata-demo"><a href="#导入案例工程dtx-seata-demo" class="headerlink" title="导入案例工程dtx-seata-demo"></a>导入案例工程dtx-seata-demo</h4><h4 id="启动TC事务协调器-1"><a href="#启动TC事务协调器-1" class="headerlink" title="启动TC事务协调器"></a>启动TC事务协调器</h4><h4 id="Seata执行流程"><a href="#Seata执行流程" class="headerlink" title="Seata执行流程"></a>Seata执行流程</h4><ol>
<li><p>正常提交流程  </p>
</li>
<li><p>回滚流程</p>
</li>
</ol>
<p>要点说明：  </p>
<ol>
<li>每个RM使用DataSourceProxy连接数据库，其目的是使用ConnectionProxy，使用数据源和数据连接代理的目的就是在第一阶段将undo_log和业务数据放在一个本地事务提交，这样就保存了只要有业务操作就一定有undo_log。  </li>
<li>在第一阶段undo_log中存放了数据修改前和修改后的数据，为事务回滚做好准备，所以第一阶段完成就已经将分支事务提交，也就释放了锁资源。  </li>
<li>TM开启全局事务开始，将XID全局事务id放在事务上下文中，通过feign调用也将XID传入下游分支事务，每个分支事务将自己的Branch ID分支事务与XID关联。</li>
<li>第二阶段全局事务提交，TC会通知各个分支参与者提交分支事务，在第一阶段就已经提交了分支事务，这里各个参与者只需要删除undo_log即可，并且可以异步执行，第二阶段很快就可以完成。</li>
<li>第二阶段全局事务回滚，TC会通知各个分之参与者回滚事务，通过XID与Branch ID找到相应的回滚日志，通过回滚日志生成反向的SQL并执行，以完成分支事务回滚到之前的状态，如果回滚失败则会重试回滚操作。</li>
</ol>
<h4 id="dtx-seata-demo-bank1"><a href="#dtx-seata-demo-bank1" class="headerlink" title="dtx-seata-demo-bank1"></a>dtx-seata-demo-bank1</h4><p>为什么要有注册中心；因为张三要调用李四的微服务，要进行转账，所以让微服务都注册到注册中心；实现远程的调用；这个注册中心用的是spring-cloud的seata；  </p>
<h4 id="dtx-seata-demo-bank2"><a href="#dtx-seata-demo-bank2" class="headerlink" title="dtx-seata-demo-bank2"></a>dtx-seata-demo-bank2</h4><h4 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h4><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>本节讲解了传统2PC（基于数据库XA协议）和Seata实现2PC的两种2PC方案，由于Seata的零侵入并解决了传统2PC长期锁资源的问题，所以推荐采用Seata实现2PC。  </p>
<p>Seata实现2PC要点：  </p>
<ol>
<li>全局事务开始使用@GolobalTransaction标识；</li>
<li>每个本地事务方案仍然使用@Transactional标识；</li>
<li>每个数据都需要创建undo_log表，此表是Seata保证本地事务一致性的关键；  </li>
</ol>
<h2 id="分布式事务解决方案之TCC"><a href="#分布式事务解决方案之TCC" class="headerlink" title="分布式事务解决方案之TCC"></a>分布式事务解决方案之TCC</h2><h3 id="什么是TCC事务"><a href="#什么是TCC事务" class="headerlink" title="什么是TCC事务"></a>什么是TCC事务</h3><p>2PC：两阶段提交协议（一个是准备阶段一个是提交阶段）；有两种处理方式（一种是XA方案一种是阿里的Seata方案）；协议本身是一致的也就是都存在两个阶段；  </p>
<p>2PC和TCC都是用来执行控制分布式事务的；  </p>
<p>TCC是Try、Confirm、Cancel三个词语的缩写；  </p>
<p>TCC要求每个分支事务实现三个操作：预处理Try、确认Confirm、撤销Cancel。  </p>
<p>Try操作做业务检查以及资源预留，Confirm做业务确认操作，Cancel实现一个与Try相反的操作即回滚操作。  </p>
<p>TM首先发起所有的分支事务的Try操作，任何一个事务的Try操作执行失败，TM将会发起所有分支事务的Cancel操作；若Try操作全部成功，TM将会发起所有分支事务的Confirm操作，其中Confirm/Cancel操作若执行失败，TM会进行重试。  </p>
<p>TCC分为三个阶段：  </p>
<ol>
<li><strong>Try</strong>阶段是做业务检查（一致性）以及资源预留（隔离），此阶段仅是一个初步操作，它和后续的Confirm一起才能真正构成一个完整的业务逻辑。  </li>
<li><strong>Confirm</strong>阶段是做确认提交，Try阶段所有分支事务执行成功后开始执行Confirm。通常情况下，采用TCC则认为Confirm阶段是不会出错的。即：只要Try成功，Confirm一定成功。若Confirm阶段真的出错了，需要引入重试机制或者人工处理。  </li>
<li><strong>Cancel</strong>阶段是在业务执行错误需要回滚的状态下执行分支事务的业务徐晓，预留资源释放。通常情况下，采用TCC则认为Cancel阶段也是一定成功的。若Cancel阶段真的出错了，需要引入重试机制或者人工处理。  </li>
<li>TM事务管理器  </li>
</ol>
<p>TM事务管理器可以实现独立的服务，也可以让<strong>全局事务发起方</strong>充当TM的角色，TM独立出来是为了成为公用组件，是为了考虑系统结构和软件复用。  </p>
<p>TM在发起全局事务时生成全局事务记录，全局事务ID贯穿整个分布式事务调用链条。用来记录事务上下文，追踪和记录状态，由于Confirm和Cancel失败需要进行重试，因此需要实现为幂等，幂等性是指同一个操作无论请求多少次，其结果都相同。  </p>
<h3 id="TCC解决方案"><a href="#TCC解决方案" class="headerlink" title="TCC解决方案"></a>TCC解决方案</h3><p>转账是一种业务，注册送积分也是一种业务，抛开业务的话，其实TCC本身的技术协议是一致的，所以在市面上存在有很多的框架来处理TCC的事务。  </p>
<p>目前市面上的TCC框架众多比如下面这几种：  </p>
<table>
  <thead>
    <tr>
      <th>框架名称</th>
      <th>GitHub地址</th>
      <th>star数量</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>tcc-transaction(类似Seata也需要单独进行部署相关的seata server)</td>
      <td>https://xxxxx</td>
      <td>xxxxx</td>
    </tr>
    <tr>
      <td>Hmily</td>
      <td>https://xxxxx</td>
      <td>xxxxx</td>
    </tr>
    <tr>
      <td>ByteTCC</td>
      <td>https://xxxxx</td>
      <td>xxxxx</td>
    </tr>
    <tr>
      <td>EasyTransaction</td>
      <td>https://xxxxx</td>
      <td>xxxxx</td>
    </tr>
  </tbody>
</table>

<p>上一节所讲的Seata也支持TCC，但是Seata的TCC模式对于Spring Cloud并没有提供支持。<br>目标是理解TCC原理以及事务协调运作的过程，因此更倾向于轻量级易于理解的框架，因此最终确定了Hmily。  </p>
<p>Hmily是一个功性能分布式事务TCC开源框架。  </p>
<p>基于Java语言来开发（JDK1.8），支持Dubbo、Spring Cloud等RPC框架进行分布式事务。（且支持版本较新）  </p>
<p>它目前支持一下特性:  </p>
<ul>
<li>支持嵌套事务（Nested transaction support）；</li>
<li>采用disruptor框架进行事务日志的异步读写，与RPC框架的性能毫无差别；</li>
<li>支持SpringBoot-starter项目启动，使用简单；  </li>
<li>RPC框架支持：dubbo、motan、springcloud</li>
<li>本地事务存储支持：redis、mongodb、zookeeper、file、mysql；</li>
<li>采用Aspect Aop切面思想与Spring无缝集成，天然支持集群。  </li>
<li>RPC事务恢复，超时异常恢复等；</li>
</ul>
<p>Hmily利用AOP对参与分布式事务的本地方法与远程方法进行拦截处理，通过多方拦截，事务参与者能透明的调用到另一方的Try、Confirm、Cancel方法；传递事务上下文；并记录事务日志；酌情进行补偿，重试等；  </p>
<p>Hmily不需要事务协调服务，但需要提供一个数据库（mysql/mongodb/zookeeper/redis/file）来进行日志存储。  </p>
<p>Hmily实现的TCC服务于普通的服务一样，只需要暴露一个接口，也就是它的Try业务。<br>Confirm/Cancel业务逻辑，只是因为全局事务提交/回滚的需要才提供的，因此Confirm/Cancel业务只需要被HmilyTCC事务框架发现即可，不需要被调用它的其他业务服务所感知。  </p>
<p><strong>TCC需要注意三种异常处理分别是空回滚、幂等、悬挂；</strong>  </p>
<p><strong>空回滚：</strong>  </p>
<p>在没有调用TCC资源Try方法的情况下，调用了二阶段的Cancel方法，Cancel方法需要识别出这是一个空回滚，然后直接返回成功；  </p>
<p>出现原因是：当一个分支事务所在服务宕机或者是网络异常，分支事务调用记录为失败；这个时候其实是没有执行Try阶段，当故障恢复后，分布式事务进行回滚则会调用二阶段的Cancel方法，从而形成空回滚。  </p>
<p>解决思路是关键就是要识别出这个空回滚。  </p>
<p>思路很简单就是需要知道一阶段是否执行，如果执行了，那么就是正常回滚；如果没有执行，那么就是空回滚；  </p>
<p>前面已经说过:TM在发起全局事务时生成全局事务记录，全局事务ID贯穿整个分布式事务调用链条。在额外增加一张分支事务记录表，其中有全局事务ID和分支事务ID，第一阶段Try方法里会插入一条记录，表示一阶段执行了。<br>Cancel接口里读取该记录，如果该记录存在，则正常回滚；如果该记录不存在，则是空回滚。  </p>
<p><strong>幂等：</strong>  </p>
<p>通过前面的介绍已经了解到，为了保证TCC二阶段提交重试机制不会引发数据不一致，要求TCC阶段Try、Confirm、Cancel接口保证幂等，这样不会重复使用或者释放资源。  </p>
<p>如果幂等控制没有做好，很有可能导致数据不一致等严重问题；  </p>
<p>解决思路在上述“分支事务记录”中增加执行状态，每次执行前都查询该状态。  </p>
<p><strong>悬挂：</strong>  </p>
<p>悬挂就是对一个分布式事务，其二阶段Cancel接口比Try接口先执行。  </p>
<p>出现原因是在RPC调用分支事务Try时，先注册分支事务，再调用RPC调用；  </p>
<p>如果此时RPC调用的网络发生拥堵，通常RPC调用是有超时时间的，RPC超时以后，TM就会通知RM回滚该分布式事务，可能回滚完成后，RPC请求才到达参与者真正执行，而一个Try方法预留的业务资源，只有该分布式事务才能使用，该分布式事务第一阶段预留的业务资源就再也没有人能够处理了。对于这种情况，称之为悬挂。即业务资源预留后没有办法继续处理。  </p>
<p>解决思路时候如果二阶段执行完成，那一阶段就不能再继续执行。<br>在执行一阶段事务时判断在全局事务下，“分支事务记录”表中是否已经有二阶段事务记录，如果有则不执行Try；  </p>
<p><strong>举例，场景为A转账30元给B，A和B账户在不同的服务。</strong><br><strong>方案一：</strong><br>账户A  </p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    检查余额是否够<span class="number">30</span>元；</span><br><span class="line">    扣减<span class="number">30</span>元；</span><br><span class="line">confirm：</span><br><span class="line">    空；</span><br><span class="line">cancel：</span><br><span class="line">    增加<span class="number">30</span>元；</span><br></pre></td></tr></table></figure>

<p>账户B  </p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    增加<span class="number">30</span>元</span><br><span class="line">confirm：</span><br><span class="line">    空</span><br><span class="line">cancel：</span><br><span class="line">    减少<span class="number">30</span>元</span><br></pre></td></tr></table></figure>

<p><strong>方案1说明：</strong>  </p>
<p>（1）账户A，这里的余额就是所谓的业务资源，按照前面提到的原则：<br>在第一阶段需要检查并预留业务资源；<br>因此，在扣钱TCC资源的Try接口里先检查A账户余额是否足够，如果足够则扣除30元。<br>Confirm接口表示正式提交，由于业务资源已经在Try接口里扣除掉了，那么在第二阶段的Confirm接口里可以什么都不用做。<br>Cancel接口的执行表示整个事务的回滚，账户A回滚则需要把Try接口里扣除掉的30元还给账户A。<br>（2）账户B，在第一阶段Try接口里实现给账户B加钱；<br>Cancel接口的执行表示整个事务的回滚；<br>账户B回滚则需要把Try接口里加的30元再减去；  </p>
<p><strong>方案1的问题分析：</strong>  </p>
<p>（1）如果账户A的try没有执行；在Cancel则就多加了30元（需要空回滚判断）；<br>（2）由于Try、Confirm、Cancel都是由单独的线程去调用，且会出现重复调用，所以都需要实现幂等（幂等）；<br>（3）账户B在try中增加了30元，当Try执行完成后可能会被其他线程给消费了；<br>（4）如果账户B的Try没有执行在Cancel则就多减了30元（需要空回滚判断）；  </p>
<p><strong>问题解决：</strong>  </p>
<p>（1）账户A的Cancel方法需要判断Try方法是否执行，正常执行Try后方可执行Cancel；避免空回滚的发生；<br>（2）Try、Cancel、Confirm方法都需要进行实现幂等；<br>（3）账户B在Try中不允许更新账户金额，在Confirm中更新账户金额；以免提前新增的30元被其他的业务逻辑给消费掉；<br>（4）账户B的Cancel方法需要判断Try方法是否执行，正常执行Try后方可执行Cancel；  </p>
<p><strong>优化方案：</strong>  </p>
<p>账户A  </p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">try</span>幂等校验</span><br><span class="line">    <span class="keyword">try</span>悬挂处理（即Confirm/Cancel二阶段当中有一个执行了，那么Try阶段则不进行执行）</span><br><span class="line">    检查余额是否够<span class="number">30</span>元</span><br><span class="line">    扣减<span class="number">30</span>元</span><br><span class="line">confirm:</span><br><span class="line">    空</span><br><span class="line">cancel:</span><br><span class="line">    cancel幂等校验</span><br><span class="line">    cancel空回滚处理（如果Try没有执行，那么Cancel就不进行执行）</span><br><span class="line">    增加可用余额<span class="number">30</span>元</span><br></pre></td></tr></table></figure>

<p>账户B  </p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    空</span><br><span class="line"><span class="keyword">confirm</span>:</span><br><span class="line">    <span class="keyword">confirm</span>幂等校验</span><br><span class="line">    正式增加<span class="number">30</span>元</span><br><span class="line">cancel：</span><br><span class="line">    空</span><br></pre></td></tr></table></figure>

<h3 id="Hmily实现TCC事务"><a href="#Hmily实现TCC事务" class="headerlink" title="Hmily实现TCC事务"></a>Hmily实现TCC事务</h3><h4 id="业务说明-1"><a href="#业务说明-1" class="headerlink" title="业务说明"></a>业务说明</h4><p>本实例通过Hmily实现TCC分布式事务，模拟两个账户的转账交易过程。  </p>
<p>两个账户分别在不同的银行（张三在bank1、李四在bank2），bank1、bank2是两个微服务。<br>交易过程是：张三给李四转账指定金额；<br>上述交易步骤，要么一起成功，要么一起失败，必须是一个整体性的事务；  </p>
<h4 id="程序组成部分"><a href="#程序组成部分" class="headerlink" title="程序组成部分"></a>程序组成部分</h4><p>数据库：MySQL-5.7.25（包括bank1和bank2两个数据库）<br>JDK：64位jdk1.8.0_201<br>微服务框架：spring-boot-2.1.3、spring-cloud-Greenwich.RELEASE<br>Hmily：hmily-springcloud.2.0.4-RELEASE<br>seata客户端（RM、TM）：spring-cloud-alibaba-seata-2.1.0.RELEASE<br>seata服务端（TC）：seata-server-0.7.1<br>微服务以及数据库的关系：<br>  dtx/dtx-seata-demo/seata-demo-bank1 银行1，操作张三账户，连接数据库1<br>  dtx/dtx-seata-demo/seata-demo-bank2 银行2，操作李四账户，连接数据库2<br>服务注册中心：dtx/discover-server  </p>
<h4 id="创建数据库-1"><a href="#创建数据库-1" class="headerlink" title="创建数据库"></a>创建数据库</h4><p>创建hmily数据库，用于存储hmily框架记录的数据；  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> <span class="string">'hmily'</span> <span class="built_in">character</span> <span class="keyword">set</span> <span class="string">'utf8'</span> <span class="keyword">collate</span> <span class="string">'utf8_general_ci'</span>;</span><br></pre></td></tr></table></figure>

<h4 id="discover-server-1"><a href="#discover-server-1" class="headerlink" title="discover-server"></a>discover-server</h4><h4 id="导入案例工程dtx-tcc-demo"><a href="#导入案例工程dtx-tcc-demo" class="headerlink" title="导入案例工程dtx-tcc-demo"></a>导入案例工程dtx-tcc-demo</h4><h4 id="dtx-tcc-demo-bank1"><a href="#dtx-tcc-demo-bank1" class="headerlink" title="dtx-tcc-demo-bank1"></a>dtx-tcc-demo-bank1</h4><h4 id="dtx-tcc-demo-bank2"><a href="#dtx-tcc-demo-bank2" class="headerlink" title="dtx-tcc-demo-bank2"></a>dtx-tcc-demo-bank2</h4><h4 id="测试场景"><a href="#测试场景" class="headerlink" title="测试场景"></a>测试场景</h4><h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><p>如果拿TCC事务的处理流程与2PC两阶段提交做比较，2PC通常是在跨库的DB层面，而TCC则在应用层面的处理，需要通过业务逻辑来实现，这种分布式事务的实现的优势在于，可以让<strong>应用自己定义数据操作的粒度，使得降低锁冲突，提高吞吐量称为可能</strong>。  </p>
<p>而不足之处则在于对应用的侵入性非常强，业务逻辑处理的每个分支都需要实现try、confirm、cancel三个操作。<br>此外，其实实现难度也比较大，需要按照网络状态、系统故障等不同的失败原因实现不同的回滚策略。  </p>
<h2 id="分布式事务解决方案之可靠消息最终一致性"><a href="#分布式事务解决方案之可靠消息最终一致性" class="headerlink" title="分布式事务解决方案之可靠消息最终一致性"></a>分布式事务解决方案之可靠消息最终一致性</h2><h3 id="什么是可靠消息最终一致性事务"><a href="#什么是可靠消息最终一致性事务" class="headerlink" title="什么是可靠消息最终一致性事务"></a>什么是可靠消息最终一致性事务</h3><p>可靠消息最终一致性方案是指：当事务发起方执行完成本地事务后并发出一条消息，事务参与者（消息消费者）一定能够接收消息并处理事务成功；此方案强调的是只要消息发给事务参与方，最终事务要达到一致。  </p>
<p>此方案是利用消息中间件来完成。如下图：  </p>
<p>事务发起方（消息生产方）将消息发给消息中间件，事务参与方从消息中间件当中接收消息，事务发起方和消息中间件之间，事务参与方（消息消费方）和消息中间件之间都是通过网络通讯，由于网络通讯的不确定性会导致分布式事务问题。  </p>
<p>因此可靠消息最终一致性要解决一下几个问题：  </p>
<ol>
<li><strong>本地事务与消息发送的原子性问题</strong>  </li>
</ol>
<p>事务的发起方到事务的参与方，这个消息必须可靠；也就是张三必须将消息发送到李四；李四必须能够接受到这个消息；并且这个可靠消息最终一致性最终还要强调一点的是最终一致性；即张三在把这个钱扣掉之后，他会要保证这个消息一定会要发给李四，那么李四接收到这个消息之后就可以进行处理加钱的这个业务逻辑处理；在这过程当中如果李四加钱失败怎么办，张三能够回滚事务吗？不能回滚。所以这个叫做可靠消息最终一致性分成两部分进行解读；一部分是可靠消息；一部分是最终一致性；可靠消息是指消息从张三传给李四，从事务的发起方传给事务的参与方，这个过程需要是可靠的；那么最终一致性是：张三，即事务的发起方，执行完本地事务；并且张三一定保证消息发给李四；那最终李四就需要保证最终一致性即无论如何都要将钱加上；这也就是所说的可靠消息最终一致性；  </p>
<p>本地事务与消息发送的原子性问题即：事务发起方在本地事务执行成功后消息必须发出去，否则就丢弃消息。<br>即实现本地事务和消息发送的原子性，要么都成功，要么都失败；<br>本地事务与消息发送的原子性问题是实现可靠消息最终一致性方案的关键问题：  </p>
<p>先来尝试下这种操作，先发送消息，再操作数据库:  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span> <span class="keyword">transaction</span>:</span><br><span class="line">        //<span class="number">1.</span>发送MQ</span><br><span class="line">        //<span class="number">2.</span>数据库操作</span><br><span class="line"><span class="keyword">commit</span> <span class="keyword">transaction</span>;</span><br></pre></td></tr></table></figure>

<p>这种情况下无法保证数据库操作与发送消息的一致性，因为可能发送消息成功，数据库操作失败；  </p>
<p>你立马想到第二种方案，先进行数据库操作，再发送消息：  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span> <span class="keyword">transaction</span>:</span><br><span class="line">        //<span class="number">1.</span>数据库操作</span><br><span class="line">        //<span class="number">2.</span>发送MQ</span><br><span class="line"><span class="keyword">commit</span> <span class="keyword">transaction</span>;</span><br></pre></td></tr></table></figure>

<p>这种情况下貌似没有问题，如果发送MQ消息失败，就会抛出异常，导致数据库事务回滚。<br>但如果是超时异常，数据库回滚，但是MQ已经正常发送出去了，同样就会导致不一致。  </p>
<ol start="2">
<li><strong>事务参与方接受消息的可靠性</strong></li>
</ol>
<p>事务参与方必须能够从消息队列接收到消息，如果接收消息失败可以重复接收消息。  </p>
<ol start="3">
<li><strong>消息重复消费的问题</strong>  </li>
</ol>
<p>由于网络的存在，若某一个消费结点超时但是消费成功，此时消息中间件会重复投递此消息，就导致了消息的重复消费。<br>要解决消息重复消费的问题就要实现事务参与方的方法幂等性。  </p>
<h3 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h3><p>上节讨论了可靠消息最终一致性事务方案需要解决的问题，本节讨论具体的解决方案；  </p>
<h4 id="本地消息表方案"><a href="#本地消息表方案" class="headerlink" title="本地消息表方案"></a>本地消息表方案</h4><p>本地消息表这个方案最初是eBay提出的，此方案的核心是通过本地事务保证数据业务操作和消息的一致性，然后通过定时任务将消息发送至消息中间件，待确认消息发送给消费成功再将消息删除；  </p>
<p>下面以注册送积分为例来说明：  </p>
<p>下例共有两个微服务交互，用户服务和积分服务，用户服务负责添加用户，积分服务负责增加积分。  </p>
<p>交互流程如下:  </p>
<ol>
<li><strong>用户注册</strong>  </li>
</ol>
<p>用户服务在本地新增用户和增加“积分消息日志”。（用户表和消息表通过本地事务保证一致）  </p>
<p>下边是伪代码：  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span> <span class="keyword">transaction</span>;</span><br><span class="line">      //1.新增用户</span><br><span class="line">      //2.存储积分消息日志</span><br><span class="line"><span class="keyword">commit</span> <span class="keyword">transaction</span>;</span><br></pre></td></tr></table></figure>

<p>这种情况下，本地数据库操作与存储积分消息日志处于同一个事务中，本地数据库操作与记录消息日志操作具备原子性。  </p>
<ol start="2">
<li><strong>定时任务扫描日志</strong>  </li>
</ol>
<p>如何保证将消息发送给消息队列？  </p>
<p>经过第一步消息已经写到消息日志表中，可以启动独立的线程，定时对消息日志表中的消息进行扫描并发送至消息中间件，在消息中间件反馈发送成功后删除该消息日志，否则等待定时任务下一周期重试。  </p>
<ol start="3">
<li><strong>消费消息</strong>  </li>
</ol>
<p>如何保证消费者一定能消费到消息？  </p>
<p>这里可以使用MQ的Ack（即消息确认机制）机制，消费者监听MQ，如果消费者接收到消息并且业务处理完成后向MQ发送Ack（即消息确认），此时说明消费者正常消费消息完成，MQ将不再向消费者推送消息，否则消费者户不断重试向消费者来发送消息。  </p>
<p>积分服务接收到“增加积分”消息，开始增加积分，积分增加成功后向消息中间件回应Ack，否则消息中间件将重复投递此消息；  </p>
<p>由于消息会重复投递，积分服务的“增加积分”功能需要实现幂等性；  </p>
<h4 id="RocketMQ事务消息方案"><a href="#RocketMQ事务消息方案" class="headerlink" title="RocketMQ事务消息方案"></a>RocketMQ事务消息方案</h4><p>RocketMQ是一个来自阿里的分布式消息中间件。  </p>
<p>于2012年开源，并在2017年正式成为Apache顶级项目。  </p>
<p>据了解，包括阿里云上的消息产品以及收购的子公司在内，阿里集团的消息产品全线都运行在RocketMQ之上，并且最近几年的双十一大促中，RocketMQ都有抢眼表现。<br>Apache RocketMQ4.3之后的版本正式支持事务消息，为分布式事务实现提供了便利性支持。  </p>
<p>RocketMQ事务消息设计则主要是为了解决Producer端的消息发送与本地事务执行的原子性问题，RocketMQ的设计中broker与producer端的双向通信能力，使得broker天生可以作为一个事务协调者存在；<br>而RocketMQ本身提供的存储机制为事务消息提供了持久化能力；<br>RocketMQ的高可用机制以及可靠消息设计则为事务消息在系统发生异常时依然能够保证达成事务的最终一致性；<br>在RocketMQ4.3后实现了完整的事务消息，实际上其实是对本地消息表的一个封装，将本地消息表移动到MQ内部，解决Producer端的消息发送与本地事务执行的原子性问题。  </p>
<p>执行流程如下：  </p>
<p>为方便理解，还是以注册送积分这个例子来描述整个流程。  </p>
<p>Producer即MQ发送方，本例中是用户服务，负责新增用户；<br>MQ订阅方即消息消费方，本例中是积分服务，负责新增积分。  </p>
<ol>
<li>Producer发送事务消息。</li>
</ol>
<p>Producer（MQ发送方）发送事务消息至MQ Server，MQ Server将消息标记为Prepared（预备状态），注意此时这条消息消费者（MQ订阅方）是无法消费得到的。  </p>
<p>本例中，Producer发送“增加积分消息”到MQ Server。  </p>
<ol start="2">
<li>MQ Server回应消息发送成功</li>
</ol>
<p>MQ Server接受到Producer发送的消息则回应发送成功表示MQ已经接收到消息。  </p>
<ol start="3">
<li>Producer执行本地事务</li>
</ol>
<p>Producer端执行业务代码逻辑，通过本地数据库事务控制。<br>本例中，Producer执行添加用户操作。  </p>
<ol start="4">
<li>消息投递</li>
</ol>
<p>若Producer本地事务执行成功，则自动向MQ Server发送commit消息；<br>MQ Server接收到commit消息后将“增加积分消息”状态标记为可消费，此时MQ订阅方（积分服务）即正常消费消息；<br>若Producer本地事务执行失败则自动向MQ Server发送rollback消息，MQ Server接收到rollback消息后将删除“增加积分消息”；  </p>
<p>MQ订阅方（积分服务）消费消息，消费成功则向MQ回应Ack；否则将重复接收消息，这里ack默认自动回应，即程序执行正常则自动回应ack。  </p>
<ol start="5">
<li>事务回查</li>
</ol>
<p>如果执行Producer端本地事务过程中，执行端挂掉，或者超时，MQ Server将会不停的询问同组的其他Producer来获取事务执行状态，这个过程叫做<strong>事务回查</strong>，MQ Server会根据事务回查结果来决定是否投递消息。  </p>
<p>以上主干流程已经由RocketMQ实现，对于用户来说，用户需要分别实现本地事务执行以及本地事务回查方法，因此只需要关注本地事务的执行状态即可。  </p>
<p>RocketMQ提供的RocketMQLocalTransactionListener接口：  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RocketMQLocalTransactionListener</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    发送prepare消息成功则此方法被调用，该方法用于执行本地事务</span></span><br><span class="line"><span class="comment">    <span class="doctag">@param</span> msg 回传的消息，利用transactionId即可获取到该消息的唯一id</span></span><br><span class="line"><span class="comment">    <span class="doctag">@param</span> arg 调用send方法时传递的参数，当send时候，若有额外的参数可以传递到send方法中，这里能获取到</span></span><br><span class="line"><span class="comment">    <span class="doctag">@return</span> 返回事务状态，COMMIT：提交  ROLLBACK：回滚 UNKNOW：回调</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">    RocketMQLocalTransactionState executeLocalTransaction（Message msg，Object arg）;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    <span class="doctag">@param</span> msg 通过获取transactionId来判断这条消息的本地事务执行状态</span></span><br><span class="line"><span class="comment">    <span class="doctag">@return</span> 返回事务状态  COMMIT：提交  ROLLBACK：回滚 UNKNOW：回调</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  RocketMQLocalTransactionState checkLocalTransaction（Message msg）;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>发送事务消息</li>
</ul>
<p>以下是RocketMQ提供用于发送事务消息的API：  </p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TransactionMQProducer producer=<span class="keyword">new</span> <span class="constructor">TransactionMQProducer(<span class="string">"ProducerGroup"</span>)</span>;</span><br><span class="line">producer.set<span class="constructor">NamesAddr(<span class="string">"127.0.0.1:9876"</span>)</span>;</span><br><span class="line">producer.start<span class="literal">()</span>;</span><br><span class="line"><span class="comment">//设置TransactionListener实现</span></span><br><span class="line">producer.set<span class="constructor">TransactionListener(<span class="params">transactionListener</span>)</span>;</span><br><span class="line"><span class="comment">//发送事务消息</span></span><br><span class="line">SendResult sendResult=producer.send<span class="constructor">MessageTransaction(<span class="params">msg</span>,<span class="params">null</span>)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="RocketMQ实现可靠消息最终一致性事务"><a href="#RocketMQ实现可靠消息最终一致性事务" class="headerlink" title="RocketMQ实现可靠消息最终一致性事务"></a>RocketMQ实现可靠消息最终一致性事务</h3><h4 id="业务说明-2"><a href="#业务说明-2" class="headerlink" title="业务说明"></a>业务说明</h4><p>本示例通过RocketMQ中间件实现可靠消息最终一致性分布式事务，模拟两个账户的转账交易过程。  </p>
<p>两个账户在分别不同的银行（张三在bank1、李四在bank2），bank1、bank2是两个微服务。<br>交易过程是：张三给李四转账指定金额。  </p>
<p>上述交易步骤，张三扣减金额与给bank2发转账消息，两个操作必须是一个整体性的事务（原子性）；  </p>
<h4 id="程序组成部分-1"><a href="#程序组成部分-1" class="headerlink" title="程序组成部分"></a>程序组成部分</h4><p>数据库：MySQL-5.7.25（包括bank1和bank2两个数据库）<br>JDK：64位jdk1.8.0_201<br>rocketmq 服务端: RocketMQ-4.5.0<br>rocketmq 客户端：RocketMQ-Spring-Boot-starter.2.0.2-RELEASE<br>微服务框架：spring-boot-2.1.3、spring-cloud-Greenwich.RELEASE<br>微服务以及数据库的关系：<br>  dtx/dtx-seata-demo/seata-demo-bank1 银行1，操作张三账户，连接数据库1<br>  dtx/dtx-seata-demo/seata-demo-bank2 银行2，操作李四账户，连接数据库2  </p>
<p>本示例程序技术架构如下：  </p>
<p>交互流程如下：<br>1、Bank1向MQ Server发送转账消息<br>2、Bank1执行本地事务，扣减金额<br>3、Bank2接受消息，执行本地事务，添加金额  </p>
<h4 id="创建数据库-2"><a href="#创建数据库-2" class="headerlink" title="创建数据库"></a>创建数据库</h4><h4 id="启动RocketMQ"><a href="#启动RocketMQ" class="headerlink" title="启动RocketMQ"></a>启动RocketMQ</h4><h4 id="导入dtx-txmsg-demo"><a href="#导入dtx-txmsg-demo" class="headerlink" title="导入dtx-txmsg-demo"></a>导入dtx-txmsg-demo</h4><h4 id="dtx-txmsg-demo-bank1"><a href="#dtx-txmsg-demo-bank1" class="headerlink" title="dtx-txmsg-demo-bank1"></a>dtx-txmsg-demo-bank1</h4><h4 id="dtx-txmsg-demo-bank2"><a href="#dtx-txmsg-demo-bank2" class="headerlink" title="dtx-txmsg-demo-bank2"></a>dtx-txmsg-demo-bank2</h4><h4 id="测试场景-1"><a href="#测试场景-1" class="headerlink" title="测试场景"></a>测试场景</h4><ul>
<li>bank1本地事务失败，则bank1不发送转账消息</li>
<li>bank2接收转账消息失败，会进行重试发送消息</li>
<li>bank2多次消费同一个消息，实现幂等</li>
</ul>
<h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><p>可靠消息最终一致性就是保证消息从生产方经过消息中间件传递到消息方的一致性，本案例使用了RocketMQ作为消息中间件，RocketMQ主要解决了两个功能：  </p>
<p>1、本地事务与消息发送的原子性问题；<br>2、事务参与方接收消息的可靠性。  </p>
<p>可靠消息最终一致性事务适合执行周期长且实时性要求不高的场景。<br>引入消息机制后，同步的事务操作变为基于消息执行的异步操作，避免了分布式事务中的同步阻塞操作的影响，并实现了两个服务的解耦。  </p>
<h2 id="分布式解决方案之最大努力通知"><a href="#分布式解决方案之最大努力通知" class="headerlink" title="分布式解决方案之最大努力通知"></a>分布式解决方案之最大努力通知</h2><h3 id="什么是最大努力通知"><a href="#什么是最大努力通知" class="headerlink" title="什么是最大努力通知"></a>什么是最大努力通知</h3><p>最大努力通知也是一种解决分布式事务的方案，下边是一个充值的例子。  </p>
<p>交互流程：<br>1、账户系统调用充值系统接口；<br>2、充值系统完成支付处理向账户系统发起充值结果通知；若通知失败，则充值系统按照策略进行重复通知；<br>3、账户系统接收到充值结果通知修改充值状态；<br>4、账户系统未接收到通知会主动调用充值系统的接口查询充值结果。  </p>
<p>通过上边的例子，总结最大努力通知方案的目标：  </p>
<p>目标：发起通知方通过一定的机制最大努力将业务处理结果通知到接收方；  </p>
<p>具体包括：<br>1、有一定的消息重复通知机制；<br>  因为接受通知方可能没有接收到通知，此时要有一定的机制对消息重复通知；<br>2、消息校对机制<br>  如果是最大努力也没有通知到接收方，或者接收方消费消息后要再次消费，此时可由接收方主动向通知方查询信息来满足需求。  </p>
<p>这个跟我们信666当中的交易模块很相似，也是进行查询交易结果的时候，如果在一定的查询次数下没有查找得到结果即一分钟查询多少次等，那么就更改成2分钟查询多少次；两分钟查询后仍然没有结果就再次换成3分钟查询多少次；这个一分钟两分钟三分钟，是间隔，间隔时间；因为交易量大的缘故，所以也是为了减轻下服务器压力；是的有些是异步主动去通知下游系统，就是接入第三方支付的时候，上游渠道可能会需要你提供一个异步回调的一个接口，那么这个接口用于交易结果通知或者其他的绑卡结果通知等这种，你可以提供一个接口，当然了也可以提供一个假的接口，就是系统中不存在此接口也行；当然了如果不存在该接口的话，那么就需要去使用系统当中的查询机制，即主动去查询上游渠道系统当中该笔交易的交易结果。在第三方这种支付方面就大概使用了最大努力通知的方式实现分布式事务方案。很多的第三方支付会去提供这个订单/交易结果查询的这样一个接口；而我们自己对接下游就比较缺德了，就每次我们向上游查询完交易结果之后，在处理完业务逻辑后，我们就通过try catch住，http直接发送一次交易结果给上送了回调地址接口的下游；没有上送回调接口就让他们自己来查询，上送了的话我们就回调一次；就这样。  </p>
<p>最大努力通知与可靠消息一致性有什么不同？  </p>
<p>1、解决方案思想不同  </p>
<p>  可靠消息一致性，发起通知方需要保证将消息发送出去，并且将消息发到接收通知方，消息的可靠性关键由发起通知方来保证。  </p>
<p>  最大努力通知，发起通知方尽最大的努力将业务处理结果通知给接收通知方，但是可能消息接收不到，此时需要接收通知方主动调用发起通知方的接口查询业务处理结果，通知的可靠性在于接收通知方。  </p>
<p>2、两者的业务应用场景不同  </p>
<p>  可靠消息一致性关注的是交易过程的事务一致，以异步的方式完成交易。  </p>
<p>  最大努力通知关注的是交易后的通知事务，即将交易结果可靠的通知出去。  </p>
<p>3、技术解决方向不同  </p>
<p>  可靠消息一致性要解决消息从发出到接收的一致性，即消息发出并且被接收到。  </p>
<p>  最大努力通知无法保证消息从发出到接收的一致性，只提供消息接收的可靠性机制，可靠机制是，最大努力的将消息通知给接收方，当消息无法被接收方接收时，由接收方主动查询消息（业务处理结果）；  </p>
<h3 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h3><p>通过对最大努力通知的理解，采用MQ的ack机制就可以实现最大努力通知；  </p>
<p>方案一：  </p>
<p>本方案是利用MQ的ack机制由MQ向接收通知方发送通知，流程如下：  </p>
<ol>
<li>发起通知方将通知发给MQ；  </li>
</ol>
<p>使用普通消息机制将通知发给MQ；  </p>
<p>注意:如果消息没有发出去可由接收通知方主动请求发起通知方查询业务执行结果。  </p>
<ol start="2">
<li><p>接收通知方监听MQ；</p>
</li>
<li><p>接收通知方接收消息，业务处理完成回应Ack；  </p>
</li>
<li><p>接收通知方若没有会用ack则MQ会重复通知；  </p>
</li>
</ol>
<p>MQ会<strong>按照间隔1min、5min、10min、30min、1h、2h、5h、10h的方式，逐步拉大通知间隔</strong>（如果MQ采用RocketMQ，在broker中可以进行配置），直到达到通知要求的时间窗口上限。  </p>
<ol start="5">
<li>接收通知方可通过消息校对接口来校对消息的一致性。  </li>
</ol>
<p>方案二：  </p>
<p>本方案也是利用MQ的Ack机制，与方案一不同的是应用程序向接收通知方发送通知，如下图：  </p>
<p>交互流程如下:  </p>
<ol>
<li><p>发起通知方将通知发给MQ；</p>
<p>使用可靠消息一致方案中的事务消息保证本地事务与消息的原子性，最终将通知先发给MQ。  </p>
</li>
<li><p>通知程序监听MQ，接收MQ的消息；  </p>
<p>方案1中接收通知方直接监听MQ，方案2中由通知程序监听MQ；  </p>
<p>通知程序若没有回应Ack则MQ会重复通知；  </p>
</li>
<li><p>通知程序通过互联网接口协议（如http、webservice）调用接受通知方案接口，完成通知。  </p>
<p>通知程序调用接受通知方案接口成功就表示通知成功，即MQ消费成功，MQ将不再向通知程序投递通知消息。  </p>
</li>
<li><p>接受通知方可通过消息校对接口来校对消息的一致性。  </p>
</li>
</ol>
<p>方案1和方案2的不同点：  </p>
<p>（1）方案1中接收通知方与MQ接口，即接收通知方监听MQ，次方案主要应用与内部应用之间的通知；<br>（2）方案2中由通知程序与MQ接口，通知程序监听MQ，收到MQ的消息后，由通知程序通过互联网接口协议调用接收通知方。此方案主要应用于外部应用之间的通知，例如支付宝、微信的支付结果通知。  </p>
<p>方案一针对内部系统；方案二针对外部系统；  </p>
<h3 id="RocketMQ实现最大努力通知型事务"><a href="#RocketMQ实现最大努力通知型事务" class="headerlink" title="RocketMQ实现最大努力通知型事务"></a>RocketMQ实现最大努力通知型事务</h3><h4 id="业务说明-3"><a href="#业务说明-3" class="headerlink" title="业务说明"></a>业务说明</h4><p>本示例通过RocketMQ中间件实现最大努力通知型分布式事务，模拟充值过程。  </p>
<p>本案例有账户系统和充值系统两个微服务，其中账户系统的数据库是bank1数据库，其中有张三账户。<br>充值系统的数据库使用bank1_pay数据库，记录了账户的充值记录。  </p>
<p>业务流程如下图：  </p>
<p>交互流程如下：  </p>
<ol>
<li>用户请求充值系统进行充值；  </li>
<li>充值系统完成充值将充值结果发送给MQ。</li>
<li>账户系统监听MQ，接收充值结果通知，如果接收不到消息，MQ会重复发送通知。接收到充值结果通知账户系统增加充值金额。  </li>
<li>账户系统也可以主动查询充值系统的充值查询接口，增加金额。  </li>
</ol>
<h4 id="程序组成部分-2"><a href="#程序组成部分-2" class="headerlink" title="程序组成部分"></a>程序组成部分</h4><p>数据库：MySQL-5.7.25（包括bank1和bank1_pay两个数据库）<br>JDK：64位jdk1.8.0_201<br>rocketmq 服务端: RocketMQ-4.5.0<br>rocketmq 客户端：RocketMQ-Spring-Boot-starter.2.0.2-RELEASE<br>微服务框架：spring-boot-2.1.3、spring-cloud-Greenwich.RELEASE<br>微服务以及数据库的关系：<br>  dtx/dtx-notifymsg-demo/dtx-notifymsg-demo-bank1 银行1，操作张三账户，连接数据库bank1<br>  dtx/dtx-notifymsg-demo/dtx-notifymsg-demo-pay 银行2，操作李四账户，连接数据库bank1_pay  </p>
<p>交互流程如下：  </p>
<p>1、用户请求充值系统进行充值；<br>2、充值系统完成充值将充值结果发给MQ；<br>3、账户系统监听MQ，接收充值结果通知，如果接收不到消息，MQ会重复发送通知。接收到充值结果通知账户系统增加充值金额。<br>4、账户系统也可以主动查询传给你藕汁系统的充值结果查询接口，增加金额。  </p>
<h4 id="创建数据库-3"><a href="#创建数据库-3" class="headerlink" title="创建数据库"></a>创建数据库</h4><h4 id="启动RocketMQ-1"><a href="#启动RocketMQ-1" class="headerlink" title="启动RocketMQ"></a>启动RocketMQ</h4><h4 id="导入dtx-notifymsg-demo"><a href="#导入dtx-notifymsg-demo" class="headerlink" title="导入dtx-notifymsg-demo"></a>导入dtx-notifymsg-demo</h4><h4 id="dtx-notifydemo-pay"><a href="#dtx-notifydemo-pay" class="headerlink" title="dtx-notifydemo-pay"></a>dtx-notifydemo-pay</h4><h4 id="dtx-notifydemo-bank1"><a href="#dtx-notifydemo-bank1" class="headerlink" title="dtx-notifydemo-bank1"></a>dtx-notifydemo-bank1</h4><h4 id="测试场景-2"><a href="#测试场景-2" class="headerlink" title="测试场景"></a>测试场景</h4><ul>
<li>充值系统充值成功，账户系统主动查询充值结果，修改中户金额</li>
<li>充值系统充值成功，发送消息，账户系统接收消息，修改账户金额。</li>
<li>账户系统修改账户金额幂等测试。</li>
</ul>
<h3 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a>小结</h3><p>最大努力通知方案是分布式中对已执行要求最低的一种，适用于一些最终一致性时间敏感度低的业务；<br>最大努力通知方案需要实现如下功能：  </p>
<ol>
<li>消息重复通知机制</li>
<li>消息校对机制</li>
</ol>
<h2 id="分布式事务综合案例"><a href="#分布式事务综合案例" class="headerlink" title="分布式事务综合案例"></a>分布式事务综合案例</h2><p>前边已经学习了四种分布式事务解决方案，2PC，TCC，可靠消息最终一致性，最大努力通知，每种解决方案通过案例开发进行学习，本章节结合互联网金融项目中的业务场景，来进行分布式事务解决方案可行性分析。  </p>
<h3 id="系统介绍"><a href="#系统介绍" class="headerlink" title="系统介绍"></a>系统介绍</h3><h4 id="P2P介绍"><a href="#P2P介绍" class="headerlink" title="P2P介绍"></a>P2P介绍</h4><p>P2P金融又叫P2P信贷，其中P2P是peer-to-peer或者person-to-person的缩写，意思是：个人对个人。  </p>
<p>P2P金融指的是个人与个人之间的小额借贷交易，一般需要借助电子商务专业网络平台帮助借贷双方确立借贷关系并完成相关交易手续。  </p>
<p>借款者可以自行发布借款消息，包括金额、利息、还款方式和时间，实现自助式借款；<br>投资者根据借款人发布的消息，自行决定出借金额，实现自助式借贷。  </p>
<p>目前，国家对P2P行业的监控与规范性控制越来越严格，出台了很多政策来对其专项整治。<br>并主张采用“银行存管模式”来规避P2P平台挪用借投人资金的风险，通过银行开发的“银行存管系统”管理投资者的资金，<strong>每位P2P平台用户在银行的存管系统内都会有一个独立账号，</strong>平台来管理交易，做到资金和交易分开，让P2P平台不能接触到资金，就可以一定程度上避免资金被挪用的风险。  </p>
<p>什么是银行存管模式？  </p>
<p>银行存管模式涉及到2套账户体系，P2P平台和银行各有一套账户体系。<br>投资人在P2P平台注册后，会同时跳转到银行再开一个电子账户，2个账户之间有一一对应的关系。<br>当投资人投资时，资金进入的是平台在银行为投资人开设的二级账户当中，每一笔交易，是银行在投资人与借款人之间的交易划转，P2P平台仅能看到信息的流动。  </p>
<h4 id="总体业务流程"><a href="#总体业务流程" class="headerlink" title="总体业务流程"></a>总体业务流程</h4><h4 id="业务术语"><a href="#业务术语" class="headerlink" title="业务术语"></a>业务术语</h4><table>
  <thead>
    <tr>
      <th>术语</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>银行存管模式</td>
      <td>此种模式下，涉及到2套账户体系，P2P平台和银行各有一套账户体系。投资人在P2P平台注册后会同时跳转到银行再开一个电子账户，2个账户之间有一个一一对应的关系。当投资人投资时，资金进入的是平台在银行为投资人开设的二进账户中，每一笔交易，是由银行在投资人与借款人之间的交易划转，P2P平台仅能看到信息的流动。</td>
    </tr>
    <tr>
      <td>标的</td>
      <td>P2P业内，习惯把借款人的投资项目称之为“标的”</td>
    </tr>
    <tr>
      <td>发标</td>
      <td>借款人在P2P平台中创建并发布“标的”过程</td>
    </tr>
    <tr>
      <td>投标</td>
      <td>投资人在认可相关借款人之后进行的一种借贷行为，对自己中意的借款标的进行投资操作，一个借款标可由单个投资人或多个投资人承接。</td>
    </tr>
    <tr>
      <td>满标</td>
      <td>单笔借款标筹集齐所有借款资金即为满标，计息时间是以标满当日开始计息，投资人较多的平台多数会当天满标。</td>
    </tr>
  </tbody>
</table>

<h4 id="模块说明"><a href="#模块说明" class="headerlink" title="模块说明"></a>模块说明</h4><ul>
<li><p><strong>统一账号服务</strong>  </p>
<p>用户的登录账户、密码、角色、权限、资源等系统级信息的管理，不包含用户业务信息。  </p>
</li>
<li><p><strong>用户中心</strong>  </p>
<p>提供用户业务信息的管理，如会员信息、实名认证信息、绑定银行卡信息等，“用户中心”的每个用户与“<strong>统一账号服务</strong>”中的账号关联。  </p>
</li>
<li><p><strong>交易中心</strong>  </p>
<p>提供发标、投标等业务。  </p>
</li>
<li><p><strong>还款业务</strong>  </p>
<p>提供还款计划的生成、执行、记录与归档。  </p>
</li>
<li><p><strong>银行存管系统（模拟）</strong>  </p>
<p>  模拟银行存管系统，进行资金的存管，划转。  </p>
</li>
</ul>
<h3 id="注册账号案例分析"><a href="#注册账号案例分析" class="headerlink" title="注册账号案例分析"></a>注册账号案例分析</h3><h4 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a>业务流程</h4><p>  采用用户、账号分离设计（这样设计的好处是：当用户的业务信息发生变化时，不会影响的认证、授权等系统机制），因此需要保证用户信息与账号信息的一致性。  </p>
<p>  用户向用户中心发起注册请求，用户中心保存用户业务信息，然后通知统一账号服务新建该用户所对应登录账号。  </p>
<h4 id="解决方案分析"><a href="#解决方案分析" class="headerlink" title="解决方案分析"></a>解决方案分析</h4><p>  针对注册业务，如果用户与账户信息不一致，则会导致严重问题，因此该业务对一致性要求较为严格，即当用户服务和账号服务任意一方出现问题都需要回滚事务。  </p>
<p>  根据上述需求进行解决方案分析：  </p>
<ol>
<li><p>采用可靠消息一致性方案  </p>
<p> 可靠消息一致性要求只要消息发出，事务参与者接到消息就要将事务执行成功，不存在回滚的要求，所以不适用。  </p>
</li>
<li><p>最大努力通知方案</p>
<p> 最大努力通知表示发起通知方执行完本地事务后将结果通知给事务参与者，即使事务参与者执行业务处理失败发起通知方也不会回滚事务，所以不适用。  </p>
</li>
<li><p>采用Seata实现2PC  </p>
<p> 在用户中心发起去全局事务，统一账户服务为事务参与者，用户中心和统一账户服务只要由一方出现问题则全局事务回滚，符合要求。  </p>
<p> 实现方法如下：  </p>
<ol>
<li>用户中心添加用户信息，开启全局事务；  </li>
<li>统一账号服务添加账号信息，作为事务参与者；  </li>
<li>其中一方执行失败Seata对SQL进行逆操作删除用户信息和账号信息，实现回滚。  </li>
</ol>
<ol start="4">
<li><p>采用Hmily实现TCC</p>
<p>TCC也可以实现用户中心和统一账户服务只要有一方出现问题则全局事务回滚，符合要求。  </p>
<p>实现方法如下：  </p>
<ol>
<li><p>用户中心  </p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>：</span><br><span class="line">    添加用户，状态为不可用</span><br><span class="line"><span class="keyword">confirm</span>：</span><br><span class="line">    更新用户状态为可用</span><br><span class="line">cance<span class="variable">l:</span></span><br><span class="line">    删除用户</span><br></pre></td></tr></table></figure>
</li>
<li><p>统一账号服务</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">try:</span></span><br><span class="line">    添加账号，状态为不可用</span><br><span class="line"><span class="symbol">confirm:</span></span><br><span class="line">    更新账号状态为可用</span><br><span class="line"><span class="symbol">cancel:</span></span><br><span class="line">    删除账号</span><br></pre></td></tr></table></figure>

</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="存管开户"><a href="#存管开户" class="headerlink" title="存管开户"></a>存管开户</h3><h4 id="业务流程-1"><a href="#业务流程-1" class="headerlink" title="业务流程"></a>业务流程</h4><p>根据政策要求，P2P业务必须让银行存管资金，用户的资金在银行存管系统的账户中，而不在P2P平台中，因此用户要在银行存管系统开户。  </p>
<p>用户向用户中心提交开户资料，用户中心生成开户请求号并重定向至银行存管系统开户页面。<br>用户设置存管密码并确认开户后，银行存管立即返回“请求已受理”。<br>在某一时刻，银行存管系统处理完该开户请求后，将调用毁掉地址通知处理结果，若通知失败，则按照一定策略重试通知。<br>同时，以你航存管系统应提供<strong>开户结果查询的接口</strong>，以供用户中心校对结果。  </p>
<h4 id="解决方案分析-1"><a href="#解决方案分析-1" class="headerlink" title="解决方案分析"></a>解决方案分析</h4><p>P2P平台的用户中心与银行存管系统之间属于跨系统交互，银行存管系统属于外部系统；用户中心无法干预银行存管系统；<br>所以用户中心只能在收到银行存管系统的业务处理结果通知后积极处理，开户后的使用情况完全由用户中心来控制。<br>根据上述需求来进行解决方案分析：  </p>
<ol>
<li><p>采用Seata实现2PC</p>
<p>需要侵入银行存管系统的数据库，由于它是外部系统，所以不适用。  </p>
</li>
<li><p>采用Hmily实现TCC</p>
<p>TCC侵入性更强，所以不适用；  </p>
</li>
<li><p>基于MQ的可靠消息一致性</p>
<p>如果让银行存管系统监听MQ则不合适，因为它是外部系统。  </p>
<p>如果银行存管系统将消息发给MQ用户中心监听MQ是可以的；<br>但是由于相对银行存管系统来说用户中心属于外部系统，银行存管系统是不会让外部系统直接监听自己的MQ的，基于MQ的通信协议也不方便外部系统间的交互，所以本方案不合适。  </p>
</li>
<li><p>最大努力通知方案</p>
<p> 银行存管系统内部使用MQ，银行存管系统处理完业务后将处理结果发给MQ。<br> 由银行存管系统的通知程序专门发送通知方</p>
</li>
</ol>
<h3 id="满标审核"><a href="#满标审核" class="headerlink" title="满标审核"></a>满标审核</h3><h4 id="业务流程-2"><a href="#业务流程-2" class="headerlink" title="业务流程"></a>业务流程</h4><p>在借款人标的募集所有的资金后，P2P运营管理员审批该标的，触发放款，并开启还款流程。<br>管理员对某标的满标审批通过，交易中心修改标的状态为“还款中”，同时还要通知还款服务生成还款计划。  </p>
<h4 id="解决方案分析-2"><a href="#解决方案分析-2" class="headerlink" title="解决方案分析"></a>解决方案分析</h4><p>生成还款计划是一个执行时长较长的业务，不建议阻塞主业务流程，此业务对一致性要求较低。<br>根据上述需求进行解决方案分析：  </p>
<ol>
<li><p>采用Seata实现2PC</p>
<p>Seata在食物执行过程中或进行数据库资源锁定，由于事务执行时长较长会将资源锁定较长时间，所以不适用。  </p>
</li>
<li><p>采用Hmily实现TCC</p>
<p>本需求对业务一致性要求较低，因为生成还款计划的时长较长，所以不要求交易中心修改标的状态为“还款中”就立即生成还款计划，所以本方案不适用；  </p>
</li>
<li><p>基于MQ的可靠消息一致性</p>
<p>满标审批通过后，由交易中心修改标的状态为“还款中”并且向还款服务发送消息，还款服务接收到消息开始生成还款计划，基本与MQ的可靠消息一致性方案适用此场景。  </p>
</li>
<li><p>最大努力通知方案</p>
<p>满标审批通过后，由交易中心向还款服务发送通知要求生成还款计划，还款服务并且对外提供还款计划生成结果校对接口供其他服务查询，最大努力通知方案也适用本场景。  </p>
</li>
</ol>
<h2 id="课程总结"><a href="#课程总结" class="headerlink" title="课程总结"></a>课程总结</h2><ul>
<li><strong>重点知识回顾：</strong>  </li>
</ul>
<p>事务的基本概念以及本地事务特性。  </p>
<p>CAP、BASE理论的概念。  </p>
<p>2PC、TCC、可靠消息最终一致性、最大努力通知各个类型原理以及其特性；  </p>
<p>不同分布式事务类型的应用场景讨论。  </p>
<p>RocketMQ事务消息机制；  </p>
<p>Seata与传统XA原理上的差异。  </p>
<ul>
<li><strong>分布式事务对比分析：</strong>  </li>
</ul>
<p>在学习各种分布式事务的解决方案后，了解到各种方案的优缺点：  </p>
<p><strong>2PC</strong>最大的诟病就是一个阻塞协议。RM在执行分支事务后需要等待TM的决定，此服务会阻塞并锁定资源。<br>由于其阻塞机制和最差时间复杂高度。<br>因此，这种实际不能适应着事务涉及的服务数量增加而扩展的需要，很难用于并发较高以及子事务生命周期较长（long-running transactions）的分布式服务中。  </p>
<p>如果拿<strong>TCC</strong>事务的处理流程与2PC两阶段提交作比较，2PC同行都是在跨库的DB层面，而TCC则是在应用层面的处理，需要通过业务逻辑来实现。<br>这种分布式事务的实现方式的又是在于，可以让<strong>应用自己定义数据操作的粒度，使得降低锁冲突、提高吞吐量称为可能</strong>。<br>而不足之处则在于对应用的侵入性非常强，业务逻辑的每个分支都需要实现try、confirm、cancel三个操作。<br>此外，其实现难度也比较大，需要按照网络状态，系统故障等不同的失败原因实现不同的回滚策略。<br>典型的使用场景：满xx/登录送优惠券等。  </p>
<p><strong>可靠消息最终一致性事务</strong>适合知性周期长且实时性要求不高的场景。<br>引入消息机制后，同步的事务操作变为基于消息执行的异步操作，避免了分布式事务中的同步阻塞操作的影响，并实现了两个服务的解耦。<br>典型的使用场景：注册送积分、登录送优惠券等。  </p>
<p><strong>最大努力通知</strong> 是分布式事务中要求最低的一种，适用于一些最终一致性敏感度低的业务；<br>允许发起通知方处理业务失败，在接收通知方收到通知后积极进行失败处理，无论发起通知方如何处理结果都会不影响到接收通知方的后续处理；<br>发起通知方需要提供查询执行情况接口，用于接收通知方校对结果。<br>典型的使用场景：银行通知、支付结果通知等；  </p>
<table>
  <thead>
    <tr>
      <th></th>
      <th>2PC</th>
      <th>TCC</th>
      <th>可靠消息</th>
      <th>最大努力通知</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>一致性</td>
      <td>强一致性</td>
      <td>最终一致</td>
      <td>最终一致</td>
      <td>最终一致</td>
    </tr>
    <tr>
      <td>吞吐量</td>
      <td>低</td>
      <td>中</td>
      <td>高</td>
      <td>高</td>
    </tr>
    <tr>
      <td>实现复杂度</td>
      <td>易</td>
      <td>难</td>
      <td>中</td>
      <td>易</td>
    </tr>
  </tbody>
</table>

<p><strong>总结：</strong>  </p>
<p>在条件允许的情况下，尽可能选择本地事务单数据源，因为它减少了网络交互带来的性能消耗，且避免了数据弱一致性带来的种种问题。<br>若某系统频繁且不合理的使用分布式事务，应首先从整体设计角度观察服务的拆分是否合理，是否高内聚低耦合？是否粒度太小？分布式事务一直是业界难题，因为网络的不确定性，而且我们习惯拿分布式事务与单机事务ACID作对比；  </p>
<p>无论是数据库层的XA、还是应用层的TCC、可靠消息、最大努力通知等方案，都没有完美解决分布式事务问题，他们不过是在各自在性能、一致性、可用性等方面作取舍，寻求某些场景偏好下的权衡。  </p>

      
    </div>
    
    
    



<div>
    
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script type="text/javascript" src="http://jslibs.wuxubj.cn/sweetalert_mini/jquery-1.7.1.min.js"></script>
  <script src="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.min.js"></script>
  <link rel="stylesheet" type="text/css" href="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.mini.css">

  <p><span>本文标题:</span>微服务架构的分布式事务控制解决方案</a></p>
  <p><span>文章作者:</span>Fsn</a></p>
  <p><span>发布时间:</span>2020年04月20日 - 05:51:43</p>
  <p><span>最后更新:</span>2020年04月22日 - 08:41:35</p>
  <p><span>原始链接:</span><a href="/2020/04/20/%E9%9D%A2%E8%AF%95/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" title="微服务架构的分布式事务控制解决方案">https://fengshana.github.io/2020/04/20/%E9%9D%A2%E8%AF%95/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://fengshana.github.io/2020/04/20/%E9%9D%A2%E8%AF%95/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    clipboard.on('success', $(function(){
      $(".fa-clipboard").click(function(){
        swal({   
          title: "",   
          text: '复制成功',   
          html: false,
          timer: 500,   
          showConfirmButton: false
        });
      });
    }));  
</script>


    
</div>



    








<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
  
</div>












    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatreward.png" alt="Fsn 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipayreward.png" alt="Fsn 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    










    <footer class="post-footer">
      
        <div class="post-tags" style="text-align:center">
          
            <a href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag"><i class="fa fa-tag">笔记</i></a>
          
            <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"><i class="fa fa-tag">微服务</i></a>
          
            <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="fa fa-tag">分布式</i></a>
          
            <a href="/tags/%E4%BA%8B%E5%8A%A1/" rel="tag"><i class="fa fa-tag">事务</i></a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/04/18/LeetCode/%E6%95%B4%E6%95%B0%E5%8F%8D%E8%BD%AC/" rel="next" title="整数反转">
                <i class="fa fa-chevron-left"></i> 整数反转
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/04/20/%E9%9D%A2%E8%AF%95/Git%E5%B7%A5%E4%BD%9C%E6%B5%81%E5%AD%A6%E4%B9%A0/" rel="prev" title="Git工作流学习笔记">
                Git工作流学习笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80ODk3My8yNTQ2Nw=="></div>
    </div>

  
  
  

  
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/fsn.jpg"
                alt="Fsn" />
            
              <p class="site-author-name" itemprop="name">Fsn</p>
              <p class="site-description motion-element" itemprop="description">勿忘初心，方得始终</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <!--<a href="/archives/%7C%7Carchive">-->
                <a href="/archives/">
              
                  <span class="site-state-item-count">143</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">73</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/fengshana" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#技术专题：分布式事务专题"><span class="nav-number">1.</span> <span class="nav-text">技术专题：分布式事务专题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是事务"><span class="nav-number">1.1.</span> <span class="nav-text">什么是事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#本地事务"><span class="nav-number">1.2.</span> <span class="nav-text">本地事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式事务"><span class="nav-number">1.3.</span> <span class="nav-text">分布式事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式事务产生的场景"><span class="nav-number">1.4.</span> <span class="nav-text">分布式事务产生的场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式事务基础理论"><span class="nav-number">2.</span> <span class="nav-text">分布式事务基础理论</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CAP理论"><span class="nav-number">2.1.</span> <span class="nav-text">CAP理论</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#理解CAP"><span class="nav-number">2.1.1.</span> <span class="nav-text">理解CAP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CAP组合方式"><span class="nav-number">2.1.2.</span> <span class="nav-text">CAP组合方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#总结"><span class="nav-number">2.1.3.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BASE理论"><span class="nav-number">2.2.</span> <span class="nav-text">BASE理论</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式事务解决方案之2PC（两阶段提交）"><span class="nav-number">3.</span> <span class="nav-text">分布式事务解决方案之2PC（两阶段提交）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是2PC"><span class="nav-number">3.1.</span> <span class="nav-text">什么是2PC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解决方案"><span class="nav-number">3.2.</span> <span class="nav-text">解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#XA方案"><span class="nav-number">3.2.1.</span> <span class="nav-text">XA方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Seata方案"><span class="nav-number">3.2.2.</span> <span class="nav-text">Seata方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Seata实现2PC事务"><span class="nav-number">3.3.</span> <span class="nav-text">Seata实现2PC事务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#业务说明"><span class="nav-number">3.3.1.</span> <span class="nav-text">业务说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#本示例程序组成部分如下"><span class="nav-number">3.3.2.</span> <span class="nav-text">本示例程序组成部分如下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建数据库"><span class="nav-number">3.3.3.</span> <span class="nav-text">创建数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动TC事务协调器"><span class="nav-number">3.3.4.</span> <span class="nav-text">启动TC事务协调器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#discover-server"><span class="nav-number">3.3.5.</span> <span class="nav-text">discover-server</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#导入案例工程dtx-seata-demo"><span class="nav-number">3.3.6.</span> <span class="nav-text">导入案例工程dtx-seata-demo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动TC事务协调器-1"><span class="nav-number">3.3.7.</span> <span class="nav-text">启动TC事务协调器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Seata执行流程"><span class="nav-number">3.3.8.</span> <span class="nav-text">Seata执行流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dtx-seata-demo-bank1"><span class="nav-number">3.3.9.</span> <span class="nav-text">dtx-seata-demo-bank1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dtx-seata-demo-bank2"><span class="nav-number">3.3.10.</span> <span class="nav-text">dtx-seata-demo-bank2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试环境"><span class="nav-number">3.3.11.</span> <span class="nav-text">测试环境</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结"><span class="nav-number">3.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式事务解决方案之TCC"><span class="nav-number">4.</span> <span class="nav-text">分布式事务解决方案之TCC</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是TCC事务"><span class="nav-number">4.1.</span> <span class="nav-text">什么是TCC事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCC解决方案"><span class="nav-number">4.2.</span> <span class="nav-text">TCC解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hmily实现TCC事务"><span class="nav-number">4.3.</span> <span class="nav-text">Hmily实现TCC事务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#业务说明-1"><span class="nav-number">4.3.1.</span> <span class="nav-text">业务说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#程序组成部分"><span class="nav-number">4.3.2.</span> <span class="nav-text">程序组成部分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建数据库-1"><span class="nav-number">4.3.3.</span> <span class="nav-text">创建数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#discover-server-1"><span class="nav-number">4.3.4.</span> <span class="nav-text">discover-server</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#导入案例工程dtx-tcc-demo"><span class="nav-number">4.3.5.</span> <span class="nav-text">导入案例工程dtx-tcc-demo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dtx-tcc-demo-bank1"><span class="nav-number">4.3.6.</span> <span class="nav-text">dtx-tcc-demo-bank1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dtx-tcc-demo-bank2"><span class="nav-number">4.3.7.</span> <span class="nav-text">dtx-tcc-demo-bank2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试场景"><span class="nav-number">4.3.8.</span> <span class="nav-text">测试场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结-1"><span class="nav-number">4.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式事务解决方案之可靠消息最终一致性"><span class="nav-number">5.</span> <span class="nav-text">分布式事务解决方案之可靠消息最终一致性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是可靠消息最终一致性事务"><span class="nav-number">5.1.</span> <span class="nav-text">什么是可靠消息最终一致性事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解决方案-1"><span class="nav-number">5.2.</span> <span class="nav-text">解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#本地消息表方案"><span class="nav-number">5.2.1.</span> <span class="nav-text">本地消息表方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RocketMQ事务消息方案"><span class="nav-number">5.2.2.</span> <span class="nav-text">RocketMQ事务消息方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RocketMQ实现可靠消息最终一致性事务"><span class="nav-number">5.3.</span> <span class="nav-text">RocketMQ实现可靠消息最终一致性事务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#业务说明-2"><span class="nav-number">5.3.1.</span> <span class="nav-text">业务说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#程序组成部分-1"><span class="nav-number">5.3.2.</span> <span class="nav-text">程序组成部分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建数据库-2"><span class="nav-number">5.3.3.</span> <span class="nav-text">创建数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动RocketMQ"><span class="nav-number">5.3.4.</span> <span class="nav-text">启动RocketMQ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#导入dtx-txmsg-demo"><span class="nav-number">5.3.5.</span> <span class="nav-text">导入dtx-txmsg-demo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dtx-txmsg-demo-bank1"><span class="nav-number">5.3.6.</span> <span class="nav-text">dtx-txmsg-demo-bank1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dtx-txmsg-demo-bank2"><span class="nav-number">5.3.7.</span> <span class="nav-text">dtx-txmsg-demo-bank2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试场景-1"><span class="nav-number">5.3.8.</span> <span class="nav-text">测试场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结-2"><span class="nav-number">5.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式解决方案之最大努力通知"><span class="nav-number">6.</span> <span class="nav-text">分布式解决方案之最大努力通知</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是最大努力通知"><span class="nav-number">6.1.</span> <span class="nav-text">什么是最大努力通知</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解决方案-2"><span class="nav-number">6.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RocketMQ实现最大努力通知型事务"><span class="nav-number">6.3.</span> <span class="nav-text">RocketMQ实现最大努力通知型事务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#业务说明-3"><span class="nav-number">6.3.1.</span> <span class="nav-text">业务说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#程序组成部分-2"><span class="nav-number">6.3.2.</span> <span class="nav-text">程序组成部分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建数据库-3"><span class="nav-number">6.3.3.</span> <span class="nav-text">创建数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动RocketMQ-1"><span class="nav-number">6.3.4.</span> <span class="nav-text">启动RocketMQ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#导入dtx-notifymsg-demo"><span class="nav-number">6.3.5.</span> <span class="nav-text">导入dtx-notifymsg-demo</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dtx-notifydemo-pay"><span class="nav-number">6.3.6.</span> <span class="nav-text">dtx-notifydemo-pay</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dtx-notifydemo-bank1"><span class="nav-number">6.3.7.</span> <span class="nav-text">dtx-notifydemo-bank1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试场景-2"><span class="nav-number">6.3.8.</span> <span class="nav-text">测试场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结-3"><span class="nav-number">6.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分布式事务综合案例"><span class="nav-number">7.</span> <span class="nav-text">分布式事务综合案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#系统介绍"><span class="nav-number">7.1.</span> <span class="nav-text">系统介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#P2P介绍"><span class="nav-number">7.1.1.</span> <span class="nav-text">P2P介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#总体业务流程"><span class="nav-number">7.1.2.</span> <span class="nav-text">总体业务流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#业务术语"><span class="nav-number">7.1.3.</span> <span class="nav-text">业务术语</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#模块说明"><span class="nav-number">7.1.4.</span> <span class="nav-text">模块说明</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注册账号案例分析"><span class="nav-number">7.2.</span> <span class="nav-text">注册账号案例分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#业务流程"><span class="nav-number">7.2.1.</span> <span class="nav-text">业务流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解决方案分析"><span class="nav-number">7.2.2.</span> <span class="nav-text">解决方案分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#存管开户"><span class="nav-number">7.3.</span> <span class="nav-text">存管开户</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#业务流程-1"><span class="nav-number">7.3.1.</span> <span class="nav-text">业务流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解决方案分析-1"><span class="nav-number">7.3.2.</span> <span class="nav-text">解决方案分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#满标审核"><span class="nav-number">7.4.</span> <span class="nav-text">满标审核</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#业务流程-2"><span class="nav-number">7.4.1.</span> <span class="nav-text">业务流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解决方案分析-2"><span class="nav-number">7.4.2.</span> <span class="nav-text">解决方案分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#课程总结"><span class="nav-number">8.</span> <span class="nav-text">课程总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      


      
<script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script>
<script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script>
<div class="widget-wrap">
    <div id="myCanvasContainer" class="widget tagcloud">
        <canvas width="300" height="300" id="resCanvas" style="width=100%; background-color:transparent;">
            <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ArrayList/" rel="tag">ArrayList</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/B-%E6%A0%91/" rel="tag">B+树</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/B%E6%A0%91/" rel="tag">B树</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CORS/" rel="tag">CORS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git%E5%B7%A5%E4%BD%9C%E6%B5%81/" rel="tag">Git工作流</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HASH%E8%A1%A8/" rel="tag">HASH表</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HashMap/" rel="tag">HashMap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM%E8%99%9A%E6%8B%9F%E6%9C%BA/" rel="tag">JVM虚拟机</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LeetCode/" rel="tag">LeetCode</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySql/" rel="tag">MySql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySql%E7%B4%A2%E5%BC%95/" rel="tag">MySql索引</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oracle/" rel="tag">Oracle</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PayPal/" rel="tag">PayPal</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ/" rel="tag">RabbitMQ</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RabbitMQ%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/" rel="tag">RabbitMQ实战指南</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/" rel="tag">Redis设计与实现</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SendGrid/" rel="tag">SendGrid</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sql/" rel="tag">Sql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vuejs/" rel="tag">Vuejs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javaScript/" rel="tag">javaScript</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/motto/" rel="tag">motto</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oss/" rel="tag">oss</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springboot/" rel="tag">springboot</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tomcat/" rel="tag">tomcat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%B2/" rel="tag">串</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8B%E5%8A%A1/" rel="tag">事务</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" rel="tag">二叉树</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BF%A1666/" rel="tag">信666</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BF%A1666%E5%B7%A5%E4%BD%9C%E4%BA%A4%E6%8E%A5/" rel="tag">信666工作交接</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag">分布式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E9%A1%B5/" rel="tag">分页</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">前端面试题</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%8C%E8%89%B2%E7%90%83/" rel="tag">双色球</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%A3%E8%AF%AD/" rel="tag">口语</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9B%BE/" rel="tag">图</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B/" rel="tag">存储过程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E4%BF%A1/" rel="tag">微信</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7/" rel="tag">微信公众号</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag">微服务</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BF%83%E6%80%81/" rel="tag">心态</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BF%83%E6%80%81%E8%AF%BE%E7%A8%8B/" rel="tag">心态课程</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BF%83%E6%83%85/" rel="tag">心情</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8E%92%E5%BA%8F/" rel="tag">排序</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">操作系统</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%94%AF%E4%BB%98/" rel="tag">支付</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96/" rel="tag">数据库优化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9F%A5%E6%89%BE/" rel="tag">查找</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%88%E4%B8%8E%E9%98%9F%E5%88%97/" rel="tag">栈与队列</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%91/" rel="tag">树</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%90%86%E8%A7%A3%E5%88%86%E6%9E%90/" rel="tag">理解分析</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%90%86%E8%B4%A2/" rel="tag">理财</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%90%86%E8%B4%A2%E5%AD%A6%E4%B9%A0/" rel="tag">理财学习</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%9B%B4%E6%92%AD/" rel="tag">直播</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A4%BE%E4%BC%9A%E4%B8%BB%E4%B9%89%E6%8E%A5%E7%8F%AD%E4%BA%BA/" rel="tag">社会主义接班人</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/" rel="tag">红黑树</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E6%80%A7%E8%A1%A8/" rel="tag">线性表</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%93%E5%AD%98/" rel="tag">缓存</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%8B%B1%E8%AF%AD/" rel="tag">英语</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1/" rel="tag">邮件服务</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%94%81/" rel="tag">锁</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A2%86%E8%B5%AB/" rel="tag">领赫</a><span class="tag-list-count">11</span></li></ul>
        </canvas>
    </div>
</div>



    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2019 &mdash; 

<span itemprop="copyrightYear">2020</span>
  <span class="with-love">
  <!--user-->
    <i class="fa fa-heart"></i>
  </span>
 
 <span class="author" itemprop="copyrightHolder">Fsn</span>

  





  <script async src="http://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
 
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
	<span title="Site words total count">
     460.2k字 </span>
    <!--<span title="symbols_count_time.count_total">881k</span>-->
  
</div>



  <!-- <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>-->






<!--



 -->
 






        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-beta.2/lazyload.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  













  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  
  <script type="text/javascript" src="/js/src/exturl.js?v=5.1.4"></script>


  
  
  
  <!-- 
  
  -->
  <link rel="stylesheet" href="/dist/APlayer.min.css">
<div id="aplayer"></div>
<script type="text/javascript" src="/dist/APlayer.min.js"></script>
<script type="text/javascript" src="/dist/music.js"></script>


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":250,"vOffset":-10},"mobile":{"show":false},"log":false,"tagMode":false});</script></body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>

<!--崩溃欺骗 <script type="text/javascript" src="/js/src/crash_cheat.js"></script> -->




